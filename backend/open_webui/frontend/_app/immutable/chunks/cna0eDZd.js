var Zf=Object.defineProperty;var la=e=>{throw TypeError(e)};var Jf=(e,t,n)=>t in e?Zf(e,t,{enumerable:!0,configurable:!0,writable:!0,value:n}):e[t]=n;var x=(e,t,n)=>Jf(e,typeof t!="symbol"?t+"":t,n),fa=(e,t,n)=>t.has(e)||la("Cannot "+n);var da=(e,t,n)=>(fa(e,t,"read from private field"),n?n.call(e):t.get(e)),pa=(e,t,n)=>t.has(e)?la("Cannot add the same private member more than once"):t instanceof WeakSet?t.add(e):t.set(e,n),zr=(e,t,n,i)=>(fa(e,t,"write to private field"),i?i.call(e,n):t.set(e,n),n);import{hasOwnProperty as Z,isNumber as G,isString as T,writeConfig as _c,splitAccessPath as zn,stringValue as R,isObject as L,mergeConfig as Cc,isArray as _,array as J,logger as ed,Warn as td,isBoolean as ni,parseSelector as In,identity as nd,parseExpression as id,isFunction as rd}from"./CAolLH0J.js";var sd="6.4.1",od={version:sd};function Es(e){return $(e,"or")}function ks(e){return $(e,"and")}function _s(e){return $(e,"not")}function Ni(e,t){if(_s(e))Ni(e.not,t);else if(ks(e))for(const n of e.and)Ni(n,t);else if(Es(e))for(const n of e.or)Ni(n,t);else t(e)}function mn(e,t){return _s(e)?{not:mn(e.not,t)}:ks(e)?{and:e.and.map(n=>mn(n,t))}:Es(e)?{or:e.or.map(n=>mn(n,t))}:t(e)}const N=structuredClone;function ad(e){throw new Error(e)}function Yn(e,t){const n={};for(const i of t)Z(e,i)&&(n[i]=e[i]);return n}function Fe(e,t){const n={...e};for(const i of t)delete n[i];return n}Set.prototype.toJSON=function(){return`Set(${[...this].map(e=>D(e)).join(",")})`};function I(e){if(G(e))return e;const t=T(e)?e:D(e);if(t.length<250)return t;let n=0;for(let i=0;i<t.length;i++){const r=t.charCodeAt(i);n=(n<<5)-n+r,n=n&n}return n}function ga(e){return e===!1||e===null}function z(e,t){return e.includes(t)}function Kn(e,t){let n=0;for(const[i,r]of e.entries())if(t(r,i,n++))return!0;return!1}function Fc(e,t){let n=0;for(const[i,r]of e.entries())if(!t(r,i,n++))return!1;return!0}function cd(e,...t){for(const n of t)ud(e,n??{});return e}function ud(e,t){for(const n of b(t))_c(e,n,t[n],!0)}function ut(e,t){const n=[],i={};let r;for(const s of e)r=t(s),!(r in i)&&(i[r]=1,n.push(s));return n}function qS(e,t){const n=b(e),i=b(t);if(n.length!==i.length)return!1;for(const r of n)if(e[r]!==t[r])return!1;return!0}function ld(e,t){if(e.size!==t.size)return!1;for(const n of e)if(!t.has(n))return!1;return!0}function Nc(e,t){for(const n of e)if(t.has(n))return!0;return!1}function ha(e){const t=new Set;for(const n of e){const r=zn(n).map((o,a)=>a===0?o:`[${o}]`),s=r.map((o,a)=>r.slice(0,a+1).join(""));for(const o of s)t.add(o)}return t}function Tc(e,t){return e===void 0||t===void 0?!0:Nc(ha(e),ha(t))}function W(e){return b(e).length===0}const b=Object.keys,ie=Object.values,Vt=Object.entries;function Ai(e){return e===!0||e===!1}function K(e){const t=e.replace(/\W/g,"_");return(e.match(/^\d+/)?"_":"")+t}function Ti(e,t){return _s(e)?`!(${Ti(e.not,t)})`:ks(e)?`(${e.and.map(n=>Ti(n,t)).join(") && (")})`:Es(e)?`(${e.or.map(n=>Ti(n,t)).join(") || (")})`:t(e)}function Qr(e,t){if(t.length===0)return!0;const n=t.shift();return n in e&&Qr(e[n],t)&&delete e[n],W(e)}function Vi(e){return e.charAt(0).toUpperCase()+e.substr(1)}function Oc(e,t="datum"){const n=zn(e),i=[];for(let r=1;r<=n.length;r++){const s=`[${n.slice(0,r).map(R).join("][")}]`;i.push(`${t}${s}`)}return i.join(" && ")}function fd(e,t="datum"){return`${t}[${R(zn(e).join("."))}]`}function U(e){return`datum['${e.replaceAll("'","\\'")}']`}function dd(e){return e.replaceAll("\\'","'").replaceAll("\\.",".")}function pd(e){return e.replace(/(\[|\]|\.|'|")/g,"\\$1")}function Ie(e){return`${zn(e).map(pd).join("\\.")}`}function vn(e,t,n){return e.replace(new RegExp(t.replace(/[-/\\^$*+?.()|[\]{}]/g,"\\$&"),"g"),n)}function ii(e){return`${zn(e).join(".")}`}function Qn(e){return e?zn(e).length:0}function te(...e){return e.find(t=>t!==void 0)}let Ac=42;function gd(e){const t=++Ac;return e?String(e)+t:t}function GS(){Ac=42}function hd(e){return md(e)?e:`__${e}`}function md(e){return e.startsWith("__")}function Pi(e){if(e!==void 0)return(e%360+360)%360}function Cs(e){return G(e)?!0:!isNaN(e)&&!isNaN(parseFloat(e))}const ma=Object.getPrototypeOf(structuredClone({}));function _e(e,t){if(e===t)return!0;if(e&&t&&typeof e=="object"&&typeof t=="object"){if(e.constructor.name!==t.constructor.name)return!1;let n,i;if(Array.isArray(e)){if(n=e.length,n!=t.length)return!1;for(i=n;i--!==0;)if(!_e(e[i],t[i]))return!1;return!0}if(e instanceof Map&&t instanceof Map){if(e.size!==t.size)return!1;for(const s of e.entries())if(!t.has(s[0]))return!1;for(const s of e.entries())if(!_e(s[1],t.get(s[0])))return!1;return!0}if(e instanceof Set&&t instanceof Set){if(e.size!==t.size)return!1;for(const s of e.entries())if(!t.has(s[0]))return!1;return!0}if(ArrayBuffer.isView(e)&&ArrayBuffer.isView(t)){if(n=e.length,n!=t.length)return!1;for(i=n;i--!==0;)if(e[i]!==t[i])return!1;return!0}if(e.constructor===RegExp)return e.source===t.source&&e.flags===t.flags;if(e.valueOf!==Object.prototype.valueOf&&e.valueOf!==ma.valueOf)return e.valueOf()===t.valueOf();if(e.toString!==Object.prototype.toString&&e.toString!==ma.toString)return e.toString()===t.toString();const r=Object.keys(e);if(n=r.length,n!==Object.keys(t).length)return!1;for(i=n;i--!==0;)if(!Object.prototype.hasOwnProperty.call(t,r[i]))return!1;for(i=n;i--!==0;){const s=r[i];if(!_e(e[s],t[s]))return!1}return!0}return e!==e&&t!==t}function D(e){const t=[];return function n(i){if(i!=null&&i.toJSON&&typeof i.toJSON=="function"&&(i=i.toJSON()),i===void 0)return;if(typeof i=="number")return isFinite(i)?`${i}`:"null";if(typeof i!="object")return JSON.stringify(i);let r,s;if(Array.isArray(i)){for(s="[",r=0;r<i.length;r++)r&&(s+=","),s+=n(i[r])||"null";return`${s}]`}if(i===null)return"null";if(t.includes(i))throw new TypeError("Converting circular structure to JSON");const o=t.push(i)-1,a=Object.keys(i).sort();for(s="",r=0;r<a.length;r++){const c=a[r],u=n(i[c]);u&&(s&&(s+=","),s+=`${JSON.stringify(c)}:${u}`)}return t.splice(o,1),`{${s}}`}(e)}function $(e,t){return L(e)&&Z(e,t)&&e[t]!==void 0}const ft="row",dt="column",Xi="facet",V="x",ae="y",Ue="x2",tt="y2",Rt="xOffset",Ln="yOffset",Be="radius",bt="radius2",Te="theta",St="theta2",We="latitude",He="longitude",qe="latitude2",Ne="longitude2",zt="time",xe="color",nt="fill",it="stroke",be="shape",$t="size",rn="angle",vt="opacity",It="fillOpacity",Lt="strokeOpacity",Mt="strokeWidth",Dt="strokeDash",ri="text",wn="order",si="detail",Yi="key",Xt="tooltip",Ki="href",Qi="url",Zi="description",yd={x:1,y:1,x2:1,y2:1},Pc={theta:1,theta2:1,radius:1,radius2:1};function Rc(e){return Z(Pc,e)}const Fs={longitude:1,longitude2:1,latitude:1,latitude2:1};function zc(e){switch(e){case We:return"y";case qe:return"y2";case He:return"x";case Ne:return"x2"}}function Ic(e){return Z(Fs,e)}const xd=b(Fs),Ns={...yd,...Pc,...Fs,xOffset:1,yOffset:1,color:1,fill:1,stroke:1,time:1,opacity:1,fillOpacity:1,strokeOpacity:1,strokeWidth:1,strokeDash:1,size:1,angle:1,shape:1,order:1,text:1,detail:1,key:1,tooltip:1,href:1,url:1,description:1};function yn(e){return e===xe||e===nt||e===it}const Lc={row:1,column:1,facet:1},Ce=b(Lc),Ts={...Ns,...Lc},bd=b(Ts),{order:VS,detail:XS,tooltip:YS,...Sd}=Ts,{row:KS,column:QS,facet:ZS,...$d}=Sd;function vd(e){return Z($d,e)}function Mc(e){return Z(Ts,e)}const wd=[Ue,tt,qe,Ne,St,bt];function Dc(e){return sn(e)!==e}function sn(e){switch(e){case Ue:return V;case tt:return ae;case qe:return We;case Ne:return He;case St:return Te;case bt:return Be}return e}function Tt(e){if(Rc(e))switch(e){case Te:return"startAngle";case St:return"endAngle";case Be:return"outerRadius";case bt:return"innerRadius"}return e}function rt(e){switch(e){case V:return Ue;case ae:return tt;case We:return qe;case He:return Ne;case Te:return St;case Be:return bt}}function Se(e){switch(e){case V:case Ue:return"width";case ae:case tt:return"height"}}function jc(e){switch(e){case V:return"xOffset";case ae:return"yOffset";case Ue:return"x2Offset";case tt:return"y2Offset";case Te:return"thetaOffset";case Be:return"radiusOffset";case St:return"theta2Offset";case bt:return"radius2Offset"}}function Os(e){switch(e){case V:return"xOffset";case ae:return"yOffset"}}function Ed(e){switch(e){case"xOffset":return"x";case"yOffset":return"y"}}const kd=b(Ns),{x:JS,y:e$,x2:t$,y2:n$,xOffset:i$,yOffset:r$,latitude:s$,longitude:o$,latitude2:a$,longitude2:c$,theta:u$,theta2:l$,radius:f$,radius2:d$,...As}=Ns,_d=b(As),Ps={x:1,y:1},wt=b(Ps);function ee(e){return Z(Ps,e)}const Rs={theta:1,radius:1},Cd=b(Rs);function Ji(e){return e==="width"?V:ae}const Uc={xOffset:1,yOffset:1};function oi(e){return Z(Uc,e)}const Fd={time:1};function Ir(e){return e in Fd}const{text:p$,tooltip:g$,href:h$,url:m$,description:y$,detail:x$,key:b$,order:S$,...Bc}=As,Nd=b(Bc);function Td(e){return Z(As,e)}function Od(e){switch(e){case xe:case nt:case it:case $t:case be:case vt:case Mt:case Dt:return!0;case It:case Lt:case rn:case zt:return!1}}const Wc={...Ps,...Rs,...Uc,...Bc},zs=b(Wc);function st(e){return Z(Wc,e)}function Ad(e,t){return Rd(e)[t]}const Hc={arc:"always",area:"always",bar:"always",circle:"always",geoshape:"always",image:"always",line:"always",rule:"always",point:"always",rect:"always",square:"always",trail:"always",text:"always",tick:"always"},{geoshape:$$,...Pd}=Hc;function Rd(e){switch(e){case xe:case nt:case it:case Zi:case si:case Yi:case Xt:case Ki:case wn:case vt:case It:case Lt:case Mt:case Xi:case ft:case dt:return Hc;case V:case ae:case Rt:case Ln:case We:case He:case zt:return Pd;case Ue:case tt:case qe:case Ne:return{area:"always",bar:"always",image:"always",rect:"always",rule:"always",circle:"binned",point:"binned",square:"binned",tick:"binned",line:"binned",trail:"binned"};case $t:return{point:"always",tick:"always",rule:"always",circle:"always",square:"always",bar:"always",text:"always",line:"always",trail:"always"};case Dt:return{line:"always",point:"always",tick:"always",rule:"always",circle:"always",square:"always",bar:"always",geoshape:"always"};case be:return{point:"always",geoshape:"always"};case ri:return{text:"always"};case rn:return{point:"always",square:"always",text:"always"};case Qi:return{image:"always"};case Te:return{text:"always",arc:"always"};case Be:return{text:"always",arc:"always"};case St:case bt:return{arc:"always"}}}function Lr(e){switch(e){case V:case ae:case Te:case Be:case Rt:case Ln:case $t:case rn:case Mt:case vt:case It:case Lt:case zt:case Ue:case tt:case St:case bt:return;case Xi:case ft:case dt:case be:case Dt:case ri:case Xt:case Ki:case Qi:case Zi:return"discrete";case xe:case nt:case it:return"flexible";case We:case He:case qe:case Ne:case si:case Yi:case wn:return}}const zd={argmax:1,argmin:1,average:1,count:1,distinct:1,exponential:1,exponentialb:1,product:1,max:1,mean:1,median:1,min:1,missing:1,q1:1,q3:1,ci0:1,ci1:1,stderr:1,stdev:1,stdevp:1,sum:1,valid:1,values:1,variance:1,variancep:1},Id={count:1,min:1,max:1};function mt(e){return $(e,"argmin")}function jt(e){return $(e,"argmax")}function Is(e){return T(e)&&Z(zd,e)}const Ld=new Set(["count","valid","missing","distinct"]);function er(e){return T(e)&&Ld.has(e)}function Md(e){return T(e)&&z(["min","max"],e)}const Dd=new Set(["count","sum","distinct","valid","missing"]),jd=new Set(["mean","average","median","q1","q3","min","max"]);function qc(e){return ni(e)&&(e=dr(e,void 0)),`bin${b(e).map(t=>tr(e[t])?K(`_${t}_${Vt(e[t])}`):K(`_${t}_${e[t]}`)).join("")}`}function H(e){return e===!0||on(e)&&!e.binned}function ce(e){return e==="binned"||on(e)&&e.binned===!0}function on(e){return L(e)}function tr(e){return $(e,"param")}function ya(e){switch(e){case ft:case dt:case $t:case xe:case nt:case it:case Mt:case vt:case It:case Lt:case be:return 6;case Dt:return 4;default:return 10}}function ai(e){return $(e,"expr")}function ue(e,{level:t}={level:0}){const n=b(e||{}),i={};for(const r of n)i[r]=t===0?Ee(e[r]):ue(e[r],{level:t-1});return i}function Gc(e){const{anchor:t,frame:n,offset:i,orient:r,angle:s,limit:o,color:a,subtitleColor:c,subtitleFont:u,subtitleFontSize:l,subtitleFontStyle:f,subtitleFontWeight:d,subtitleLineHeight:p,subtitlePadding:g,...h}=e,m={...h,...a?{fill:a}:{}},y={...t?{anchor:t}:{},...n?{frame:n}:{},...i?{offset:i}:{},...r?{orient:r}:{},...s!==void 0?{angle:s}:{},...o!==void 0?{limit:o}:{}},S={...c?{subtitleColor:c}:{},...u?{subtitleFont:u}:{},...l?{subtitleFontSize:l}:{},...f?{subtitleFontStyle:f}:{},...d?{subtitleFontWeight:d}:{},...p?{subtitleLineHeight:p}:{},...g?{subtitlePadding:g}:{}},k=Yn(e,["align","baseline","dx","dy","limit"]);return{titleMarkConfig:m,subtitleMarkConfig:k,nonMarkTitleProperties:y,subtitle:S}}function Ct(e){return T(e)||_(e)&&T(e[0])}function C(e){return $(e,"signal")}function an(e){return $(e,"step")}function Ud(e){return _(e)?!1:$(e,"fields")&&!$(e,"data")}function Bd(e){return _(e)?!1:$(e,"fields")&&$(e,"data")}function lt(e){return _(e)?!1:$(e,"field")&&$(e,"data")}const Wd={aria:1,description:1,ariaRole:1,ariaRoleDescription:1,blend:1,opacity:1,fill:1,fillOpacity:1,stroke:1,strokeCap:1,strokeWidth:1,strokeOpacity:1,strokeDash:1,strokeDashOffset:1,strokeJoin:1,strokeOffset:1,strokeMiterLimit:1,startAngle:1,endAngle:1,padAngle:1,innerRadius:1,outerRadius:1,size:1,shape:1,interpolate:1,tension:1,orient:1,align:1,baseline:1,text:1,dir:1,dx:1,dy:1,ellipsis:1,limit:1,radius:1,theta:1,angle:1,font:1,fontSize:1,fontWeight:1,fontStyle:1,lineBreak:1,lineHeight:1,cursor:1,href:1,tooltip:1,cornerRadius:1,cornerRadiusTopLeft:1,cornerRadiusTopRight:1,cornerRadiusBottomLeft:1,cornerRadiusBottomRight:1,aspect:1,width:1,height:1,url:1,smooth:1},Hd=b(Wd),qd={arc:1,area:1,group:1,image:1,line:1,path:1,rect:1,rule:1,shape:1,symbol:1,text:1,trail:1},Zr=["cornerRadius","cornerRadiusTopLeft","cornerRadiusTopRight","cornerRadiusBottomLeft","cornerRadiusBottomRight"],Gd=" â€“ ";function Vc(e){const t=_(e.condition)?e.condition.map(xa):xa(e.condition);return{...Ee(e),condition:t}}function Ee(e){if(ai(e)){const{expr:t,...n}=e;return{signal:t,...n}}return e}function xa(e){if(ai(e)){const{expr:t,...n}=e;return{signal:t,...n}}return e}function q(e){if(ai(e)){const{expr:t,...n}=e;return{signal:t,...n}}return C(e)?e:e!==void 0?{value:e}:void 0}function Vd(e){return C(e)?e.signal:R(e)}function ba(e){return C(e)?e.signal:R(e.value)}function Pe(e){return C(e)?e.signal:e==null?null:R(e)}function Xd(e,t,n){for(const i of n){const r=Ze(i,t.markDef,t.config);r!==void 0&&(e[i]=q(r))}return e}function Xc(e){return[].concat(e.type,e.style??[])}function M(e,t,n,i={}){const{vgChannel:r,ignoreVgConfig:s}=i;return r&&$(t,r)?t[r]:t[e]!==void 0?t[e]:s&&(!r||r===e)?void 0:Ze(e,t,n,i)}function Ze(e,t,n,{vgChannel:i}={}){const r=Jr(e,t,n.style);return te(i?r:void 0,r,i?n[t.type][i]:void 0,n[t.type][e],i?n.mark[i]:n.mark[e])}function Jr(e,t,n){return Yc(e,Xc(t),n)}function Yc(e,t,n){t=J(t);let i;for(const r of t){const s=n[r];$(s,e)&&(i=s[e])}return i}function Kc(e,t){return J(e).reduce((n,i)=>(n.field.push(E(i,t)),n.order.push(i.sort??"ascending"),n),{field:[],order:[]})}function Qc(e,t){const n=[...e];return t.forEach(i=>{for(const r of n)if(_e(r,i))return;n.push(i)}),n}function Zc(e,t){return _e(e,t)||!t?e:e?[...J(e),...J(t)].join(", "):t}function Jc(e,t){const n=e.value,i=t.value;if(n==null||i===null)return{explicit:e.explicit,value:null};if((Ct(n)||C(n))&&(Ct(i)||C(i)))return{explicit:e.explicit,value:Zc(n,i)};if(Ct(n)||C(n))return{explicit:e.explicit,value:n};if(Ct(i)||C(i))return{explicit:e.explicit,value:i};if(!Ct(n)&&!C(n)&&!Ct(i)&&!C(i))return{explicit:e.explicit,value:Qc(n,i)};throw new Error("It should never reach here")}function Ls(e){return`Invalid specification ${D(e)}. Make sure the specification includes at least one of the following properties: "mark", "layer", "facet", "hconcat", "vconcat", "concat", or "repeat".`}const Yd='Autosize "fit" only works for single views and layered views.';function Sa(e){return`${e=="width"?"Width":"Height"} "container" only works for single views and layered views.`}function $a(e){const t=e=="width"?"Width":"Height",n=e=="width"?"x":"y";return`${t} "container" only works well with autosize "fit" or "fit-${n}".`}function va(e){return e?`Dropping "fit-${e}" because spec has discrete ${Se(e)}.`:'Dropping "fit" because spec has discrete size.'}function Ms(e){return`Unknown field for ${e}. Cannot calculate view size.`}function wa(e){return`Cannot project a selection on encoding channel "${e}", which has no field.`}function Kd(e,t){return`Cannot project a selection on encoding channel "${e}" as it uses an aggregate function ("${t}").`}function Qd(e){return`The "nearest" transform is not supported for ${e} marks.`}function eu(e){return`Selection not supported for ${e} yet.`}function Zd(e){return`Cannot find a selection named "${e}".`}const Jd="Scale bindings are currently only supported for scales with unbinned, continuous domains.",ep="Sequntial scales are deprecated. The available quantitative scale type values are linear, log, pow, sqrt, symlog, time and utc",tp="Legend bindings are only supported for selections over an individual field or encoding channel.";function np(e){return`Lookups can only be performed on selection parameters. "${e}" is a variable parameter.`}function ip(e){return`Cannot define and lookup the "${e}" selection in the same view. Try moving the lookup into a second, layered view?`}const rp="The same selection must be used to override scale domains in a layered view.",sp='Interval selections should be initialized using "x", "y", "longitude", or "latitude" keys.';function op(e){return`Unknown repeated value "${e}".`}function Ea(e){return`The "columns" property cannot be used when "${e}" has nested row/column.`}const ap="Multiple timer selections in one unit spec are not supported. Ignoring all but the first.",Ds="Animation involving facet, layer, or concat is currently unsupported.";function cp(e){return`A "field" or "encoding" must be specified when using a selection as a scale domain. Using "field": ${R(e)}.`}function up(e,t,n,i){return`${e.length?"Multiple ":"No "}matching ${R(t)} encoding found for selection ${R(n.param)}. Using "field": ${R(i)}.`}const lp="Axes cannot be shared in concatenated or repeated views yet (https://github.com/vega/vega-lite/issues/2415).";function fp(e){return`Unrecognized parse "${e}".`}function ka(e,t,n){return`An ancestor parsed field "${e}" as ${n} but a child wants to parse the field as ${t}.`}const dp="Attempt to add the same child twice.";function pp(e){return`Ignoring an invalid transform: ${D(e)}.`}const gp='If "from.fields" is not specified, "as" has to be a string that specifies the key to be used for the data from the secondary source.';function _a(e){return`Config.customFormatTypes is not true, thus custom format type and format for channel ${e} are dropped.`}function hp(e){const{parentProjection:t,projection:n}=e;return`Layer's shared projection ${D(t)} is overridden by a child projection ${D(n)}.`}const mp="Arc marks uses theta channel rather than angle, replacing angle with theta.";function yp(e){return`${e}Offset dropped because ${e} is continuous`}function xp(e,t,n){return`Channel ${e} is a ${t}. Converted to {value: ${D(n)}}.`}function tu(e){return`Invalid field type "${e}".`}function bp(e,t){return`Invalid field type "${e}" for aggregate: "${t}", using "quantitative" instead.`}function Sp(e){return`Invalid aggregation operator "${e}".`}function nu(e,t){const{fill:n,stroke:i}=t;return`Dropping color ${e} as the plot also has ${n&&i?"fill and stroke":n?"fill":"stroke"}.`}function $p(e){return`Position range does not support relative band size for ${e}.`}function es(e,t){return`Dropping ${D(e)} from channel "${t}" since it does not contain any data field, datum, value, or signal.`}const vp="Line marks cannot encode size with a non-groupby field. You may want to use trail marks instead.";function nr(e,t,n){return`${e} dropped as it is incompatible with "${t}".`}function wp(e){return`${e}-encoding is dropped as ${e} is not a valid encoding channel.`}function Ep(e){return`${e} encoding should be discrete (ordinal / nominal / binned).`}function kp(e){return`${e} encoding should be discrete (ordinal / nominal / binned) or use a discretizing scale (e.g. threshold).`}function _p(e){return`Facet encoding dropped as ${e.join(" and ")} ${e.length>1?"are":"is"} also specified.`}function Mr(e,t){return`Using discrete channel "${e}" to encode "${t}" field can be misleading as it does not encode ${t==="ordinal"?"order":"magnitude"}.`}function Cp(e){return`The ${e} for range marks cannot be an expression`}function Fp(e,t){return`Line mark is for continuous lines and thus cannot be used with ${e&&t?"x2 and y2":e?"x2":"y2"}. We will use the rule mark (line segments) instead.`}function Np(e,t){return`Specified orient "${e}" overridden with "${t}".`}function Tp(e){return`Cannot use the scale property "${e}" with non-color channel.`}function Op(e){return`Cannot use the relative band size with ${e} scale.`}function Ap(e){return`Using unaggregated domain with raw field has no effect (${D(e)}).`}function Pp(e){return`Unaggregated domain not applicable for "${e}" since it produces values outside the origin domain of the source data.`}function Rp(e){return`Unaggregated domain is currently unsupported for log scale (${D(e)}).`}function zp(e){return`Cannot apply size to non-oriented mark "${e}".`}function Ip(e,t,n){return`Channel "${e}" does not work with "${t}" scale. We are using "${n}" scale instead.`}function Lp(e,t){return`FieldDef does not work with "${e}" scale. We are using "${t}" scale instead.`}function iu(e,t,n){return`${n}-scale's "${t}" is dropped as it does not work with ${e} scale.`}function ru(e){return`The step for "${e}" is dropped because the ${e==="width"?"x":"y"} is continuous.`}function Mp(e,t,n,i){return`Conflicting ${t.toString()} property "${e.toString()}" (${D(n)} and ${D(i)}). Using ${D(n)}.`}function Dp(e,t,n,i){return`Conflicting ${t.toString()} property "${e.toString()}" (${D(n)} and ${D(i)}). Using the union of the two domains.`}function jp(e){return`Setting the scale to be independent for "${e}" means we also have to set the guide (axis or legend) to be independent.`}function Up(e){return`Dropping sort property ${D(e)} as unioned domains only support boolean or op "count", "min", and "max".`}const Ca="Domains that should be unioned has conflicting sort properties. Sort will be set to true.",Bp="Detected faceted independent scales that union domain of multiple fields from different data sources. We will use the first field. The result view size may be incorrect.",Wp="Detected faceted independent scales that union domain of the same fields from different source. We will assume that this is the same field from a different fork of the same data source. However, if this is not the case, the result view size may be incorrect.",Hp="Detected faceted independent scales that union domain of multiple fields from the same data source. We will use the first field. The result view size may be incorrect.";function qp(e){return`Cannot stack "${e}" if there is already "${e}2".`}function Gp(e){return`Stack is applied to a non-linear scale (${e}).`}function Vp(e){return`Stacking is applied even though the aggregate function is non-summative ("${e}").`}function Ri(e,t){return`Invalid ${e}: ${D(t)}.`}function Xp(e){return`Dropping day from datetime ${D(e)} as day cannot be combined with other units.`}function Yp(e,t){return`${t?"extent ":""}${t&&e?"and ":""}${e?"center ":""}${t&&e?"are ":"is "}not needed when data are aggregated.`}function Kp(e,t,n){return`${e} is not usually used with ${t} for ${n}.`}function Qp(e,t){return`Continuous axis should not have customized aggregation function ${e}; ${t} already agregates the axis.`}function Fa(e){return`1D error band does not support ${e}.`}function su(e){return`Channel ${e} is required for "binned" bin.`}function Zp(e){return`Channel ${e} should not be used with "binned" bin.`}function Jp(e){return`Domain for ${e} is required for threshold scale.`}const ou=ed(td);let Yt=ou;function eg(e){return Yt=e,Yt}function tg(){return Yt=ou,Yt}function js(...e){Yt.error(...e)}function w(...e){Yt.warn(...e)}function ng(...e){Yt.debug(...e)}function cn(e){if(e&&L(e)){for(const t of Bs)if($(e,t))return!0}return!1}const au=["january","february","march","april","may","june","july","august","september","october","november","december"],ig=au.map(e=>e.substr(0,3)),cu=["sunday","monday","tuesday","wednesday","thursday","friday","saturday"],rg=cu.map(e=>e.substr(0,3));function sg(e){if(Cs(e)&&(e=+e),G(e))return e>4&&w(Ri("quarter",e)),e-1;throw new Error(Ri("quarter",e))}function og(e){if(Cs(e)&&(e=+e),G(e))return e-1;{const t=e.toLowerCase(),n=au.indexOf(t);if(n!==-1)return n;const i=t.substr(0,3),r=ig.indexOf(i);if(r!==-1)return r;throw new Error(Ri("month",e))}}function ag(e){if(Cs(e)&&(e=+e),G(e))return e%7;{const t=e.toLowerCase(),n=cu.indexOf(t);if(n!==-1)return n;const i=t.substr(0,3),r=rg.indexOf(i);if(r!==-1)return r;throw new Error(Ri("day",e))}}function Us(e,t){const n=[];if(t&&e.day!==void 0&&b(e).length>1&&(w(Xp(e)),e=N(e),delete e.day),e.year!==void 0?n.push(e.year):n.push(2012),e.month!==void 0){const i=t?og(e.month):e.month;n.push(i)}else if(e.quarter!==void 0){const i=t?sg(e.quarter):e.quarter;n.push(G(i)?i*3:`${i}*3`)}else n.push(0);if(e.date!==void 0)n.push(e.date);else if(e.day!==void 0){const i=t?ag(e.day):e.day;n.push(G(i)?i+1:`${i}+1`)}else n.push(1);for(const i of["hours","minutes","seconds","milliseconds"]){const r=e[i];n.push(typeof r>"u"?0:r)}return n}function Kt(e){const n=Us(e,!0).join(", ");return e.utc?`utc(${n})`:`datetime(${n})`}function cg(e){const n=Us(e,!1).join(", ");return e.utc?`utc(${n})`:`datetime(${n})`}function ug(e){const t=Us(e,!0);return e.utc?+new Date(Date.UTC(...t)):+new Date(...t)}const uu={year:1,quarter:1,month:1,week:1,day:1,dayofyear:1,date:1,hours:1,minutes:1,seconds:1,milliseconds:1},Bs=b(uu);function lg(e){return Z(uu,e)}function un(e){return L(e)?e.binned:lu(e)}function lu(e){return e==null?void 0:e.startsWith("binned")}function Ws(e){return e.startsWith("utc")}function fg(e){return e.substring(3)}const dg={"year-month":"%b %Y ","year-month-date":"%b %d, %Y "};function ir(e){return Bs.filter(t=>du(e,t))}function fu(e){const t=ir(e);return t[t.length-1]}function du(e,t){const n=e.indexOf(t);return!(n<0||n>0&&t==="seconds"&&e.charAt(n-1)==="i"||e.length>n+3&&t==="day"&&e.charAt(n+3)==="o"||n>0&&t==="year"&&e.charAt(n-1)==="f")}function pg(e,t,{end:n}={end:!1}){const i=Oc(t),r=Ws(e)?"utc":"";function s(c){return c==="quarter"?`(${r}quarter(${i})-1)`:`${r}${c}(${i})`}let o;const a={};for(const c of Bs)du(e,c)&&(a[c]=s(c),o=c);return n&&(a[o]+="+1"),cg(a)}function pu(e){if(!e)return;const t=ir(e);return`timeUnitSpecifier(${D(t)}, ${D(dg)})`}function gg(e,t,n){if(!e)return;const i=pu(e);return`${n||Ws(e)?"utc":"time"}Format(${t}, ${i})`}function se(e){if(!e)return;let t;return T(e)?lu(e)?t={unit:e.substring(6),binned:!0}:t={unit:e}:L(e)&&(t={...e,...e.unit?{unit:e.unit}:{}}),Ws(t.unit)&&(t.utc=!0,t.unit=fg(t.unit)),t}function hg(e){const{utc:t,...n}=se(e);return n.unit?(t?"utc":"")+b(n).map(i=>K(`${i==="unit"?"":`_${i}_`}${n[i]}`)).join(""):`${t?"utc":""}timeunit${b(n).map(i=>K(`_${i}_${n[i]}`)).join("")}`}function gu(e,t=n=>n){const n=se(e),i=fu(n.unit);if(i&&i!=="day"){const r={year:2001,month:1,date:1,hours:0,minutes:0,seconds:0,milliseconds:0},{step:s,part:o}=hu(i,n.step),a={...r,[o]:+r[o]+s};return`${t(Kt(a))} - ${t(Kt(r))}`}}const mg={year:1,month:1,date:1,hours:1,minutes:1,seconds:1,milliseconds:1};function yg(e){return Z(mg,e)}function hu(e,t=1){if(yg(e))return{part:e,step:t};switch(e){case"day":case"dayofyear":return{part:"date",step:t};case"quarter":return{part:"month",step:t*3};case"week":return{part:"date",step:t*7}}}function xg(e){return $(e,"param")}function Hs(e){return!!(e!=null&&e.field)&&e.equal!==void 0}function qs(e){return!!(e!=null&&e.field)&&e.lt!==void 0}function Gs(e){return!!(e!=null&&e.field)&&e.lte!==void 0}function Vs(e){return!!(e!=null&&e.field)&&e.gt!==void 0}function Xs(e){return!!(e!=null&&e.field)&&e.gte!==void 0}function Ys(e){if(e!=null&&e.field){if(_(e.range)&&e.range.length===2)return!0;if(C(e.range))return!0}return!1}function Ks(e){return!!(e!=null&&e.field)&&(_(e.oneOf)||_(e.in))}function bg(e){return!!(e!=null&&e.field)&&e.valid!==void 0}function mu(e){return Ks(e)||Hs(e)||Ys(e)||qs(e)||Vs(e)||Gs(e)||Xs(e)}function Ge(e,t){return pr(e,{timeUnit:t,wrapTime:!0})}function Sg(e,t){return e.map(n=>Ge(n,t))}function yu(e,t=!0){const{field:n}=e,i=se(e.timeUnit),{unit:r,binned:s}=i||{},o=E(e,{expr:"datum"}),a=r?`time(${s?o:pg(r,n)})`:o;if(Hs(e))return`${a}===${Ge(e.equal,r)}`;if(qs(e)){const c=e.lt;return`${a}<${Ge(c,r)}`}else if(Vs(e)){const c=e.gt;return`${a}>${Ge(c,r)}`}else if(Gs(e)){const c=e.lte;return`${a}<=${Ge(c,r)}`}else if(Xs(e)){const c=e.gte;return`${a}>=${Ge(c,r)}`}else{if(Ks(e))return`indexof([${Sg(e.oneOf,r).join(",")}], ${a}) !== -1`;if(bg(e))return rr(a,e.valid);if(Ys(e)){const{range:c}=ue(e),u=C(c)?{signal:`${c.signal}[0]`}:c[0],l=C(c)?{signal:`${c.signal}[1]`}:c[1];if(u!==null&&l!==null&&t)return`inrange(${a}, [${Ge(u,r)}, ${Ge(l,r)}])`;const f=[];return u!==null&&f.push(`${a} >= ${Ge(u,r)}`),l!==null&&f.push(`${a} <= ${Ge(l,r)}`),f.length>0?f.join(" && "):"true"}}throw new Error(`Invalid field predicate: ${D(e)}`)}function rr(e,t=!0){return t?`isValid(${e}) && isFinite(+${e})`:`!isValid(${e}) || !isFinite(+${e})`}function $g(e){return mu(e)&&e.timeUnit?{...e,timeUnit:se(e.timeUnit)}:e}const ci={quantitative:"quantitative",ordinal:"ordinal",temporal:"temporal",nominal:"nominal",geojson:"geojson"};function vg(e){return e==="quantitative"||e==="temporal"}function Qs(e){return e==="ordinal"||e==="nominal"}const Qt=ci.quantitative,Zs=ci.ordinal,En=ci.temporal,Js=ci.nominal,Mn=ci.geojson;function wg(e){if(e)switch(e=e.toLowerCase(),e){case"q":case Qt:return"quantitative";case"t":case En:return"temporal";case"o":case Zs:return"ordinal";case"n":case Js:return"nominal";case Mn:return"geojson"}}const le={LINEAR:"linear",LOG:"log",POW:"pow",SQRT:"sqrt",TIME:"time",UTC:"utc",POINT:"point",BAND:"band"},ts={linear:"numeric",log:"numeric",pow:"numeric",sqrt:"numeric",symlog:"numeric",identity:"numeric",sequential:"numeric",time:"time",utc:"time",ordinal:"ordinal","bin-ordinal":"bin-ordinal",point:"ordinal-position",band:"ordinal-position",quantile:"discretizing",quantize:"discretizing",threshold:"discretizing"};function Eg(e,t){const n=ts[e],i=ts[t];return n===i||n==="ordinal-position"&&i==="time"||i==="ordinal-position"&&n==="time"}const kg={linear:0,log:1,pow:1,sqrt:1,symlog:1,identity:1,sequential:1,time:0,utc:0,point:10,band:11,ordinal:0,"bin-ordinal":0,quantile:0,quantize:0,threshold:0};function Na(e){return kg[e]}const xu=new Set(["linear","log","pow","sqrt","symlog"]),bu=new Set([...xu,"time","utc"]);function Su(e){return xu.has(e)}const $u=new Set(["quantile","quantize","threshold"]),_g=new Set([...bu,...$u,"sequential","identity"]),Cg=new Set(["ordinal","bin-ordinal","point","band"]);function oe(e){return Cg.has(e)}function Le(e){return _g.has(e)}function Xe(e){return bu.has(e)}function kn(e){return $u.has(e)}const Fg={pointPadding:.5,barBandPaddingInner:.1,rectBandPaddingInner:0,tickBandPaddingInner:.25,bandWithNestedOffsetPaddingInner:.2,bandWithNestedOffsetPaddingOuter:.2,minBandSize:2,minFontSize:8,maxFontSize:40,minOpacity:.3,maxOpacity:.8,minSize:4,minStrokeWidth:1,maxStrokeWidth:4,quantileCount:4,quantizeCount:4,zero:!0,framesPerSecond:2,animationDuration:5};function Ng(e){return!T(e)&&$(e,"name")}function vu(e){return $(e,"param")}function Tg(e){return $(e,"unionWith")}function Og(e){return L(e)&&"field"in e}const Ag={type:1,domain:1,domainMax:1,domainMin:1,domainMid:1,domainRaw:1,align:1,range:1,rangeMax:1,rangeMin:1,scheme:1,bins:1,reverse:1,round:1,clamp:1,nice:1,base:1,exponent:1,constant:1,interpolate:1,zero:1,padding:1,paddingInner:1,paddingOuter:1},{type:v$,domain:w$,range:E$,rangeMax:k$,rangeMin:_$,scheme:C$,...Pg}=Ag,Rg=b(Pg);function ns(e,t){switch(t){case"type":case"domain":case"reverse":case"range":return!0;case"scheme":case"interpolate":return!["point","band","identity"].includes(e);case"bins":return!["point","band","identity","ordinal"].includes(e);case"round":return Xe(e)||e==="band"||e==="point";case"padding":case"rangeMin":case"rangeMax":return Xe(e)||["point","band"].includes(e);case"paddingOuter":case"align":return["point","band"].includes(e);case"paddingInner":return e==="band";case"domainMax":case"domainMid":case"domainMin":case"domainRaw":case"clamp":return Xe(e);case"nice":return Xe(e)||e==="quantize"||e==="threshold";case"exponent":return e==="pow";case"base":return e==="log";case"constant":return e==="symlog";case"zero":return Le(e)&&!z(["log","time","utc","threshold","quantile"],e)}}function wu(e,t){switch(t){case"interpolate":case"scheme":case"domainMid":return yn(e)?void 0:Tp(t);case"align":case"type":case"bins":case"domain":case"domainMax":case"domainMin":case"domainRaw":case"range":case"base":case"exponent":case"constant":case"nice":case"padding":case"paddingInner":case"paddingOuter":case"rangeMax":case"rangeMin":case"reverse":case"round":case"clamp":case"zero":return}}function zg(e,t){return z([Zs,Js],t)?e===void 0||oe(e):t===En?z([le.TIME,le.UTC,void 0],e):t===Qt?Su(e)||kn(e)||e===void 0:!0}function Ig(e,t,n=!1){if(!st(e))return!1;switch(e){case V:case ae:case Rt:case Ln:case Te:case Be:return Xe(t)||t==="band"?!0:t==="point"?!n:!1;case zt:return z(["linear","band"],t);case $t:case Mt:case vt:case It:case Lt:case rn:return Xe(t)||kn(t)||z(["band","point","ordinal"],t);case xe:case nt:case it:return t!=="band";case Dt:case be:return t==="ordinal"||kn(t)}}function Lg(e){return L(e)&&"value"in e}const he={arc:"arc",area:"area",bar:"bar",image:"image",line:"line",point:"point",rect:"rect",rule:"rule",text:"text",tick:"tick",trail:"trail",circle:"circle",square:"square",geoshape:"geoshape"},Eu=he.arc,sr=he.area,or=he.bar,Mg=he.image,ar=he.line,cr=he.point,Dg=he.rect,zi=he.rule,ku=he.text,eo=he.tick,jg=he.trail,to=he.circle,no=he.square,_u=he.geoshape;function Ut(e){return["line","area","trail"].includes(e)}function Zn(e){return["rect","bar","image","arc","tick"].includes(e)}const Ug=new Set(b(he));function Je(e){return $(e,"type")}const Bg=["stroke","strokeWidth","strokeDash","strokeDashOffset","strokeOpacity","strokeJoin","strokeMiterLimit"],Wg=["fill","fillOpacity"],Hg=[...Bg,...Wg],qg={color:1,filled:1,invalid:1,order:1,radius2:1,theta2:1,timeUnitBandSize:1,timeUnitBandPosition:1},Ta=b(qg),Dr=["binSpacing","continuousBandSize","discreteBandSize","minBandSize"],Gg={area:["line","point"],bar:Dr,rect:Dr,line:["point"],tick:["bandSize","thickness",...Dr]},Vg={color:"#4c78a8",invalid:"break-paths-show-path-domains",timeUnitBandSize:1},Xg={mark:1,arc:1,area:1,bar:1,circle:1,image:1,line:1,point:1,rect:1,rule:1,square:1,text:1,tick:1,trail:1,geoshape:1},Cu=b(Xg);function Zt(e){return $(e,"band")}const Yg={horizontal:["cornerRadiusTopRight","cornerRadiusBottomRight"],vertical:["cornerRadiusTopLeft","cornerRadiusTopRight"]},Kg=5,io={binSpacing:0,continuousBandSize:Kg,minBandSize:.25,timeUnitBandPosition:.5},Qg={...io,binSpacing:1},Zg={...io,thickness:1};function Jg(e){return Je(e)?e.type:e}function Fu(e,{isPath:t}){return e===void 0||e==="break-paths-show-path-domains"?t?"break-paths-show-domains":"filter":e===null?"show":e}function ro({markDef:e,config:t,scaleChannel:n,scaleType:i,isCountAggregate:r}){var a,c;if(!i||!Le(i)||r)return"always-valid";const s=Fu(M("invalid",e,t),{isPath:Ut(e.type)});return((c=(a=t.scale)==null?void 0:a.invalid)==null?void 0:c[n])!==void 0?"show":s}function eh(e){return e==="break-paths-filter-domains"||e==="break-paths-show-domains"}function Nu({scaleName:e,scale:t,mode:n}){const i=`domain('${e}')`;if(!t||!e)return;const r=`${i}[0]`,s=`peek(${i})`,o=t.domainHasZero();return o==="definitely"?{scale:e,value:0}:o==="maybe"?{signal:`scale('${e}', inrange(0, ${i}) ? 0 : ${n==="zeroOrMin"?r:s})`}:{signal:`scale('${e}', ${n==="zeroOrMin"?r:s})`}}function Tu({scaleChannel:e,channelDef:t,scale:n,scaleName:i,markDef:r,config:s}){var l;const o=n==null?void 0:n.get("type"),a=De(t),c=er(a==null?void 0:a.aggregate),u=ro({scaleChannel:e,markDef:r,config:s,scaleType:o,isCountAggregate:c});if(a&&u==="show"){const f=((l=s.scale.invalid)==null?void 0:l[e])??"zero-or-min";return{test:rr(E(a,{expr:"datum"}),!1),...th(f,n,i)}}}function th(e,t,n){if(Lg(e)){const{value:i}=e;return C(i)?{signal:i.signal}:{value:i}}return Nu({scale:t,scaleName:n,mode:"zeroOrMin"})}function so(e){const{channel:t,channelDef:n,markDef:i,scale:r,scaleName:s,config:o}=e,a=sn(t),c=oo(e),u=Tu({scaleChannel:a,channelDef:n,scale:r,scaleName:s,markDef:i,config:o});return u!==void 0?[u,c]:c}function nh(e){const{datum:t}=e;return cn(t)?Kt(t):`${D(t)}`}function Wt(e,t,n,i){const r={};if(t&&(r.scale=t),ot(e)){const{datum:s}=e;cn(s)?r.signal=Kt(s):C(s)?r.signal=s.signal:ai(s)?r.signal=s.expr:r.value=s}else r.field=E(e,n);if(i){const{offset:s,band:o}=i;s&&(r.offset=s),o&&(r.band=o)}return r}function Ii({scaleName:e,fieldOrDatumDef:t,fieldOrDatumDef2:n,offset:i,startSuffix:r,endSuffix:s="end",bandPosition:o=.5}){const a=!C(o)&&0<o&&o<1?"datum":void 0,c=E(t,{expr:a,suffix:r}),u=n!==void 0?E(n,{expr:a}):E(t,{suffix:s,expr:a}),l={};if(o===0||o===1){l.scale=e;const f=o===0?c:u;l.field=f}else{const f=C(o)?`(1-${o.signal}) * ${c} + ${o.signal} * ${u}`:`${1-o} * ${c} + ${o} * ${u}`;l.signal=`scale("${e}", ${f})`}return i&&(l.offset=i),l}function ih({scaleName:e,fieldDef:t}){const n=E(t,{expr:"datum"}),i=E(t,{expr:"datum",suffix:"end"});return`abs(scale("${e}", ${i}) - scale("${e}", ${n}))`}function oo({channel:e,channelDef:t,channel2Def:n,markDef:i,config:r,scaleName:s,scale:o,stack:a,offset:c,defaultRef:u,bandPosition:l}){if(t){if(O(t)){const f=o==null?void 0:o.get("type");if(ge(t)){l??(l=Ot({fieldDef:t,fieldDef2:n,markDef:i,config:r}));const{bin:d,timeUnit:p,type:g}=t;if(H(d)||l&&p&&g===En)return a!=null&&a.impute?Wt(t,s,{binSuffix:"mid"},{offset:c}):l&&!oe(f)?Ii({scaleName:s,fieldOrDatumDef:t,bandPosition:l,offset:c}):Wt(t,s,pi(t,e)?{binSuffix:"range"}:{},{offset:c});if(ce(d)){if(v(n))return Ii({scaleName:s,fieldOrDatumDef:t,fieldOrDatumDef2:n,bandPosition:l,offset:c});w(su(e===V?Ue:tt))}}return Wt(t,s,oe(f)?{binSuffix:"range"}:{},{offset:c,band:f==="band"?l??t.bandPosition??.5:void 0})}else if(Me(t)){const f=t.value,d=c?{offset:c}:{};return{...Vn(e,f),...d}}}return rd(u)&&(u=u()),u&&{...u,...c?{offset:c}:{}}}function Vn(e,t){return z(["x","x2"],e)&&t==="width"?{field:{group:"width"}}:z(["y","y2"],e)&&t==="height"?{field:{group:"height"}}:q(t)}function Jt(e){return e&&e!=="number"&&e!=="time"}function Ou(e,t,n){return`${e}(${t}${n?`, ${D(n)}`:""})`}function ao({fieldOrDatumDef:e,format:t,formatType:n,expr:i,normalizeStack:r,config:s}){var u;if(Jt(n))return Re({fieldOrDatumDef:e,format:t,formatType:n,expr:i,config:s});const o=Au(e,i,r),a=_n(e);if(t===void 0&&n===void 0&&s.customFormatTypes){if(a==="quantitative"){if(r&&s.normalizedNumberFormatType)return Re({fieldOrDatumDef:e,format:s.normalizedNumberFormat,formatType:s.normalizedNumberFormatType,expr:i,config:s});if(s.numberFormatType)return Re({fieldOrDatumDef:e,format:s.numberFormat,formatType:s.numberFormatType,expr:i,config:s})}if(a==="temporal"&&s.timeFormatType&&v(e)&&e.timeUnit===void 0)return Re({fieldOrDatumDef:e,format:s.timeFormat,formatType:s.timeFormatType,expr:i,config:s})}function c(l){return v(l)?se(l.timeUnit)||{}:{unit:void 0,utc:void 0}}if(Fn(e)){const{unit:l,utc:f}=c(e),d=sh({field:o,timeUnit:l,format:t,formatType:s.timeFormatType,rawTimeFormat:s.timeFormat,isUTCScale:f||ln(e)&&((u=e.scale)==null?void 0:u.type)===le.UTC});return d?{signal:d}:void 0}if(t=is({type:a,specifiedFormat:t,config:s,normalizeStack:r}),v(e)&&H(e.bin)){const l=E(e,{expr:i,binSuffix:"end"});return{signal:ui(o,l,t,n,s)}}else return t||_n(e)==="quantitative"?{signal:`${zu(o,t)}`}:{signal:`isValid(${o}) ? ${o} : ""+${o}`}}function Au(e,t,n){return v(e)?n?`${E(e,{expr:t,suffix:"end"})}-${E(e,{expr:t,suffix:"start"})}`:E(e,{expr:t}):nh(e)}function Re({fieldOrDatumDef:e,format:t,formatType:n,expr:i,normalizeStack:r,config:s,field:o}){if(o??(o=Au(e,i,r)),o!=="datum.value"&&v(e)&&H(e.bin)){const a=E(e,{expr:i,binSuffix:"end"});return{signal:ui(o,a,t,n,s)}}return{signal:Ou(n,o,t)}}function Pu(e,t,n,i,r,s){var o;if(!(T(i)&&Jt(i))&&!(n===void 0&&i===void 0&&r.customFormatTypes&&_n(e)==="quantitative"&&(r.normalizedNumberFormatType&&Cn(e)&&e.stack==="normalize"||r.numberFormatType))){if(Cn(e)&&e.stack==="normalize"&&r.normalizedNumberFormat)return is({type:"quantitative",config:r,normalizeStack:!0});if(Fn(e)){const a=v(e)?(o=se(e.timeUnit))==null?void 0:o.unit:void 0;return a===void 0&&r.customFormatTypes&&r.timeFormatType?void 0:rh({specifiedFormat:n,timeUnit:a,config:r,omitTimeFormatConfig:s})}return is({type:t,specifiedFormat:n,config:r})}}function Ru(e,t,n){var i;if(e&&(C(e)||e==="number"||e==="time"))return e;if(Fn(t)&&n!=="time"&&n!=="utc")return v(t)&&((i=se(t==null?void 0:t.timeUnit))!=null&&i.utc)?"utc":"time"}function is({type:e,specifiedFormat:t,config:n,normalizeStack:i}){if(T(t))return t;if(e===Qt)return i?n.normalizedNumberFormat:n.numberFormat}function rh({specifiedFormat:e,timeUnit:t,config:n,omitTimeFormatConfig:i}){return e||(t?{signal:pu(t)}:i?void 0:n.timeFormat)}function zu(e,t){return`format(${e}, "${t||""}")`}function Oa(e,t,n,i){return Jt(n)?Ou(n,e,t):zu(e,(T(t)?t:void 0)??i.numberFormat)}function ui(e,t,n,i,r){if(n===void 0&&i===void 0&&r.customFormatTypes&&r.numberFormatType)return ui(e,t,r.numberFormat,r.numberFormatType,r);const s=Oa(e,n,i,r),o=Oa(t,n,i,r);return`${rr(e,!1)} ? "null" : ${s} + "${Gd}" + ${o}`}function sh({field:e,timeUnit:t,format:n,formatType:i,rawTimeFormat:r,isUTCScale:s}){return!t||n?!t&&i?`${i}(${e}, ${D(n)})`:(n=T(n)?n:r,`${s?"utc":"time"}Format(${e}, ${D(n)})`):gg(t,e,s)}const ur="min",oh={x:1,y:1,color:1,fill:1,stroke:1,strokeWidth:1,size:1,shape:1,fillOpacity:1,strokeOpacity:1,opacity:1,text:1};function Aa(e){return Z(oh,e)}function ah(e){return $(e,"encoding")}function pt(e){return e&&(e.op==="count"||$(e,"field"))}function Iu(e){return e&&_(e)}function li(e){return $(e,"row")||$(e,"column")}function co(e){return $(e,"header")}function lr(e){return $(e,"facet")}function ch(e){return $(e,"param")}function uh(e){return!T(e)&&$(e,"repeat")}function Pa(e){const{field:t,timeUnit:n,bin:i,aggregate:r}=e;return{...n?{timeUnit:n}:{},...i?{bin:i}:{},...r?{aggregate:r}:{},field:t}}function uo(e){return $(e,"sort")}function Ot({fieldDef:e,fieldDef2:t,markDef:n,config:i}){if(O(e)&&e.bandPosition!==void 0)return e.bandPosition;if(v(e)){const{timeUnit:r,bin:s}=e;if(r&&!t)return Ze("timeUnitBandPosition",n,i);if(H(s))return .5}}function Lu({channel:e,fieldDef:t,fieldDef2:n,markDef:i,config:r,scaleType:s,useVlSizeChannel:o}){var u,l,f;const a=Se(e),c=M(o?"size":a,i,r,{vgChannel:a});if(c!==void 0)return c;if(v(t)){const{timeUnit:d,bin:p}=t;if(d&&!n)return{band:Ze("timeUnitBandSize",i,r)};if(H(p)&&!oe(s))return{band:1}}if(Zn(i.type))return s?oe(s)?((u=r[i.type])==null?void 0:u.discreteBandSize)||{band:1}:(l=r[i.type])==null?void 0:l.continuousBandSize:(f=r[i.type])==null?void 0:f.discreteBandSize}function Mu(e,t,n,i){return H(e.bin)||e.timeUnit&&ge(e)&&e.type==="temporal"?Ot({fieldDef:e,fieldDef2:t,markDef:n,config:i})!==void 0:!1}function Du(e){return $(e,"sort")&&!$(e,"field")}function fi(e){return $(e,"condition")}function fr(e){const t=e==null?void 0:e.condition;return!!t&&!_(t)&&v(t)}function di(e){const t=e==null?void 0:e.condition;return!!t&&!_(t)&&O(t)}function lh(e){const t=e==null?void 0:e.condition;return!!t&&(_(t)||Me(t))}function v(e){return $(e,"field")||(e==null?void 0:e.aggregate)==="count"}function _n(e){return e==null?void 0:e.type}function ot(e){return $(e,"datum")}function Ft(e){return ge(e)&&!Mi(e)||Li(e)}function Ra(e){return ge(e)&&e.type==="quantitative"&&!e.bin||Li(e)}function Li(e){return ot(e)&&G(e.datum)}function O(e){return v(e)||ot(e)}function ge(e){return e&&($(e,"field")||e.aggregate==="count")&&$(e,"type")}function Me(e){return $(e,"value")}function ln(e){return $(e,"scale")||$(e,"sort")}function Cn(e){return $(e,"axis")||$(e,"stack")||$(e,"impute")}function ju(e){return $(e,"legend")}function Uu(e){return $(e,"format")||$(e,"formatType")}function fh(e){return Fe(e,["legend","axis","header","scale"])}function dh(e){return $(e,"op")}function E(e,t={}){let n=e.field;const i=t.prefix;let r=t.suffix,s="";if(gh(e))n=hd("count");else{let o;if(!t.nofn)if(dh(e))o=e.op;else{const{bin:a,aggregate:c,timeUnit:u}=e;H(a)?(o=qc(a),r=(t.binSuffix??"")+(t.suffix??"")):c?jt(c)?(s=`["${n}"]`,n=`argmax_${c.argmax}`):mt(c)?(s=`["${n}"]`,n=`argmin_${c.argmin}`):o=String(c):u&&!un(u)&&(o=hg(u),r=(!["range","mid"].includes(t.binSuffix)&&t.binSuffix||"")+(t.suffix??""))}o&&(n=n?`${o}_${n}`:o)}return r&&(n=`${n}_${r}`),i&&(n=`${i}_${n}`),t.forAs?ii(n):t.expr?fd(n,t.expr)+s:Ie(n)+s}function Mi(e){switch(e.type){case"nominal":case"ordinal":case"geojson":return!0;case"quantitative":return v(e)&&!!e.bin;case"temporal":return!1}throw new Error(tu(e.type))}function ph(e){var t;return ln(e)&&kn((t=e.scale)==null?void 0:t.type)}function gh(e){return e.aggregate==="count"}function hh(e,t){var o;const{field:n,bin:i,timeUnit:r,aggregate:s}=e;if(s==="count")return t.countTitle;if(H(i))return`${n} (binned)`;if(r&&!un(r)){const a=(o=se(r))==null?void 0:o.unit;if(a)return`${n} (${ir(a).join("-")})`}else if(s)return jt(s)?`${n} for max ${s.argmax}`:mt(s)?`${n} for min ${s.argmin}`:`${Vi(s)} of ${n}`;return n}function mh(e){const{aggregate:t,bin:n,timeUnit:i,field:r}=e;if(jt(t))return`${r} for argmax(${t.argmax})`;if(mt(t))return`${r} for argmin(${t.argmin})`;const s=i&&!un(i)?se(i):void 0,o=t||(s==null?void 0:s.unit)||(s==null?void 0:s.maxbins)&&"timeunit"||H(n)&&"bin";return o?`${o.toUpperCase()}(${r})`:r}const Bu=(e,t)=>{switch(t.fieldTitle){case"plain":return e.field;case"functional":return mh(e);default:return hh(e,t)}};let Wu=Bu;function Hu(e){Wu=e}function yh(){Hu(Bu)}function xn(e,t,{allowDisabling:n,includeDefault:i=!0}){var a;const r=(a=lo(e))==null?void 0:a.title;if(!v(e))return r??e.title;const s=e,o=i?fo(s,t):void 0;return n?te(r,s.title,o):r??s.title??o}function lo(e){if(Cn(e)&&e.axis)return e.axis;if(ju(e)&&e.legend)return e.legend;if(co(e)&&e.header)return e.header}function fo(e,t){return Wu(e,t)}function Di(e){if(Uu(e)){const{format:t,formatType:n}=e;return{format:t,formatType:n}}else{const t=lo(e)??{},{format:n,formatType:i}=t;return{format:n,formatType:i}}}function xh(e,t){var s;switch(t){case"latitude":case"longitude":return"quantitative";case"row":case"column":case"facet":case"shape":case"strokeDash":return"nominal";case"order":return"ordinal"}if(uo(e)&&_(e.sort))return"ordinal";const{aggregate:n,bin:i,timeUnit:r}=e;if(r)return"temporal";if(i||n&&!jt(n)&&!mt(n))return"quantitative";if(ln(e)&&((s=e.scale)!=null&&s.type))switch(ts[e.scale.type]){case"numeric":case"discretizing":return"quantitative";case"time":return"temporal"}return"nominal"}function De(e){if(v(e))return e;if(fr(e))return e.condition}function ne(e){if(O(e))return e;if(di(e))return e.condition}function qu(e,t,n,i={}){if(T(e)||G(e)||ni(e)){const r=T(e)?"string":G(e)?"number":"boolean";return w(xp(t,r,e)),{value:e}}return O(e)?ji(e,t,n,i):di(e)?{...e,condition:ji(e.condition,t,n,i)}:e}function ji(e,t,n,i){if(Uu(e)){const{format:r,formatType:s,...o}=e;if(Jt(s)&&!n.customFormatTypes)return w(_a(t)),ji(o,t,n,i)}else{const r=Cn(e)?"axis":ju(e)?"legend":co(e)?"header":null;if(r&&e[r]){const{format:s,formatType:o,...a}=e[r];if(Jt(o)&&!n.customFormatTypes)return w(_a(t)),ji({...e,[r]:a},t,n,i)}}return v(e)?po(e,t,i):bh(e)}function bh(e){let t=e.type;if(t)return e;const{datum:n}=e;return t=G(n)?"quantitative":T(n)?"nominal":cn(n)?"temporal":void 0,{...e,type:t}}function po(e,t,{compositeMark:n=!1}={}){const{aggregate:i,timeUnit:r,bin:s,field:o}=e,a={...e};if(!n&&i&&!Is(i)&&!jt(i)&&!mt(i)&&(w(Sp(i)),delete a.aggregate),r&&(a.timeUnit=se(r)),o&&(a.field=`${o}`),H(s)&&(a.bin=dr(s,t)),ce(s)&&!ee(t)&&w(Zp(t)),ge(a)){const{type:c}=a,u=wg(c);c!==u&&(a.type=u),c!=="quantitative"&&er(i)&&(w(bp(c,i)),a.type="quantitative")}else if(!Dc(t)){const c=xh(a,t);a.type=c}if(ge(a)){const{compatible:c,warning:u}=Sh(a,t)||{};c===!1&&w(u)}if(uo(a)&&T(a.sort)){const{sort:c}=a;if(Aa(c))return{...a,sort:{encoding:c}};const u=c.substring(1);if(c.charAt(0)==="-"&&Aa(u))return{...a,sort:{encoding:u,order:"descending"}}}if(co(a)){const{header:c}=a;if(c){const{orient:u,...l}=c;if(u)return{...a,header:{...l,labelOrient:c.labelOrient||u,titleOrient:c.titleOrient||u}}}}return a}function dr(e,t){return ni(e)?{maxbins:ya(t)}:e==="binned"?{binned:!0}:!e.maxbins&&!e.step?{...e,maxbins:ya(t)}:e}const pn={compatible:!0};function Sh(e,t){const n=e.type;if(n==="geojson"&&t!=="shape")return{compatible:!1,warning:`Channel ${t} should not be used with a geojson data.`};switch(t){case ft:case dt:case Xi:return Mi(e)?pn:{compatible:!1,warning:Ep(t)};case V:case ae:case Rt:case Ln:case xe:case nt:case it:case ri:case si:case Yi:case Xt:case Ki:case Qi:case rn:case Te:case Be:case Zi:return pn;case He:case Ne:case We:case qe:return n!==Qt?{compatible:!1,warning:`Channel ${t} should be used with a quantitative field only, not ${e.type} field.`}:pn;case vt:case It:case Lt:case Mt:case $t:case St:case bt:case Ue:case tt:case zt:return n==="nominal"&&!e.sort?{compatible:!1,warning:`Channel ${t} should not be used with an unsorted discrete field.`}:pn;case be:case Dt:return!Mi(e)&&!ph(e)?{compatible:!1,warning:kp(t)}:pn;case wn:return e.type==="nominal"&&!("sort"in e)?{compatible:!1,warning:"Channel order is inappropriate for nominal field, which has no inherent order."}:pn}}function Fn(e){const{formatType:t}=Di(e);return t==="time"||!t&&$h(e)}function $h(e){return e&&(e.type==="temporal"||v(e)&&!!e.timeUnit)}function pr(e,{timeUnit:t,type:n,wrapTime:i,undefinedIfExprNotRequired:r}){var c;const s=t&&((c=se(t))==null?void 0:c.unit);let o=s||n==="temporal",a;return ai(e)?a=e.expr:C(e)?a=e.signal:cn(e)?(o=!0,a=Kt(e)):(T(e)||G(e))&&o&&(a=`datetime(${D(e)})`,lg(s)&&(G(e)&&e<1e4||T(e)&&isNaN(Date.parse(e)))&&(a=Kt({[s]:e}))),a?i&&o?`time(${a})`:a:r?void 0:D(e)}function Gu(e,t){const{type:n}=e;return t.map(i=>{const r=v(e)&&!un(e.timeUnit)?e.timeUnit:void 0,s=pr(i,{timeUnit:r,type:n,undefinedIfExprNotRequired:!0});return s!==void 0?{signal:s}:i})}function pi(e,t){return H(e.bin)?st(t)&&["ordinal","nominal"].includes(e.type):(console.warn("Only call this method for binned field defs."),!1)}const za={labelAlign:{part:"labels",vgProp:"align"},labelBaseline:{part:"labels",vgProp:"baseline"},labelColor:{part:"labels",vgProp:"fill"},labelFont:{part:"labels",vgProp:"font"},labelFontSize:{part:"labels",vgProp:"fontSize"},labelFontStyle:{part:"labels",vgProp:"fontStyle"},labelFontWeight:{part:"labels",vgProp:"fontWeight"},labelOpacity:{part:"labels",vgProp:"opacity"},labelOffset:null,labelPadding:null,gridColor:{part:"grid",vgProp:"stroke"},gridDash:{part:"grid",vgProp:"strokeDash"},gridDashOffset:{part:"grid",vgProp:"strokeDashOffset"},gridOpacity:{part:"grid",vgProp:"opacity"},gridWidth:{part:"grid",vgProp:"strokeWidth"},tickColor:{part:"ticks",vgProp:"stroke"},tickDash:{part:"ticks",vgProp:"strokeDash"},tickDashOffset:{part:"ticks",vgProp:"strokeDashOffset"},tickOpacity:{part:"ticks",vgProp:"opacity"},tickSize:null,tickWidth:{part:"ticks",vgProp:"strokeWidth"}};function gi(e){return e==null?void 0:e.condition}const Vu=["domain","grid","labels","ticks","title"],vh={grid:"grid",gridCap:"grid",gridColor:"grid",gridDash:"grid",gridDashOffset:"grid",gridOpacity:"grid",gridScale:"grid",gridWidth:"grid",orient:"main",bandPosition:"both",aria:"main",description:"main",domain:"main",domainCap:"main",domainColor:"main",domainDash:"main",domainDashOffset:"main",domainOpacity:"main",domainWidth:"main",format:"main",formatType:"main",labelAlign:"main",labelAngle:"main",labelBaseline:"main",labelBound:"main",labelColor:"main",labelFlush:"main",labelFlushOffset:"main",labelFont:"main",labelFontSize:"main",labelFontStyle:"main",labelFontWeight:"main",labelLimit:"main",labelLineHeight:"main",labelOffset:"main",labelOpacity:"main",labelOverlap:"main",labelPadding:"main",labels:"main",labelSeparation:"main",maxExtent:"main",minExtent:"main",offset:"both",position:"main",tickCap:"main",tickColor:"main",tickDash:"main",tickDashOffset:"main",tickMinStep:"both",tickOffset:"both",tickOpacity:"main",tickRound:"both",ticks:"main",tickSize:"main",tickWidth:"both",title:"main",titleAlign:"main",titleAnchor:"main",titleAngle:"main",titleBaseline:"main",titleColor:"main",titleFont:"main",titleFontSize:"main",titleFontStyle:"main",titleFontWeight:"main",titleLimit:"main",titleLineHeight:"main",titleOpacity:"main",titlePadding:"main",titleX:"main",titleY:"main",encode:"both",scale:"both",tickBand:"both",tickCount:"both",tickExtra:"both",translate:"both",values:"both",zindex:"both"},Xu={orient:1,aria:1,bandPosition:1,description:1,domain:1,domainCap:1,domainColor:1,domainDash:1,domainDashOffset:1,domainOpacity:1,domainWidth:1,format:1,formatType:1,grid:1,gridCap:1,gridColor:1,gridDash:1,gridDashOffset:1,gridOpacity:1,gridWidth:1,labelAlign:1,labelAngle:1,labelBaseline:1,labelBound:1,labelColor:1,labelFlush:1,labelFlushOffset:1,labelFont:1,labelFontSize:1,labelFontStyle:1,labelFontWeight:1,labelLimit:1,labelLineHeight:1,labelOffset:1,labelOpacity:1,labelOverlap:1,labelPadding:1,labels:1,labelSeparation:1,maxExtent:1,minExtent:1,offset:1,position:1,tickBand:1,tickCap:1,tickColor:1,tickCount:1,tickDash:1,tickDashOffset:1,tickExtra:1,tickMinStep:1,tickOffset:1,tickOpacity:1,tickRound:1,ticks:1,tickSize:1,tickWidth:1,title:1,titleAlign:1,titleAnchor:1,titleAngle:1,titleBaseline:1,titleColor:1,titleFont:1,titleFontSize:1,titleFontStyle:1,titleFontWeight:1,titleLimit:1,titleLineHeight:1,titleOpacity:1,titlePadding:1,titleX:1,titleY:1,translate:1,values:1,zindex:1},wh={...Xu,style:1,labelExpr:1,encoding:1};function Ia(e){return Z(wh,e)}const Eh={axis:1,axisBand:1,axisBottom:1,axisDiscrete:1,axisLeft:1,axisPoint:1,axisQuantitative:1,axisRight:1,axisTemporal:1,axisTop:1,axisX:1,axisXBand:1,axisXDiscrete:1,axisXPoint:1,axisXQuantitative:1,axisXTemporal:1,axisY:1,axisYBand:1,axisYDiscrete:1,axisYPoint:1,axisYQuantitative:1,axisYTemporal:1},Yu=b(Eh);function Et(e){return $(e,"mark")}class gr{constructor(t,n){x(this,"name");x(this,"run");this.name=t,this.run=n}hasMatchingType(t){return Et(t)?Jg(t.mark)===this.name:!1}}function Ht(e,t){const n=e==null?void 0:e[t];return n?_(n)?Kn(n,i=>!!i.field):v(n)||fr(n):!1}function Ku(e,t){const n=e==null?void 0:e[t];return n?_(n)?Kn(n,i=>!!i.field):v(n)||ot(n)||di(n):!1}function Qu(e,t){if(ee(t)){const n=e[t];if((v(n)||ot(n))&&(Qs(n.type)||v(n)&&n.timeUnit)){const i=Os(t);return Ku(e,i)}}return!1}function Zu(e){return Kn(bd,t=>{if(Ht(e,t)){const n=e[t];if(_(n))return Kn(n,i=>!!i.aggregate);{const i=De(n);return i&&!!i.aggregate}}return!1})}function Ju(e,t){const n=[],i=[],r=[],s=[],o={};return go(e,(a,c)=>{if(v(a)){const{field:u,aggregate:l,bin:f,timeUnit:d,...p}=a;if(l||d||f){const g=lo(a),h=g==null?void 0:g.title;let m=E(a,{forAs:!0});const y={...h?[]:{title:xn(a,t,{allowDisabling:!0})},...p,field:m};if(l){let S;if(jt(l)?(S="argmax",m=E({op:"argmax",field:l.argmax},{forAs:!0}),y.field=`${m}.${u}`):mt(l)?(S="argmin",m=E({op:"argmin",field:l.argmin},{forAs:!0}),y.field=`${m}.${u}`):l!=="boxplot"&&l!=="errorbar"&&l!=="errorband"&&(S=l),S){const k={op:S,as:m};u&&(k.field=u),s.push(k)}}else if(n.push(m),ge(a)&&H(f)){if(i.push({bin:f,field:u,as:m}),n.push(E(a,{binSuffix:"end"})),pi(a,c)&&n.push(E(a,{binSuffix:"range"})),ee(c)){const S={field:`${m}_end`};o[`${c}2`]=S}y.bin="binned",Dc(c)||(y.type=Qt)}else if(d&&!un(d)){r.push({timeUnit:d,field:u,as:m});const S=ge(a)&&a.type!==En&&"time";S&&(c===ri||c===Xt?y.formatType=S:Td(c)?y.legend={formatType:S,...y.legend}:ee(c)&&(y.axis={formatType:S,...y.axis}))}o[c]=y}else n.push(u),o[c]=e[c]}else o[c]=e[c]}),{bins:i,timeUnits:r,aggregate:s,groupby:n,encoding:o}}function kh(e,t,n){const i=Ad(t,n);if(i){if(i==="binned"){const r=e[t===Ue?V:ae];return!!(v(r)&&v(e[t])&&ce(r.bin))}}else return!1;return!0}function _h(e,t,n,i){const r={};for(const s of b(e))Mc(s)||w(wp(s));for(let s of kd){if(!e[s])continue;const o=e[s];if(oi(s)){const a=Ed(s),c=r[a];if(v(c)&&vg(c.type)&&v(o)&&!c.timeUnit){w(yp(a));continue}}if(s==="angle"&&t==="arc"&&!e.theta&&(w(mp),s=Te),!kh(e,s,t)){w(nr(s,t));continue}if(s===$t&&t==="line"){const a=De(e[s]);if(a!=null&&a.aggregate){w(vp);continue}}if(s===xe&&(n?"fill"in e:"stroke"in e)){w(nu("encoding",{fill:"fill"in e,stroke:"stroke"in e}));continue}if(s===si||s===wn&&!_(o)&&!Me(o)||s===Xt&&_(o)){if(o){if(s===wn){const a=e[s];if(Du(a)){r[s]=a;continue}}r[s]=J(o).reduce((a,c)=>(v(c)?a.push(po(c,s)):w(es(c,s)),a),[])}}else{if(s===Xt&&o===null)r[s]=null;else if(!v(o)&&!ot(o)&&!Me(o)&&!fi(o)&&!C(o)){w(es(o,s));continue}r[s]=qu(o,s,i)}}return r}function hr(e,t){const n={};for(const i of b(e)){const r=qu(e[i],i,t,{compositeMark:!0});n[i]=r}return n}function Ch(e){const t=[];for(const n of b(e))if(Ht(e,n)){const i=e[n],r=J(i);for(const s of r)v(s)?t.push(s):fr(s)&&t.push(s.condition)}return t}function go(e,t,n){if(e)for(const i of b(e)){const r=e[i];if(_(r))for(const s of r)t.call(n,s,i);else t.call(n,r,i)}}function Fh(e,t,n,i){return e?b(e).reduce((r,s)=>{const o=e[s];return _(o)?o.reduce((a,c)=>t.call(i,a,c,s),r):t.call(i,r,o,s)},n):n}function el(e,t){return b(t).reduce((n,i)=>{switch(i){case V:case ae:case Ki:case Zi:case Qi:case Ue:case tt:case Rt:case Ln:case Te:case St:case Be:case bt:case zt:case We:case He:case qe:case Ne:case ri:case be:case rn:case Xt:return n;case wn:if(e==="line"||e==="trail")return n;case si:case Yi:{const r=t[i];if(_(r)||v(r))for(const s of J(r))s.aggregate||n.push(E(s,{}));return n}case $t:if(e==="trail")return n;case xe:case nt:case it:case vt:case It:case Lt:case Dt:case Mt:{const r=De(t[i]);return r&&!r.aggregate&&n.push(E(r,{})),n}}},[])}function Nh(e){const{tooltip:t,...n}=e;if(!t)return{filteredEncoding:n};let i,r;if(_(t)){for(const s of t)s.aggregate?(i||(i=[]),i.push(s)):(r||(r=[]),r.push(s));i&&(n.tooltip=i)}else t.aggregate?n.tooltip=t:r=t;return _(r)&&r.length===1&&(r=r[0]),{customTooltipWithoutAggregatedField:r,filteredEncoding:n}}function rs(e,t,n,i=!0){if("tooltip"in n)return{tooltip:n.tooltip};const r=e.map(({fieldPrefix:o,titlePrefix:a})=>{const c=i?` of ${ho(t)}`:"";return{field:o+t.field,type:t.type,title:C(a)?{signal:`${a}"${escape(c)}"`}:a+c}}),s=Ch(n).map(fh);return{tooltip:[...r,...ut(s,I)]}}function ho(e){const{title:t,field:n}=e;return te(t,n)}function mo(e,t,n,i,r){const{scale:s,axis:o}=n;return({partName:a,mark:c,positionPrefix:u,endPositionPrefix:l=void 0,extraEncoding:f={}})=>{const d=ho(n);return tl(e,a,r,{mark:c,encoding:{[t]:{field:`${u}_${n.field}`,type:n.type,...d!==void 0?{title:d}:{},...s!==void 0?{scale:s}:{},...o!==void 0?{axis:o}:{}},...T(l)?{[`${t}2`]:{field:`${l}_${n.field}`}}:{},...i,...f}})}}function tl(e,t,n,i){const{clip:r,color:s,opacity:o}=e,a=e.type;return e[t]||e[t]===void 0&&n[t]?[{...i,mark:{...n[t],...r?{clip:r}:{},...s?{color:s}:{},...o?{opacity:o}:{},...Je(i.mark)?i.mark:{type:i.mark},style:`${a}-${String(t)}`,...ni(e[t])?{}:e[t]}}]:[]}function nl(e,t,n){const{encoding:i}=e,r=t==="vertical"?"y":"x",s=i[r],o=i[`${r}2`],a=i[`${r}Error`],c=i[`${r}Error2`];return{continuousAxisChannelDef:wi(s,n),continuousAxisChannelDef2:wi(o,n),continuousAxisChannelDefError:wi(a,n),continuousAxisChannelDefError2:wi(c,n),continuousAxis:r}}function wi(e,t){if(e!=null&&e.aggregate){const{aggregate:n,...i}=e;return n!==t&&w(Qp(n,t)),i}else return e}function il(e,t){const{mark:n,encoding:i}=e,{x:r,y:s}=i;if(Je(n)&&n.orient)return n.orient;if(Ft(r)){if(Ft(s)){const o=v(r)&&r.aggregate,a=v(s)&&s.aggregate;if(!o&&a===t)return"vertical";if(!a&&o===t)return"horizontal";if(o===t&&a===t)throw new Error("Both x and y cannot have aggregate");return Fn(s)&&!Fn(r)?"horizontal":"vertical"}return"horizontal"}else{if(Ft(s))return"vertical";throw new Error(`Need a valid continuous axis for ${t}s`)}}const Ui="boxplot",Th=["box","median","outliers","rule","ticks"],Oh=new gr(Ui,sl);function rl(e){return G(e)?"tukey":e}function sl(e,{config:t}){e={...e,encoding:hr(e.encoding,t)};const{mark:n,encoding:i,params:r,projection:s,...o}=e,a=Je(n)?n:{type:n};r&&w(eu("boxplot"));const c=a.extent??t.boxplot.extent,u=M("size",a,t),l=a.invalid,f=rl(c),{bins:d,timeUnits:p,transform:g,continuousAxisChannelDef:h,continuousAxis:m,groupby:y,aggregate:S,encodingWithoutContinuousAxis:k,ticksOrient:A,boxOrient:F,customTooltipWithoutAggregatedField:P}=Ah(e,c,t),B=ii(h.field),{color:X,size:me,...$e}=k,ve=Qf=>mo(a,m,h,Qf,t.boxplot),at=ve($e),Bt=ve(k),xi=(L(t.boxplot.box)?t.boxplot.box.color:t.mark.color)||"#4c78a8",bi=ve({...$e,...me?{size:me}:{},color:{condition:{test:`${U(`lower_box_${h.field}`)} >= ${U(`upper_box_${h.field}`)}`,...X||{value:xi}}}}),Hn=rs([{fieldPrefix:f==="min-max"?"upper_whisker_":"max_",titlePrefix:"Max"},{fieldPrefix:"upper_box_",titlePrefix:"Q3"},{fieldPrefix:"mid_box_",titlePrefix:"Median"},{fieldPrefix:"lower_box_",titlePrefix:"Q1"},{fieldPrefix:f==="min-max"?"lower_whisker_":"min_",titlePrefix:"Min"}],h,k),Ko={type:"tick",color:"black",opacity:1,orient:A,invalid:l,aria:!1},Si=f==="min-max"?Hn:rs([{fieldPrefix:"upper_whisker_",titlePrefix:"Upper Whisker"},{fieldPrefix:"lower_whisker_",titlePrefix:"Lower Whisker"}],h,k),Qo=[...at({partName:"rule",mark:{type:"rule",invalid:l,aria:!1},positionPrefix:"lower_whisker",endPositionPrefix:"lower_box",extraEncoding:Si}),...at({partName:"rule",mark:{type:"rule",invalid:l,aria:!1},positionPrefix:"upper_box",endPositionPrefix:"upper_whisker",extraEncoding:Si}),...at({partName:"ticks",mark:Ko,positionPrefix:"lower_whisker",extraEncoding:Si}),...at({partName:"ticks",mark:Ko,positionPrefix:"upper_whisker",extraEncoding:Si})],Zo=[...f!=="tukey"?Qo:[],...Bt({partName:"box",mark:{type:"bar",...u?{size:u}:{},orient:F,invalid:l,ariaRoleDescription:"box"},positionPrefix:"lower_box",endPositionPrefix:"upper_box",extraEncoding:Hn}),...bi({partName:"median",mark:{type:"tick",invalid:l,...L(t.boxplot.median)&&t.boxplot.median.color?{color:t.boxplot.median.color}:{},...u?{size:u}:{},orient:A,aria:!1},positionPrefix:"mid_box",extraEncoding:Hn})];if(f==="min-max")return{...o,transform:(o.transform??[]).concat(g),layer:Zo};const Jo=U(`lower_box_${h.field}`),ea=U(`upper_box_${h.field}`),ta=`(${ea} - ${Jo})`,na=`${Jo} - ${c} * ${ta}`,ia=`${ea} + ${c} * ${ta}`,$i=U(h.field),Yf={joinaggregate:ol(h.field),groupby:y},ra={transform:[{filter:`(${na} <= ${$i}) && (${$i} <= ${ia})`},{aggregate:[{op:"min",field:h.field,as:`lower_whisker_${B}`},{op:"max",field:h.field,as:`upper_whisker_${B}`},{op:"min",field:`lower_box_${h.field}`,as:`lower_box_${B}`},{op:"max",field:`upper_box_${h.field}`,as:`upper_box_${B}`},...S],groupby:y}],layer:Qo},{tooltip:BS,...Kf}=$e,{scale:sa,axis:oa}=h,aa=ho(h),ca=tl(a,"outliers",t.boxplot,{transform:[{filter:`(${$i} < ${na}) || (${$i} > ${ia})`}],mark:"point",encoding:{[m]:{field:h.field,type:h.type,...aa!==void 0?{title:aa}:{},...sa!==void 0?{scale:sa}:{},...oa!==void 0?{axis:oa}:{}},...Kf,...X?{color:X}:{},...P?{tooltip:P}:{}}})[0];let vi;const ua=[...d,...p,Yf];return ca?vi={transform:ua,layer:[ca,ra]}:(vi=ra,vi.transform.unshift(...ua)),{...o,layer:[vi,{transform:g,layer:Zo}]}}function ol(e){const t=ii(e);return[{op:"q1",field:e,as:`lower_box_${t}`},{op:"q3",field:e,as:`upper_box_${t}`}]}function Ah(e,t,n){const i=il(e,Ui),{continuousAxisChannelDef:r,continuousAxis:s}=nl(e,i,Ui),o=r.field,a=ii(o),c=rl(t),u=[...ol(o),{op:"median",field:o,as:`mid_box_${a}`},{op:"min",field:o,as:(c==="min-max"?"lower_whisker_":"min_")+a},{op:"max",field:o,as:(c==="min-max"?"upper_whisker_":"max_")+a}],l=c==="min-max"||c==="tukey"?[]:[{calculate:`${U(`upper_box_${a}`)} - ${U(`lower_box_${a}`)}`,as:`iqr_${a}`},{calculate:`min(${U(`upper_box_${a}`)} + ${U(`iqr_${a}`)} * ${t}, ${U(`max_${a}`)})`,as:`upper_whisker_${a}`},{calculate:`max(${U(`lower_box_${a}`)} - ${U(`iqr_${a}`)} * ${t}, ${U(`min_${a}`)})`,as:`lower_whisker_${a}`}],{[s]:f,...d}=e.encoding,{customTooltipWithoutAggregatedField:p,filteredEncoding:g}=Nh(d),{bins:h,timeUnits:m,aggregate:y,groupby:S,encoding:k}=Ju(g,n),A=i==="vertical"?"horizontal":"vertical",F=i,P=[...h,...m,{aggregate:[...y,...u],groupby:S},...l];return{bins:h,timeUnits:m,transform:P,groupby:S,aggregate:y,continuousAxisChannelDef:r,continuousAxis:s,encodingWithoutContinuousAxis:k,ticksOrient:A,boxOrient:F,customTooltipWithoutAggregatedField:p}}const yo="errorbar",Ph=["ticks","rule"],Rh=new gr(yo,al);function al(e,{config:t}){e={...e,encoding:hr(e.encoding,t)};const{transform:n,continuousAxisChannelDef:i,continuousAxis:r,encodingWithoutContinuousAxis:s,ticksOrient:o,markDef:a,outerSpec:c,tooltipEncoding:u}=cl(e,yo,t);delete s.size;const l=mo(a,r,i,s,t.errorbar),f=a.thickness,d=a.size,p={type:"tick",orient:o,aria:!1,...f!==void 0?{thickness:f}:{},...d!==void 0?{size:d}:{}},g=[...l({partName:"ticks",mark:p,positionPrefix:"lower",extraEncoding:u}),...l({partName:"ticks",mark:p,positionPrefix:"upper",extraEncoding:u}),...l({partName:"rule",mark:{type:"rule",ariaRoleDescription:"errorbar",...f!==void 0?{size:f}:{}},positionPrefix:"lower",endPositionPrefix:"upper",extraEncoding:u})];return{...c,transform:n,...g.length>1?{layer:g}:{...g[0]}}}function zh(e,t){const{encoding:n}=e;if(Ih(n))return{orient:il(e,t),inputType:"raw"};const i=Lh(n),r=Mh(n),s=n.x,o=n.y;if(i){if(r)throw new Error(`${t} cannot be both type aggregated-upper-lower and aggregated-error`);const a=n.x2,c=n.y2;if(O(a)&&O(c))throw new Error(`${t} cannot have both x2 and y2`);if(O(a)){if(Ft(s))return{orient:"horizontal",inputType:"aggregated-upper-lower"};throw new Error(`Both x and x2 have to be quantitative in ${t}`)}else if(O(c)){if(Ft(o))return{orient:"vertical",inputType:"aggregated-upper-lower"};throw new Error(`Both y and y2 have to be quantitative in ${t}`)}throw new Error("No ranged axis")}else{const a=n.xError,c=n.xError2,u=n.yError,l=n.yError2;if(O(c)&&!O(a))throw new Error(`${t} cannot have xError2 without xError`);if(O(l)&&!O(u))throw new Error(`${t} cannot have yError2 without yError`);if(O(a)&&O(u))throw new Error(`${t} cannot have both xError and yError with both are quantiative`);if(O(a)){if(Ft(s))return{orient:"horizontal",inputType:"aggregated-error"};throw new Error("All x, xError, and xError2 (if exist) have to be quantitative")}else if(O(u)){if(Ft(o))return{orient:"vertical",inputType:"aggregated-error"};throw new Error("All y, yError, and yError2 (if exist) have to be quantitative")}throw new Error("No ranged axis")}}function Ih(e){return(O(e.x)||O(e.y))&&!O(e.x2)&&!O(e.y2)&&!O(e.xError)&&!O(e.xError2)&&!O(e.yError)&&!O(e.yError2)}function Lh(e){return O(e.x2)||O(e.y2)}function Mh(e){return O(e.xError)||O(e.xError2)||O(e.yError)||O(e.yError2)}function cl(e,t,n){const{mark:i,encoding:r,params:s,projection:o,...a}=e,c=Je(i)?i:{type:i};s&&w(eu(t));const{orient:u,inputType:l}=zh(e,t),{continuousAxisChannelDef:f,continuousAxisChannelDef2:d,continuousAxisChannelDefError:p,continuousAxisChannelDefError2:g,continuousAxis:h}=nl(e,u,t),{errorBarSpecificAggregate:m,postAggregateCalculates:y,tooltipSummary:S,tooltipTitleWithFieldName:k}=Dh(c,f,d,p,g,l,t,n),{[h]:A,[h==="x"?"x2":"y2"]:F,[h==="x"?"xError":"yError"]:P,[h==="x"?"xError2":"yError2"]:B,...X}=r,{bins:me,timeUnits:$e,aggregate:ve,groupby:at,encoding:Bt}=Ju(X,n),xi=[...ve,...m],bi=l!=="raw"?[]:at,Hn=rs(S,f,Bt,k);return{transform:[...a.transform??[],...me,...$e,...xi.length===0?[]:[{aggregate:xi,groupby:bi}],...y],groupby:bi,continuousAxisChannelDef:f,continuousAxis:h,encodingWithoutContinuousAxis:Bt,ticksOrient:u==="vertical"?"horizontal":"vertical",markDef:c,outerSpec:a,tooltipEncoding:Hn}}function Dh(e,t,n,i,r,s,o,a){let c=[],u=[];const l=t.field;let f,d=!1;if(s==="raw"){const p=e.center?e.center:e.extent?e.extent==="iqr"?"median":"mean":a.errorbar.center,g=e.extent?e.extent:p==="mean"?"stderr":"iqr";if(p==="median"!=(g==="iqr")&&w(Kp(p,g,o)),g==="stderr"||g==="stdev")c=[{op:g,field:l,as:`extent_${l}`},{op:p,field:l,as:`center_${l}`}],u=[{calculate:`${U(`center_${l}`)} + ${U(`extent_${l}`)}`,as:`upper_${l}`},{calculate:`${U(`center_${l}`)} - ${U(`extent_${l}`)}`,as:`lower_${l}`}],f=[{fieldPrefix:"center_",titlePrefix:Vi(p)},{fieldPrefix:"upper_",titlePrefix:La(p,g,"+")},{fieldPrefix:"lower_",titlePrefix:La(p,g,"-")}],d=!0;else{let h,m,y;g==="ci"?(h="mean",m="ci0",y="ci1"):(h="median",m="q1",y="q3"),c=[{op:m,field:l,as:`lower_${l}`},{op:y,field:l,as:`upper_${l}`},{op:h,field:l,as:`center_${l}`}],f=[{fieldPrefix:"upper_",titlePrefix:xn({field:l,aggregate:y,type:"quantitative"},a,{allowDisabling:!1})},{fieldPrefix:"lower_",titlePrefix:xn({field:l,aggregate:m,type:"quantitative"},a,{allowDisabling:!1})},{fieldPrefix:"center_",titlePrefix:xn({field:l,aggregate:h,type:"quantitative"},a,{allowDisabling:!1})}]}}else{(e.center||e.extent)&&w(Yp(e.center,e.extent)),s==="aggregated-upper-lower"?(f=[],u=[{calculate:U(n.field),as:`upper_${l}`},{calculate:U(l),as:`lower_${l}`}]):s==="aggregated-error"&&(f=[{fieldPrefix:"",titlePrefix:l}],u=[{calculate:`${U(l)} + ${U(i.field)}`,as:`upper_${l}`}],r?u.push({calculate:`${U(l)} + ${U(r.field)}`,as:`lower_${l}`}):u.push({calculate:`${U(l)} - ${U(i.field)}`,as:`lower_${l}`}));for(const p of u)f.push({fieldPrefix:p.as.substring(0,6),titlePrefix:vn(vn(p.calculate,"datum['",""),"']","")})}return{postAggregateCalculates:u,errorBarSpecificAggregate:c,tooltipSummary:f,tooltipTitleWithFieldName:d}}function La(e,t,n){return`${Vi(e)} ${n} ${t}`}const xo="errorband",jh=["band","borders"],Uh=new gr(xo,ul);function ul(e,{config:t}){e={...e,encoding:hr(e.encoding,t)};const{transform:n,continuousAxisChannelDef:i,continuousAxis:r,encodingWithoutContinuousAxis:s,markDef:o,outerSpec:a,tooltipEncoding:c}=cl(e,xo,t),u=o,l=mo(u,r,i,s,t.errorband),f=e.encoding.x!==void 0&&e.encoding.y!==void 0;let d={type:f?"area":"rect"},p={type:f?"line":"rule"};const g={...u.interpolate?{interpolate:u.interpolate}:{},...u.tension&&u.interpolate?{tension:u.tension}:{}};return f?(d={...d,...g,ariaRoleDescription:"errorband"},p={...p,...g,aria:!1}):u.interpolate?w(Fa("interpolate")):u.tension&&w(Fa("tension")),{...a,transform:n,layer:[...l({partName:"band",mark:d,positionPrefix:"lower",endPositionPrefix:"upper",extraEncoding:c}),...l({partName:"borders",mark:p,positionPrefix:"lower",extraEncoding:c}),...l({partName:"borders",mark:p,positionPrefix:"upper",extraEncoding:c})]}}const ll={};function bo(e,t,n){const i=new gr(e,t);ll[e]={normalizer:i,parts:n}}function Bh(){return b(ll)}bo(Ui,sl,Th);bo(yo,al,Ph);bo(xo,ul,jh);const Wh=["gradientHorizontalMaxLength","gradientHorizontalMinLength","gradientVerticalMaxLength","gradientVerticalMinLength","unselectedOpacity"],fl={titleAlign:"align",titleAnchor:"anchor",titleAngle:"angle",titleBaseline:"baseline",titleColor:"color",titleFont:"font",titleFontSize:"fontSize",titleFontStyle:"fontStyle",titleFontWeight:"fontWeight",titleLimit:"limit",titleLineHeight:"lineHeight",titleOrient:"orient",titlePadding:"offset"},dl={labelAlign:"align",labelAnchor:"anchor",labelAngle:"angle",labelBaseline:"baseline",labelColor:"color",labelFont:"font",labelFontSize:"fontSize",labelFontStyle:"fontStyle",labelFontWeight:"fontWeight",labelLimit:"limit",labelLineHeight:"lineHeight",labelOrient:"orient",labelPadding:"offset"},Hh=b(fl),qh=b(dl),Gh={header:1,headerRow:1,headerColumn:1,headerFacet:1},pl=b(Gh),gl=["size","shape","fill","stroke","strokeDash","strokeWidth","opacity"],Vh={gradientHorizontalMaxLength:200,gradientHorizontalMinLength:100,gradientVerticalMaxLength:200,gradientVerticalMinLength:64,unselectedOpacity:.35},Xh={aria:1,clipHeight:1,columnPadding:1,columns:1,cornerRadius:1,description:1,direction:1,fillColor:1,format:1,formatType:1,gradientLength:1,gradientOpacity:1,gradientStrokeColor:1,gradientStrokeWidth:1,gradientThickness:1,gridAlign:1,labelAlign:1,labelBaseline:1,labelColor:1,labelFont:1,labelFontSize:1,labelFontStyle:1,labelFontWeight:1,labelLimit:1,labelOffset:1,labelOpacity:1,labelOverlap:1,labelPadding:1,labelSeparation:1,legendX:1,legendY:1,offset:1,orient:1,padding:1,rowPadding:1,strokeColor:1,symbolDash:1,symbolDashOffset:1,symbolFillColor:1,symbolLimit:1,symbolOffset:1,symbolOpacity:1,symbolSize:1,symbolStrokeColor:1,symbolStrokeWidth:1,symbolType:1,tickCount:1,tickMinStep:1,title:1,titleAlign:1,titleAnchor:1,titleBaseline:1,titleColor:1,titleFont:1,titleFontSize:1,titleFontStyle:1,titleFontWeight:1,titleLimit:1,titleLineHeight:1,titleOpacity:1,titleOrient:1,titlePadding:1,type:1,values:1,zindex:1},je="_vgsid_",Yh={point:{on:"click",fields:[je],toggle:"event.shiftKey",resolve:"global",clear:"dblclick"},interval:{on:"[pointerdown, window:pointerup] > window:pointermove!",encodings:["x","y"],translate:"[pointerdown, window:pointerup] > window:pointermove!",zoom:"wheel!",mark:{fill:"#333",fillOpacity:.125,stroke:"white"},resolve:"global",clear:"dblclick"}};function So(e){return e==="legend"||!!(e!=null&&e.legend)}function jr(e){return So(e)&&L(e)}function $o(e){return!!(e!=null&&e.select)}function hl(e){const t=[];for(const n of e||[]){if($o(n))continue;const{expr:i,bind:r,...s}=n;if(r&&i){const o={...s,bind:r,init:i};t.push(o)}else{const o={...s,...i?{update:i}:{},...r?{bind:r}:{}};t.push(o)}}return t}function Kh(e){return mr(e)||wo(e)||vo(e)}function vo(e){return $(e,"concat")}function mr(e){return $(e,"vconcat")}function wo(e){return $(e,"hconcat")}function ml({step:e,offsetIsDiscrete:t}){return t?e.for??"offset":"position"}function et(e){return $(e,"step")}function Ma(e){return $(e,"view")||$(e,"width")||$(e,"height")}const Da=20,Qh={align:1,bounds:1,center:1,columns:1,spacing:1},Zh=b(Qh);function Jh(e,t,n){const i=n[t],r={},{spacing:s,columns:o}=i;s!==void 0&&(r.spacing=s),o!==void 0&&(lr(e)&&!li(e.facet)||vo(e))&&(r.columns=o),mr(e)&&(r.columns=1);for(const a of Zh)if(e[a]!==void 0)if(a==="spacing"){const c=e[a];r[a]=G(c)?c:{row:c.row??s,column:c.column??s}}else r[a]=e[a];return r}function ss(e,t){return e[t]??e[t==="width"?"continuousWidth":"continuousHeight"]}function os(e,t){const n=Bi(e,t);return et(n)?n.step:yl}function Bi(e,t){const n=e[t]??e[t==="width"?"discreteWidth":"discreteHeight"];return te(n,{step:e.step})}const yl=20,em={continuousWidth:300,continuousHeight:300,step:yl},tm={background:"white",padding:5,timeFormat:"%b %d, %Y",countTitle:"Count of Records",view:em,mark:Vg,arc:{},area:{},bar:Qg,circle:{},geoshape:{},image:{},line:{},point:{},rect:io,rule:{color:"black"},square:{},text:{color:"black"},tick:Zg,trail:{},boxplot:{size:14,extent:1.5,box:{},median:{color:"white"},outliers:{},rule:{},ticks:null},errorbar:{center:"mean",rule:!0,ticks:!1},errorband:{band:{opacity:.3},borders:!1},scale:Fg,projection:{},legend:Vh,header:{titlePadding:10,labelPadding:10},headerColumn:{},headerRow:{},headerFacet:{},selection:Yh,style:{},title:{},facet:{spacing:Da},concat:{spacing:Da},normalizedNumberFormat:".0%"},ct=["#4c78a8","#f58518","#e45756","#72b7b2","#54a24b","#eeca3b","#b279a2","#ff9da6","#9d755d","#bab0ac"],ja={text:11,guideLabel:10,guideTitle:11,groupTitle:13,groupSubtitle:12},Ua={blue:ct[0],orange:ct[1],red:ct[2],teal:ct[3],green:ct[4],yellow:ct[5],purple:ct[6],pink:ct[7],brown:ct[8],gray0:"#000",gray1:"#111",gray2:"#222",gray3:"#333",gray4:"#444",gray5:"#555",gray6:"#666",gray7:"#777",gray8:"#888",gray9:"#999",gray10:"#aaa",gray11:"#bbb",gray12:"#ccc",gray13:"#ddd",gray14:"#eee",gray15:"#fff"};function nm(e={}){return{signals:[{name:"color",value:L(e)?{...Ua,...e}:Ua}],mark:{color:{signal:"color.blue"}},rule:{color:{signal:"color.gray0"}},text:{color:{signal:"color.gray0"}},style:{"guide-label":{fill:{signal:"color.gray0"}},"guide-title":{fill:{signal:"color.gray0"}},"group-title":{fill:{signal:"color.gray0"}},"group-subtitle":{fill:{signal:"color.gray0"}},cell:{stroke:{signal:"color.gray8"}}},axis:{domainColor:{signal:"color.gray13"},gridColor:{signal:"color.gray8"},tickColor:{signal:"color.gray13"}},range:{category:[{signal:"color.blue"},{signal:"color.orange"},{signal:"color.red"},{signal:"color.teal"},{signal:"color.green"},{signal:"color.yellow"},{signal:"color.purple"},{signal:"color.pink"},{signal:"color.brown"},{signal:"color.grey8"}]}}}function im(e){return{signals:[{name:"fontSize",value:L(e)?{...ja,...e}:ja}],text:{fontSize:{signal:"fontSize.text"}},style:{"guide-label":{fontSize:{signal:"fontSize.guideLabel"}},"guide-title":{fontSize:{signal:"fontSize.guideTitle"}},"group-title":{fontSize:{signal:"fontSize.groupTitle"}},"group-subtitle":{fontSize:{signal:"fontSize.groupSubtitle"}}}}}function rm(e){return{text:{font:e},style:{"guide-label":{font:e},"guide-title":{font:e},"group-title":{font:e},"group-subtitle":{font:e}}}}function xl(e){const t=b(e||{}),n={};for(const i of t){const r=e[i];n[i]=gi(r)?Vc(r):Ee(r)}return n}function sm(e){const t=b(e),n={};for(const i of t)n[i]=xl(e[i]);return n}const om=[...Cu,...Yu,...pl,"background","padding","legend","lineBreak","scale","style","title","view"];function bl(e={}){const{color:t,font:n,fontSize:i,selection:r,...s}=e,o=Cc({},N(tm),n?rm(n):{},t?nm(t):{},i?im(i):{},s||{});r&&_c(o,"selection",r,!0);const a=Fe(o,om);for(const c of["background","lineBreak","padding"])o[c]&&(a[c]=Ee(o[c]));for(const c of Cu)o[c]&&(a[c]=ue(o[c]));for(const c of Yu)o[c]&&(a[c]=xl(o[c]));for(const c of pl)o[c]&&(a[c]=ue(o[c]));if(o.legend&&(a.legend=ue(o.legend)),o.scale){const{invalid:c,...u}=o.scale,l=ue(c,{level:1});a.scale={...ue(u),...b(l).length>0?{invalid:l}:{}}}return o.style&&(a.style=sm(o.style)),o.title&&(a.title=ue(o.title)),o.view&&(a.view=ue(o.view)),a}const am=new Set(["view",...Ug]),cm=["color","fontSize","background","padding","facet","concat","numberFormat","numberFormatType","normalizedNumberFormat","normalizedNumberFormatType","timeFormat","countTitle","header","axisQuantitative","axisTemporal","axisDiscrete","axisPoint","axisXBand","axisXPoint","axisXDiscrete","axisXQuantitative","axisXTemporal","axisYBand","axisYPoint","axisYDiscrete","axisYQuantitative","axisYTemporal","scale","selection","overlay"],um={view:["continuousWidth","continuousHeight","discreteWidth","discreteHeight","step"],...Gg};function lm(e){e=N(e);for(const t of cm)delete e[t];if(e.axis)for(const t in e.axis)gi(e.axis[t])&&delete e.axis[t];if(e.legend)for(const t of Wh)delete e.legend[t];if(e.mark){for(const t of Ta)delete e.mark[t];e.mark.tooltip&&L(e.mark.tooltip)&&delete e.mark.tooltip}e.params&&(e.signals=(e.signals||[]).concat(hl(e.params)),delete e.params);for(const t of am){for(const i of Ta)delete e[t][i];const n=um[t];if(n)for(const i of n)delete e[t][i];dm(e,t)}for(const t of Bh())delete e[t];fm(e);for(const t in e)L(e[t])&&W(e[t])&&delete e[t];return W(e)?void 0:e}function fm(e){const{titleMarkConfig:t,subtitleMarkConfig:n,subtitle:i}=Gc(e.title);W(t)||(e.style["group-title"]={...e.style["group-title"],...t}),W(n)||(e.style["group-subtitle"]={...e.style["group-subtitle"],...n}),W(i)?delete e.title:e.title=i}function dm(e,t,n,i){const r=e[t];t==="view"&&(n="cell");const s={...r,...e.style[n??t]};W(s)||(e.style[n??t]=s),delete e[t]}function yr(e){return $(e,"layer")}function pm(e){return $(e,"repeat")}function gm(e){return!_(e.repeat)&&$(e.repeat,"layer")}class Eo{map(t,n){return lr(t)?this.mapFacet(t,n):pm(t)?this.mapRepeat(t,n):wo(t)?this.mapHConcat(t,n):mr(t)?this.mapVConcat(t,n):vo(t)?this.mapConcat(t,n):this.mapLayerOrUnit(t,n)}mapLayerOrUnit(t,n){if(yr(t))return this.mapLayer(t,n);if(Et(t))return this.mapUnit(t,n);throw new Error(Ls(t))}mapLayer(t,n){return{...t,layer:t.layer.map(i=>this.mapLayerOrUnit(i,n))}}mapHConcat(t,n){return{...t,hconcat:t.hconcat.map(i=>this.map(i,n))}}mapVConcat(t,n){return{...t,vconcat:t.vconcat.map(i=>this.map(i,n))}}mapConcat(t,n){const{concat:i,...r}=t;return{...r,concat:i.map(s=>this.map(s,n))}}mapFacet(t,n){return{...t,spec:this.map(t.spec,n)}}mapRepeat(t,n){return{...t,spec:this.map(t.spec,n)}}}const hm={zero:1,center:1,normalize:1};function mm(e){return Z(hm,e)}const ym=new Set([Eu,or,sr,zi,cr,to,no,ar,ku,eo]),xm=new Set([or,sr,Eu]);function gn(e){return v(e)&&_n(e)==="quantitative"&&!e.bin}function Ba(e,t,{orient:n,type:i}){const r=t==="x"?"y":"radius",s=t==="x"&&["bar","area"].includes(i),o=e[t],a=e[r];if(v(o)&&v(a))if(gn(o)&&gn(a)){if(o.stack)return t;if(a.stack)return r;const c=v(o)&&!!o.aggregate,u=v(a)&&!!a.aggregate;if(c!==u)return c?t:r;if(s){if(n==="vertical")return r;if(n==="horizontal")return t}}else{if(gn(o))return t;if(gn(a))return r}else{if(gn(o))return s&&n==="vertical"?void 0:t;if(gn(a))return s&&n==="horizontal"?void 0:r}}function bm(e){switch(e){case"x":return"y";case"y":return"x";case"theta":return"radius";case"radius":return"theta"}}function Sl(e,t){var h,m;const n=Je(e)?e:{type:e},i=n.type;if(!ym.has(i))return null;const r=Ba(t,"x",n)||Ba(t,"theta",n);if(!r)return null;const s=t[r],o=v(s)?E(s,{}):void 0,a=bm(r),c=[],u=new Set;if(t[a]){const y=t[a],S=v(y)?E(y,{}):void 0;S&&S!==o&&(c.push(a),u.add(S))}const l=a==="x"?"xOffset":"yOffset",f=t[l],d=v(f)?E(f,{}):void 0;d&&d!==o&&(c.push(l),u.add(d));const p=_d.reduce((y,S)=>{if(S!=="tooltip"&&Ht(t,S)){const k=t[S];for(const A of J(k)){const F=De(A);if(F.aggregate)continue;const P=E(F,{});(!P||!u.has(P))&&y.push({channel:S,fieldDef:F})}}return y},[]);let g;return s.stack!==void 0?ni(s.stack)?g=s.stack?"zero":null:g=s.stack:xm.has(i)&&(g="zero"),!g||!mm(g)||Zu(t)&&p.length===0?null:((h=s==null?void 0:s.scale)!=null&&h.type&&((m=s==null?void 0:s.scale)==null?void 0:m.type)!==le.LINEAR&&s!=null&&s.stack&&w(Gp(s.scale.type)),O(t[rt(r)])?(s.stack!==void 0&&w(qp(r)),null):(v(s)&&s.aggregate&&!Dd.has(s.aggregate)&&w(Vp(s.aggregate)),{groupbyChannels:c,groupbyFields:u,fieldChannel:r,impute:s.impute===null?!1:Ut(i),stackBy:p,offset:g}))}function $l(e,t,n){const i=ue(e),r=M("orient",i,n);if(i.orient=wm(i.type,t,r),r!==void 0&&r!==i.orient&&w(Np(i.orient,r)),i.type==="bar"&&i.orient){const c=M("cornerRadiusEnd",i,n);if(c!==void 0){const u=i.orient==="horizontal"&&t.x2||i.orient==="vertical"&&t.y2?["cornerRadius"]:Yg[i.orient];for(const l of u)i[l]=c;i.cornerRadiusEnd!==void 0&&delete i.cornerRadiusEnd}}const s=M("opacity",i,n),o=M("fillOpacity",i,n);return s===void 0&&o===void 0&&(i.opacity=$m(i.type,t)),M("cursor",i,n)===void 0&&(i.cursor=Sm(i,t,n)),i}function Sm(e,t,n){return t.href||e.href||M("href",e,n)?"pointer":e.cursor}const vl=.7;function $m(e,t){if(z([cr,eo,to,no],e)&&!Zu(t))return vl}function vm(e,t,{graticule:n}){if(n)return!1;const i=Ze("filled",e,t),r=e.type;return te(i,r!==cr&&r!==ar&&r!==zi)}function wm(e,t,n){switch(e){case cr:case to:case no:case Dg:case Mg:return}const{x:i,y:r,x2:s,y2:o}=t;switch(e){case ku:case or:if(v(i)&&(ce(i.bin)||v(r)&&r.aggregate&&!i.aggregate))return"vertical";if(v(r)&&(ce(r.bin)||v(i)&&i.aggregate&&!r.aggregate))return"horizontal";if(o||s){if(n)return n;if(!s)return(v(i)&&i.type===Qt&&!H(i.bin)||Li(i))&&v(r)&&ce(r.bin)?"horizontal":"vertical";if(!o)return(v(r)&&r.type===Qt&&!H(r.bin)||Li(r))&&v(i)&&ce(i.bin)?"vertical":"horizontal"}case zi:if(s&&!(v(i)&&ce(i.bin))&&o&&!(v(r)&&ce(r.bin)))return;case sr:if(o)return v(r)&&ce(r.bin)?"horizontal":"vertical";if(s)return v(i)&&ce(i.bin)?"vertical":"horizontal";if(e===zi){if(i&&!r)return"vertical";if(r&&!i)return"horizontal"}case ar:case eo:{const a=Ra(i),c=Ra(r);if(n)return n;if(a&&!c)return e!=="tick"?"horizontal":"vertical";if(!a&&c)return e!=="tick"?"vertical":"horizontal";if(a&&c)return"vertical";{const u=ge(i)&&i.type===En,l=ge(r)&&r.type===En;if(u&&!l)return"vertical";if(!u&&l)return"horizontal"}return}}return"vertical"}function Em(e){const{point:t,line:n,...i}=e;return b(i).length>1?i:i.type}function km(e){for(const t of["line","area","rule","trail"])e[t]&&(e={...e,[t]:Fe(e[t],["point","line"])});return e}function Ur(e,t={},n){return e.point==="transparent"?{opacity:0}:e.point?L(e.point)?e.point:{}:e.point!==void 0?null:t.point||n.shape?L(t.point)?t.point:{}:void 0}function Wa(e,t={}){return e.line?e.line===!0?{}:e.line:e.line!==void 0?null:t.line?t.line===!0?{}:t.line:void 0}class _m{constructor(){x(this,"name","path-overlay")}hasMatchingType(t,n){if(Et(t)){const{mark:i,encoding:r}=t,s=Je(i)?i:{type:i};switch(s.type){case"line":case"rule":case"trail":return!!Ur(s,n[s.type],r);case"area":return!!Ur(s,n[s.type],r)||!!Wa(s,n[s.type])}}return!1}run(t,n,i){const{config:r}=n,{params:s,projection:o,mark:a,name:c,encoding:u,...l}=t,f=hr(u,r),d=Je(a)?a:{type:a},p=Ur(d,r[d.type],f),g=d.type==="area"&&Wa(d,r[d.type]),h=[{name:c,...s?{params:s}:{},mark:Em({...d.type==="area"&&M("opacity",d,r)==null&&M("fillOpacity",d,r)==null?{opacity:vl}:{},...d}),encoding:Fe(f,["shape"])}],m=Sl($l(d,f,r),f);let y=f;if(m){const{fieldChannel:S,offset:k}=m;y={...f,[S]:{...f[S],...k?{stack:k}:{}}}}return y=Fe(y,["y2","x2"]),g&&h.push({...o?{projection:o}:{},mark:{type:"line",...Yn(d,["clip","interpolate","tension","tooltip"]),...g},encoding:y}),p&&h.push({...o?{projection:o}:{},mark:{type:"point",opacity:1,filled:!0,...Yn(d,["clip","tooltip"]),...p},encoding:y}),i({...l,layer:h},{...n,config:km(r)})}}function Cm(e,t){return t?li(e)?El(e,t):wl(e,t):e}function Br(e,t){return t?El(e,t):e}function as(e,t,n){const i=t[e];if(uh(i)){if(i.repeat in n)return{...t,[e]:n[i.repeat]};w(op(i.repeat));return}return t}function wl(e,t){if(e=as("field",e,t),e!==void 0){if(e===null)return null;if(uo(e)&&pt(e.sort)){const n=as("field",e.sort,t);e={...e,...n?{sort:n}:{}}}return e}}function Ha(e,t){if(v(e))return wl(e,t);{const n=as("datum",e,t);return n!==e&&!n.type&&(n.type="nominal"),n}}function qa(e,t){if(O(e)){const n=Ha(e,t);if(n)return n;if(fi(e))return{condition:e.condition}}else{if(di(e)){const n=Ha(e.condition,t);if(n)return{...e,condition:n};{const{condition:i,...r}=e;return r}}return e}}function El(e,t){const n={};for(const i in e)if($(e,i)){const r=e[i];if(_(r))n[i]=r.map(s=>qa(s,t)).filter(s=>s);else{const s=qa(r,t);s!==void 0&&(n[i]=s)}}return n}class Fm{constructor(){x(this,"name","RuleForRangedLine")}hasMatchingType(t){if(Et(t)){const{encoding:n,mark:i}=t;if(i==="line"||Je(i)&&i.type==="line")for(const r of wd){const s=sn(r),o=n[s];if(n[r]&&(v(o)&&!ce(o.bin)||ot(o)))return!0}}return!1}run(t,n,i){const{encoding:r,mark:s}=t;return w(Fp(!!r.x2,!!r.y2)),i({...t,mark:L(s)?{...s,type:"rule"}:"rule"},n)}}class Nm extends Eo{constructor(){super(...arguments);x(this,"nonFacetUnitNormalizers",[Oh,Rh,Uh,new _m,new Fm])}map(n,i){if(Et(n)){const r=Ht(n.encoding,ft),s=Ht(n.encoding,dt),o=Ht(n.encoding,Xi);if(r||s||o)return this.mapFacetedUnit(n,i)}return super.map(n,i)}mapUnit(n,i){const{parentEncoding:r,parentProjection:s}=i,o=Br(n.encoding,i.repeater),a={...n,...n.name?{name:[i.repeaterPrefix,n.name].filter(u=>u).join("_")}:{},...o?{encoding:o}:{}};if(r||s)return this.mapUnitWithParentEncodingOrProjection(a,i);const c=this.mapLayerOrUnit.bind(this);for(const u of this.nonFacetUnitNormalizers)if(u.hasMatchingType(a,i.config))return u.run(a,i,c);return a}mapRepeat(n,i){return gm(n)?this.mapLayerRepeat(n,i):this.mapNonLayerRepeat(n,i)}mapLayerRepeat(n,i){const{repeat:r,spec:s,...o}=n,{row:a,column:c,layer:u}=r,{repeater:l={},repeaterPrefix:f=""}=i;return a||c?this.mapRepeat({...n,repeat:{...a?{row:a}:{},...c?{column:c}:{}},spec:{repeat:{layer:u},spec:s}},i):{...o,layer:u.map(d=>{const p={...l,layer:d},g=`${(s.name?`${s.name}_`:"")+f}child__layer_${K(d)}`,h=this.mapLayerOrUnit(s,{...i,repeater:p,repeaterPrefix:g});return h.name=g,h})}}mapNonLayerRepeat(n,i){const{repeat:r,spec:s,data:o,...a}=n;!_(r)&&n.columns&&(n=Fe(n,["columns"]),w(Ea("repeat")));const c=[],{repeater:u={},repeaterPrefix:l=""}=i,f=!_(r)&&r.row||[u?u.row:null],d=!_(r)&&r.column||[u?u.column:null],p=_(r)&&r||[u?u.repeat:null];for(const h of p)for(const m of f)for(const y of d){const S={repeat:h,row:m,column:y,layer:u.layer},k=`${(s.name?`${s.name}_`:"")+l}child__${_(r)?`${K(h)}`:(r.row?`row_${K(m)}`:"")+(r.column?`column_${K(y)}`:"")}`,A=this.map(s,{...i,repeater:S,repeaterPrefix:k});A.name=k,c.push(Fe(A,["data"]))}const g=_(r)?n.columns:r.column?r.column.length:1;return{data:s.data??o,align:"all",...a,columns:g,concat:c}}mapFacet(n,i){const{facet:r}=n;return li(r)&&n.columns&&(n=Fe(n,["columns"]),w(Ea("facet"))),super.mapFacet(n,i)}mapUnitWithParentEncodingOrProjection(n,i){const{encoding:r,projection:s}=n,{parentEncoding:o,parentProjection:a,config:c}=i,u=Va({parentProjection:a,projection:s}),l=Ga({parentEncoding:o,encoding:Br(r,i.repeater)});return this.mapUnit({...n,...u?{projection:u}:{},...l?{encoding:l}:{}},{config:c})}mapFacetedUnit(n,i){const{row:r,column:s,facet:o,...a}=n.encoding,{mark:c,width:u,projection:l,height:f,view:d,params:p,encoding:g,...h}=n,{facetMapping:m,layout:y}=this.getFacetMappingAndLayout({row:r,column:s,facet:o},i),S=Br(a,i.repeater);return this.mapFacet({...h,...y,facet:m,spec:{...u?{width:u}:{},...f?{height:f}:{},...d?{view:d}:{},...l?{projection:l}:{},mark:c,encoding:S,...p?{params:p}:{}}},i)}getFacetMappingAndLayout(n,i){const{row:r,column:s,facet:o}=n;if(r||s){o&&w(_p([...r?[ft]:[],...s?[dt]:[]]));const a={},c={};for(const u of[ft,dt]){const l=n[u];if(l){const{align:f,center:d,spacing:p,columns:g,...h}=l;a[u]=h;for(const m of["align","center","spacing"])l[m]!==void 0&&(c[m]??(c[m]={}),c[m][u]=l[m])}}return{facetMapping:a,layout:c}}else{const{align:a,center:c,spacing:u,columns:l,...f}=o;return{facetMapping:Cm(f,i.repeater),layout:{...a?{align:a}:{},...c?{center:c}:{},...u?{spacing:u}:{},...l?{columns:l}:{}}}}}mapLayer(n,{parentEncoding:i,parentProjection:r,...s}){const{encoding:o,projection:a,...c}=n,u={...s,parentEncoding:Ga({parentEncoding:i,encoding:o,layer:!0}),parentProjection:Va({parentProjection:r,projection:a})};return super.mapLayer({...c,...n.name?{name:[u.repeaterPrefix,n.name].filter(l=>l).join("_")}:{}},u)}}function Ga({parentEncoding:e,encoding:t={},layer:n}){let i={};if(e){const r=new Set([...b(e),...b(t)]);for(const s of r){const o=t[s],a=e[s];if(O(o)){const c={...a,...o};i[s]=c}else di(o)?i[s]={...o,condition:{...a,...o.condition}}:o||o===null?i[s]=o:(n||Me(a)||C(a)||O(a)||_(a))&&(i[s]=a)}}else i=t;return!i||W(i)?void 0:i}function Va(e){const{parentProjection:t,projection:n}=e;return t&&n&&w(hp({parentProjection:t,projection:n})),n??t}function ko(e){return $(e,"filter")}function Tm(e){return $(e,"stop")}function kl(e){return $(e,"lookup")}function Om(e){return $(e,"data")}function Am(e){return $(e,"param")}function Pm(e){return $(e,"pivot")}function Rm(e){return $(e,"density")}function zm(e){return $(e,"quantile")}function Im(e){return $(e,"regression")}function Lm(e){return $(e,"loess")}function Mm(e){return $(e,"sample")}function Dm(e){return $(e,"window")}function jm(e){return $(e,"joinaggregate")}function Um(e){return $(e,"flatten")}function Bm(e){return $(e,"calculate")}function _l(e){return $(e,"bin")}function Wm(e){return $(e,"impute")}function Hm(e){return $(e,"timeUnit")}function qm(e){return $(e,"aggregate")}function Gm(e){return $(e,"stack")}function Vm(e){return $(e,"fold")}function Xm(e){return $(e,"extent")&&!$(e,"density")&&!$(e,"regression")}function Ym(e){return e.map(t=>ko(t)?{filter:mn(t.filter,$g)}:t)}class Km extends Eo{map(t,n){return n.emptySelections??(n.emptySelections={}),n.selectionPredicates??(n.selectionPredicates={}),t=Xa(t,n),super.map(t,n)}mapLayerOrUnit(t,n){if(t=Xa(t,n),t.encoding){const i={};for(const[r,s]of Vt(t.encoding))i[r]=Cl(s,n);t={...t,encoding:i}}return super.mapLayerOrUnit(t,n)}mapUnit(t,n){const{selection:i,...r}=t;return i?{...r,params:Vt(i).map(([s,o])=>{const{init:a,bind:c,empty:u,...l}=o;l.type==="single"?(l.type="point",l.toggle=!1):l.type==="multi"&&(l.type="point"),n.emptySelections[s]=u!=="none";for(const f of ie(n.selectionPredicates[s]??{}))f.empty=u!=="none";return{name:s,value:a,select:l,bind:c}})}:t}}function Xa(e,t){const{transform:n,...i}=e;if(n){const r=n.map(s=>{if(ko(s))return{filter:cs(s,t)};if(_l(s)&&on(s.bin))return{...s,bin:Fl(s.bin)};if(kl(s)){const{selection:o,...a}=s.from;return o?{...s,from:{param:o,...a}}:s}return s});return{...i,transform:r}}return e}function Cl(e,t){var i,r;const n=N(e);if(v(n)&&on(n.bin)&&(n.bin=Fl(n.bin)),ln(n)&&((r=(i=n.scale)==null?void 0:i.domain)!=null&&r.selection)){const{selection:s,...o}=n.scale.domain;n.scale.domain={...o,...s?{param:s}:{}}}if(fi(n))if(_(n.condition))n.condition=n.condition.map(s=>{const{selection:o,param:a,test:c,...u}=s;return a?s:{...u,test:cs(s,t)}});else{const{selection:s,param:o,test:a,...c}=Cl(n.condition,t);n.condition=o?n.condition:{...c,test:cs(n.condition,t)}}return n}function Fl(e){const t=e.extent;if(t!=null&&t.selection){const{selection:n,...i}=t;return{...e,extent:{...i,param:n}}}return e}function cs(e,t){const n=i=>mn(i,r=>{var a;const s=t.emptySelections[r]??!0,o={param:r,empty:s};return(a=t.selectionPredicates)[r]??(a[r]=[]),t.selectionPredicates[r].push(o),o});return e.selection?n(e.selection):mn(e.test||e.filter,i=>i.selection?n(i.selection):i)}class us extends Eo{map(t,n){const i=n.selections??[];if(t.params&&!Et(t)){const r=[];for(const s of t.params)$o(s)?i.push(s):r.push(s);t.params=r}return n.selections=i,super.map(t,n)}mapUnit(t,n){const i=n.selections;if(!i||!i.length)return t;const r=(n.path??[]).concat(t.name),s=[];for(const o of i)if(!o.views||!o.views.length)s.push(o);else for(const a of o.views)(T(a)&&(a===t.name||r.includes(a))||_(a)&&a.map(c=>r.indexOf(c)).every((c,u,l)=>c!==-1&&(u===0||c>l[u-1])))&&s.push(o);return s.length&&(t.params=s),t}}for(const e of["mapFacet","mapRepeat","mapHConcat","mapVConcat","mapLayer"]){const t=us.prototype[e];us.prototype[e]=function(n,i){return t.call(this,n,Qm(n,i))}}function Qm(e,t){return e.name?{...t,path:(t.path??[]).concat(e.name)}:t}function Zm(e,t){t===void 0&&(t=bl(e.config));const n=ny(e,t),{width:i,height:r}=e,s=iy(n,{width:i,height:r,autosize:e.autosize},t);return{...n,...s?{autosize:s}:{}}}const Jm=new Nm,ey=new Km,ty=new us;function ny(e,t={}){const n={config:t};return ty.map(Jm.map(ey.map(e,n),n),n)}function Ya(e){return T(e)?{type:e}:e??{}}function iy(e,t,n){let{width:i,height:r}=t;const s=Et(e)||yr(e),o={};s?i=="container"&&r=="container"?(o.type="fit",o.contains="padding"):i=="container"?(o.type="fit-x",o.contains="padding"):r=="container"&&(o.type="fit-y",o.contains="padding"):(i=="container"&&(w(Sa("width")),i=void 0),r=="container"&&(w(Sa("height")),r=void 0));const a={type:"pad",...o,...n?Ya(n.autosize):{},...Ya(e.autosize)};if(a.type==="fit"&&!s&&(w(Yd),a.type="pad"),i=="container"&&!(a.type=="fit"||a.type=="fit-x")&&w($a("width")),r=="container"&&!(a.type=="fit"||a.type=="fit-y")&&w($a("height")),!_e(a,{type:"pad"}))return a}function ry(e){return["fit","fit-x","fit-y"].includes(e)}function sy(e){return e?`fit-${Ji(e)}`:"fit"}const oy=["background","padding"];function Ka(e,t){const n={};for(const i of oy)e&&e[i]!==void 0&&(n[i]=Ee(e[i]));return t&&(n.params=e.params),n}class kt{constructor(t={},n={}){x(this,"explicit");x(this,"implicit");this.explicit=t,this.implicit=n}clone(){return new kt(N(this.explicit),N(this.implicit))}combine(){return{...this.explicit,...this.implicit}}get(t){return te(this.explicit[t],this.implicit[t])}getWithExplicit(t){return this.explicit[t]!==void 0?{explicit:!0,value:this.explicit[t]}:this.implicit[t]!==void 0?{explicit:!1,value:this.implicit[t]}:{explicit:!1,value:void 0}}setWithExplicit(t,{value:n,explicit:i}){n!==void 0&&this.set(t,n,i)}set(t,n,i){return delete this[i?"implicit":"explicit"][t],this[i?"explicit":"implicit"][t]=n,this}copyKeyFromSplit(t,{explicit:n,implicit:i}){n[t]!==void 0?this.set(t,n[t],!0):i[t]!==void 0&&this.set(t,i[t],!1)}copyKeyFromObject(t,n){n[t]!==void 0&&this.set(t,n[t],!0)}copyAll(t){for(const n of b(t.combine())){const i=t.getWithExplicit(n);this.setWithExplicit(n,i)}}}function Ve(e){return{explicit:!0,value:e}}function we(e){return{explicit:!1,value:e}}function Nl(e){return(t,n,i,r)=>{const s=e(t.value,n.value);return s>0?t:s<0?n:xr(t,n,i,r)}}function xr(e,t,n,i){return e.explicit&&t.explicit&&w(Mp(n,i,e.value,t.value)),e}function At(e,t,n,i,r=xr){return e===void 0||e.value===void 0?t:e.explicit&&!t.explicit?e:t.explicit&&!e.explicit?t:_e(e.value,t.value)?e:r(e,t,n,i)}class ay extends kt{constructor(n={},i={},r=!1){super(n,i);x(this,"explicit");x(this,"implicit");x(this,"parseNothing");this.explicit=n,this.implicit=i,this.parseNothing=r}clone(){const n=super.clone();return n.parseNothing=this.parseNothing,n}}function Nn(e){return $(e,"url")}function Jn(e){return $(e,"values")}function Tl(e){return $(e,"name")&&!Nn(e)&&!Jn(e)&&!Nt(e)}function Nt(e){return e&&(Ol(e)||Al(e)||_o(e))}function Ol(e){return $(e,"sequence")}function Al(e){return $(e,"sphere")}function _o(e){return $(e,"graticule")}var Q;(function(e){e[e.Raw=0]="Raw",e[e.Main=1]="Main",e[e.Row=2]="Row",e[e.Column=3]="Column",e[e.Lookup=4]="Lookup",e[e.PreFilterInvalid=5]="PreFilterInvalid",e[e.PostFilterInvalid=6]="PostFilterInvalid"})(Q||(Q={}));function Pl({invalid:e,isPath:t}){switch(Fu(e,{isPath:t})){case"filter":return{marks:"exclude-invalid-values",scales:"exclude-invalid-values"};case"break-paths-show-domains":return{marks:t?"include-invalid-values":"exclude-invalid-values",scales:"include-invalid-values"};case"break-paths-filter-domains":return{marks:t?"include-invalid-values":"exclude-invalid-values",scales:"exclude-invalid-values"};case"show":return{marks:"include-invalid-values",scales:"include-invalid-values"}}}function cy(e){const{marks:t,scales:n}=Pl(e);return t===n?Q.Main:n==="include-invalid-values"?Q.PreFilterInvalid:Q.PostFilterInvalid}class j{constructor(t,n){x(this,"debugName");x(this,"_children",[]);x(this,"_parent",null);x(this,"_hash");this.debugName=n,t&&(this.parent=t)}clone(){throw new Error("Cannot clone node")}get parent(){return this._parent}set parent(t){this._parent=t,t&&t.addChild(this)}get children(){return this._children}numChildren(){return this._children.length}addChild(t,n){if(this._children.includes(t)){w(dp);return}n!==void 0?this._children.splice(n,0,t):this._children.push(t)}removeChild(t){const n=this._children.indexOf(t);return this._children.splice(n,1),n}remove(){let t=this._parent.removeChild(this);for(const n of this._children)n._parent=this._parent,this._parent.addChild(n,t++)}insertAsParentOf(t){const n=t.parent;n.removeChild(this),this.parent=n,t.parent=this}swapWithParent(){const t=this._parent,n=t.parent;for(const r of this._children)r.parent=t;this._children=[],t.removeChild(this);const i=t.parent.removeChild(t);this._parent=n,n.addChild(this,i),t.parent=this}}class ye extends j{constructor(n,i,r,s){super(n,i);x(this,"type");x(this,"refCounts");x(this,"_source");x(this,"_name");this.type=r,this.refCounts=s,this._source=this._name=i,this.refCounts&&!(this._name in this.refCounts)&&(this.refCounts[this._name]=0)}clone(){const n=new this.constructor;return n.debugName=`clone_${this.debugName}`,n._source=this._source,n._name=`clone_${this._name}`,n.type=this.type,n.refCounts=this.refCounts,n.refCounts[n._name]=0,n}dependentFields(){return new Set}producedFields(){return new Set}hash(){return this._hash===void 0&&(this._hash=`Output ${gd()}`),this._hash}getSource(){return this.refCounts[this._name]++,this._source}isRequired(){return!!this.refCounts[this._name]}setSource(n){this._source=n}}function Wr(e){return e.as!==void 0}function Qa(e){return`${e}_end`}class Ye extends j{constructor(n,i){super(n);x(this,"timeUnits");this.timeUnits=i}clone(){return new Ye(null,N(this.timeUnits))}static makeFromEncoding(n,i){const r=i.reduceFieldDef((s,o,a)=>{const{field:c,timeUnit:u}=o;if(u){let l;if(un(u)){if(Y(i)){const{mark:f,markDef:d,config:p}=i,g=Ot({fieldDef:o,markDef:d,config:p});(Zn(f)||g)&&(l={timeUnit:se(u),field:c})}}else l={as:E(o,{forAs:!0}),field:c,timeUnit:u};if(Y(i)){const{mark:f,markDef:d,config:p}=i,g=Ot({fieldDef:o,markDef:d,config:p});Zn(f)&&ee(a)&&g!==.5&&(l.rectBandPosition=g)}l&&(s[I(l)]=l)}return s},{});return W(r)?null:new Ye(n,r)}static makeFromTransform(n,i){const{timeUnit:r,...s}={...i},o=se(r),a={...s,timeUnit:o};return new Ye(n,{[I(a)]:a})}merge(n){this.timeUnits={...this.timeUnits};for(const i in n.timeUnits)this.timeUnits[i]||(this.timeUnits[i]=n.timeUnits[i]);for(const i of n.children)n.removeChild(i),i.parent=this;n.remove()}removeFormulas(n){const i={};for(const[r,s]of Vt(this.timeUnits)){const o=Wr(s)?s.as:`${s.field}_end`;n.has(o)||(i[r]=s)}this.timeUnits=i}producedFields(){return new Set(ie(this.timeUnits).map(n=>Wr(n)?n.as:Qa(n.field)))}dependentFields(){return new Set(ie(this.timeUnits).map(n=>n.field))}hash(){return`TimeUnit ${I(this.timeUnits)}`}assemble(){const n=[];for(const i of ie(this.timeUnits)){const{rectBandPosition:r}=i,s=se(i.timeUnit);if(Wr(i)){const{field:o,as:a}=i,{unit:c,utc:u,...l}=s,f=[a,`${a}_end`];n.push({field:Ie(o),type:"timeunit",...c?{units:ir(c)}:{},...u?{timezone:"utc"}:{},...l,as:f}),n.push(...Za(f,r,s))}else if(i){const{field:o}=i,a=dd(o),c=Rl({timeUnit:s,field:a}),u=Qa(a);n.push({type:"formula",expr:c,as:u}),n.push(...Za([a,u],r,s))}}return n}}const br="offsetted_rect_start",Sr="offsetted_rect_end";function Rl({timeUnit:e,field:t,reverse:n}){const{unit:i,utc:r}=e,s=fu(i),{part:o,step:a}=hu(s,e.step);return`${r?"utcOffset":"timeOffset"}('${o}', ${U(t)}, ${n?-a:a})`}function Za([e,t],n,i){if(n!==void 0&&n!==.5){const r=U(e),s=U(t);return[{type:"formula",expr:Ja([Rl({timeUnit:i,field:e,reverse:!0}),r],n+.5),as:`${e}_${br}`},{type:"formula",expr:Ja([r,s],n+.5),as:`${e}_${Sr}`}]}return[]}function Ja([e,t],n){return`${1-n} * ${e} + ${n} * ${t}`}const hi="_tuple_fields";class uy{constructor(...t){x(this,"hasChannel");x(this,"hasField");x(this,"hasSelectionId");x(this,"timeUnit");x(this,"items");this.items=t,this.hasChannel={},this.hasField={},this.hasSelectionId=!1}}const ly={defined:()=>!0,parse:(e,t,n)=>{const i=t.name,r=t.project??(t.project=new uy),s={},o={},a=new Set,c=(g,h)=>{const m=h==="visual"?g.channel:g.field;let y=K(`${i}_${m}`);for(let S=1;a.has(y);S++)y=K(`${i}_${m}_${S}`);return a.add(y),{[h]:y}},u=t.type,l=e.config.selection[u],f=n.value!==void 0?J(n.value):null;let{fields:d,encodings:p}=L(n.select)?n.select:{};if(!d&&!p&&f){for(const g of f)if(L(g))for(const h of b(g))vd(h)?(p||(p=[])).push(h):u==="interval"?(w(sp),p=l.encodings):(d??(d=[])).push(h)}!d&&!p&&(p=l.encodings,"fields"in l&&(d=l.fields));for(const g of p??[]){const h=e.fieldDef(g);if(h){let m=h.field;if(h.aggregate){w(Kd(g,h.aggregate));continue}else if(!m){w(wa(g));continue}if(h.timeUnit&&!un(h.timeUnit)){m=e.vgField(g);const y={timeUnit:h.timeUnit,as:m,field:h.field};o[I(y)]=y}if(!s[m]){const y=u==="interval"&&st(g)&&Le(e.getScaleComponent(g).get("type"))?"R":h.bin?"R-RE":"E",S={field:m,channel:g,type:y,index:r.items.length};S.signals={...c(S,"data"),...c(S,"visual")},r.items.push(s[m]=S),r.hasField[m]=s[m],r.hasSelectionId=r.hasSelectionId||m===je,Ic(g)?(S.geoChannel=g,S.channel=zc(g),r.hasChannel[S.channel]=s[m]):r.hasChannel[g]=s[m]}}else w(wa(g))}for(const g of d??[]){if(r.hasField[g])continue;const h={type:"E",field:g,index:r.items.length};h.signals={...c(h,"data")},r.items.push(h),r.hasField[g]=h,r.hasSelectionId=r.hasSelectionId||g===je}f&&(t.init=f.map(g=>r.items.map(h=>L(g)?g[h.geoChannel||h.channel]!==void 0?g[h.geoChannel||h.channel]:g[h.field]:g))),W(o)||(r.timeUnit=new Ye(null,o))},signals:(e,t,n)=>{const i=t.name+hi;return n.filter(s=>s.name===i).length>0||t.project.hasSelectionId?n:n.concat({name:i,value:t.project.items.map(Ml)})}},zl="_curr",Oi="anim_value",hn="anim_clock",ls="eased_anim_clock",Il="min_extent",Ll="max_range_extent",Hr="last_tick_at",qr="is_playing",fy=1/60*1e3,dy=(e,t)=>[{name:ls,update:hn},{name:`${e}_domain`,init:`domain('${t}')`},{name:Il,init:`extent(${e}_domain)[0]`},{name:Ll,init:`extent(range('${t}'))[1]`},{name:Oi,update:`invert('${t}', ${ls})`}],py={defined:e=>e.type==="point",topLevelSignals:(e,t,n)=>(Ke(t)&&(n=n.concat([{name:hn,init:"0",on:[{events:{type:"timer",throttle:fy},update:`${qr} ? (${hn} + (now() - ${Hr}) > ${Ll} ? 0 : ${hn} + (now() - ${Hr})) : ${hn}`}]},{name:Hr,init:"now()",on:[{events:[{signal:hn},{signal:qr}],update:"now()"}]},{name:qr,init:"true"}])),n),signals:(e,t,n)=>{const i=t.name,r=i+hi,s=t.project,o="(item().isVoronoi ? datum.datum : datum)",a=ie(e.component.selection??{}).reduce((l,f)=>f.type==="interval"?l.concat(f.name+bn):l,[]).map(l=>`indexof(item().mark.name, '${l}') < 0`).join(" && "),c=`datum && item().mark.marktype !== 'group' && indexof(item().mark.role, 'legend') < 0${a?` && ${a}`:""}`;let u=`unit: ${qt(e)}, `;if(t.project.hasSelectionId)u+=`${je}: ${o}[${R(je)}]`;else if(Ke(t))u+=`fields: ${r}, values: [${Oi} ? ${Oi} : ${Il}]`;else{const l=s.items.map(f=>{const d=e.fieldDef(f.channel);return d!=null&&d.bin?`[${o}[${R(e.vgField(f.channel,{}))}], ${o}[${R(e.vgField(f.channel,{binSuffix:"end"}))}]]`:`${o}[${R(f.field)}]`}).join(", ");u+=`fields: ${r}, values: [${l}]`}if(Ke(t))return n.concat(dy(t.name,e.scaleName(zt)),[{name:i+xt,on:[{events:[{signal:ls},{signal:Oi}],update:`{${u}}`,force:!0}]}]);{const l=t.events;return n.concat([{name:i+xt,on:l?[{events:l,update:`${c} ? {${u}} : null`,force:!0}]:[]}])}}};function Ml(e){const{signals:t,hasLegend:n,index:i,...r}=e;return r.field=Ie(r.field),r}function en(e,t=!0,n=nd){if(_(e)){const i=e.map(r=>en(r,t,n));return t?`[${i.join(", ")}]`:i}else if(cn(e))return n(t?Kt(e):ug(e));return t?n(D(e)):e}function gy(e,t){for(const n of ie(e.component.selection??{})){const i=n.name;let r=`${i}${xt}, ${n.resolve==="global"?"true":`{unit: ${qt(e)}}`}`;for(const s of $r)s.defined(n)&&(s.signals&&(t=s.signals(e,n,t)),s.modifyExpr&&(r=s.modifyExpr(e,n,r)));t.push({name:i+Uy,on:[{events:{signal:n.name+xt},update:`modify(${R(n.name+tn)}, ${r})`}]})}return Co(t)}function hy(e,t){if(e.component.selection&&b(e.component.selection).length){const n=R(e.getName("cell"));t.unshift({name:"facet",value:{},on:[{events:In("pointermove","scope"),update:`isTuple(facet) ? facet : group(${n}).datum`}]})}return Co(t)}function my(e,t){let n=!1;for(const i of ie(e.component.selection??{})){const r=i.name,s=R(r+tn);if(t.filter(a=>a.name===r).length===0){const a=i.resolve==="global"?"union":i.resolve,c=i.type==="point"?", true, true)":")";t.push({name:i.name,update:`${nf}(${s}, ${R(a)}${c}`})}n=!0;for(const a of $r)a.defined(i)&&a.topLevelSignals&&(t=a.topLevelSignals(e,i,t))}return n&&t.filter(r=>r.name==="unit").length===0&&t.unshift({name:"unit",value:{},on:[{events:"pointermove",update:"isTuple(group()) ? group() : unit"}]}),Co(t)}function yy(e,t){const n=[],i=[],r=qt(e,{escape:!1});for(const s of ie(e.component.selection??{})){const o={name:s.name+tn};if(s.project.hasSelectionId&&(o.transform=[{type:"collect",sort:{field:je}}]),s.init){const c=s.project.items.map(Ml);o.values=s.project.hasSelectionId?s.init.map(u=>({unit:r,[je]:en(u,!1)[0]})):s.init.map(u=>({unit:r,fields:c,values:en(u,!1)}))}if([...n,...t].filter(c=>c.name===s.name+tn).length||n.push(o),Ke(s)&&t.length){const c=e.lookupDataSource(e.getDataName(Q.Main)),u=t.find(f=>f.name===c),l=u.transform.find(f=>f.type==="filter"&&f.expr.includes("vlSelectionTest"));if(l){u.transform=u.transform.filter(d=>d!==l);const f={name:u.name+zl,source:u.name,transform:[l]};i.push(f)}}}return n.concat(t,i)}function Dl(e,t){for(const n of ie(e.component.selection??{}))for(const i of $r)i.defined(n)&&i.marks&&(t=i.marks(e,n,t));return t}function xy(e,t){for(const n of e.children)Y(n)&&(t=Dl(n,t));return t}function by(e,t,n,i){const r=cf(e,t.param,t);return{signal:Le(n.get("type"))&&_(i)&&i[0]>i[1]?`isValid(${r}) && reverse(${r})`:r}}function Co(e){return e.map(t=>(t.on&&!t.on.length&&delete t.on,t))}const gt={defined:e=>e.type==="interval"&&e.resolve==="global"&&e.bind&&e.bind==="scales",parse:(e,t)=>{const n=t.scales=[];for(const i of t.project.items){const r=i.channel;if(!st(r))continue;const s=e.getScaleComponent(r),o=s?s.get("type"):void 0;if(o=="sequential"&&w(ep),!s||!Le(o)){w(Jd);continue}s.set("selectionExtent",{param:t.name,field:i.field},!0),n.push(i)}},topLevelSignals:(e,t,n)=>{const i=t.scales.filter(o=>n.filter(a=>a.name===o.signals.data).length===0);if(!e.parent||ds(e)||i.length===0)return n;const r=n.find(o=>o.name===t.name);let s=r.update;if(s.includes(nf))r.update=`{${i.map(o=>`${R(Ie(o.field))}: ${o.signals.data}`).join(", ")}}`;else{for(const o of i){const a=`${R(Ie(o.field))}: ${o.signals.data}`;s.includes(a)||(s=`${s.substring(0,s.length-1)}, ${a}}`)}r.update=s}return n.concat(i.map(o=>({name:o.signals.data})))},signals:(e,t,n)=>{if(e.parent&&!ds(e))for(const i of t.scales){const r=n.find(s=>s.name===i.signals.data);r.push="outer",delete r.value,delete r.update}return n}};function fs(e,t){return`domain(${R(e.scaleName(t))})`}function ds(e){return e.parent&&Wn(e.parent)&&(!e.parent.parent||ds(e.parent.parent))}const bn="_brush",jl="_scale_trigger",qn="geo_interval_init_tick",Ul="_init",Sy="_center",$y={defined:e=>e.type==="interval",parse:(e,t,n)=>{var i;if(e.hasProjection){const r={...L(n.select)?n.select:{}};r.fields=[je],r.encodings||(r.encodings=n.value?b(n.value):[He,We]),n.select={type:"interval",...r}}if(t.translate&&!gt.defined(t)){const r=`!event.item || event.item.mark.name !== ${R(t.name+bn)}`;for(const s of t.events){if(!s.between){w(`${s} is not an ordered event stream for interval selections.`);continue}const o=J((i=s.between[0]).filter??(i.filter=[]));o.includes(r)||o.push(r)}}},signals:(e,t,n)=>{const i=t.name,r=i+xt,s=ie(t.project.hasChannel).filter(a=>a.channel===V||a.channel===ae),o=t.init?t.init[0]:null;if(n.push(...s.reduce((a,c)=>a.concat(vy(e,t,c,o==null?void 0:o[c.index])),[])),e.hasProjection){const a=R(e.projectionName()),c=e.projectionName()+Sy,{x:u,y:l}=t.project.hasChannel,f=u==null?void 0:u.signals.visual,d=l==null?void 0:l.signals.visual,p=u?o==null?void 0:o[u.index]:`${c}[0]`,g=l?o==null?void 0:o[l.index]:`${c}[1]`,h=F=>e.getSizeSignalRef(F).signal,m=`[[${f?`${f}[0]`:"0"}, ${d?`${d}[0]`:"0"}],[${f?`${f}[1]`:h("width")}, ${d?`${d}[1]`:h("height")}]]`;o&&(n.unshift({name:i+Ul,init:`[scale(${a}, [${u?p[0]:p}, ${l?g[0]:g}]), scale(${a}, [${u?p[1]:p}, ${l?g[1]:g}])]`}),(!u||!l)&&(n.find(P=>P.name===c)||n.unshift({name:c,update:`invert(${a}, [${h("width")}/2, ${h("height")}/2])`})));const y=`intersect(${m}, {markname: ${R(e.getName("marks"))}}, unit.mark)`,S=`{unit: ${qt(e)}}`,k=`vlSelectionTuples(${y}, ${S})`,A=s.map(F=>F.signals.visual);return n.concat({name:r,on:[{events:[...A.length?[{signal:A.join(" || ")}]:[],...o?[{signal:qn}]:[]],update:k}]})}else{if(!gt.defined(t)){const u=i+jl,l=s.map(f=>{const d=f.channel,{data:p,visual:g}=f.signals,h=R(e.scaleName(d)),m=e.getScaleComponent(d).get("type"),y=Le(m)?"+":"";return`(!isArray(${p}) || (${y}invert(${h}, ${g})[0] === ${y}${p}[0] && ${y}invert(${h}, ${g})[1] === ${y}${p}[1]))`});l.length&&n.push({name:u,value:{},on:[{events:s.map(f=>({scale:e.scaleName(f.channel)})),update:`${l.join(" && ")} ? ${u} : {}`}]})}const a=s.map(u=>u.signals.data),c=`unit: ${qt(e)}, fields: ${i+hi}, values`;return n.concat({name:r,...o?{init:`{${c}: ${en(o)}}`}:{},...a.length?{on:[{events:[{signal:a.join(" || ")}],update:`${a.join(" && ")} ? {${c}: [${a}]} : null`}]}:{}})}},topLevelSignals:(e,t,n)=>(Y(e)&&e.hasProjection&&t.init&&(n.filter(r=>r.name===qn).length||n.unshift({name:qn,value:null,on:[{events:"timer{1}",update:`${qn} === null ? {} : ${qn}`}]})),n),marks:(e,t,n)=>{const i=t.name,{x:r,y:s}=t.project.hasChannel,o=r==null?void 0:r.signals.visual,a=s==null?void 0:s.signals.visual,c=`data(${R(t.name+tn)})`;if(gt.defined(t)||!r&&!s)return n;const u={x:r!==void 0?{signal:`${o}[0]`}:{value:0},y:s!==void 0?{signal:`${a}[0]`}:{value:0},x2:r!==void 0?{signal:`${o}[1]`}:{field:{group:"width"}},y2:s!==void 0?{signal:`${a}[1]`}:{field:{group:"height"}}};if(t.resolve==="global")for(const m of b(u))u[m]=[{test:`${c}.length && ${c}[0].unit === ${qt(e)}`,...u[m]},{value:0}];const{fill:l,fillOpacity:f,cursor:d,...p}=t.mark,g=b(p).reduce((m,y)=>(m[y]=[{test:[r!==void 0&&`${o}[0] !== ${o}[1]`,s!==void 0&&`${a}[0] !== ${a}[1]`].filter(S=>S).join(" && "),value:p[y]},{value:null}],m),{}),h=d??(t.translate?"move":null);return[{name:`${i+bn}_bg`,type:"rect",clip:!0,encode:{enter:{fill:{value:l},fillOpacity:{value:f}},update:u}},...n,{name:i+bn,type:"rect",clip:!0,encode:{enter:{...h?{cursor:{value:h}}:{},fill:{value:"transparent"}},update:{...u,...g}}}]}};function vy(e,t,n,i){const r=!e.hasProjection,s=n.channel,o=n.signals.visual,a=R(r?e.scaleName(s):e.projectionName()),c=d=>`scale(${a}, ${d})`,u=e.getSizeSignalRef(s===V?"width":"height").signal,l=`${s}(unit)`,f=t.events.reduce((d,p)=>[...d,{events:p.between[0],update:`[${l}, ${l}]`},{events:p,update:`[${o}[0], clamp(${l}, 0, ${u})]`}],[]);if(r){const d=n.signals.data,p=gt.defined(t),g=e.getScaleComponent(s),h=g?g.get("type"):void 0,m=i?{init:en(i,!0,c)}:{value:[]};return f.push({events:{signal:t.name+jl},update:Le(h)?`[${c(`${d}[0]`)}, ${c(`${d}[1]`)}]`:"[0, 0]"}),p?[{name:d,on:[]}]:[{name:o,...m,on:f},{name:d,...i?{init:en(i)}:{},on:[{events:{signal:o},update:`${o}[0] === ${o}[1] ? null : invert(${a}, ${o})`}]}]}else{const d=s===V?0:1,p=t.name+Ul,g=i?{init:`[${p}[0][${d}], ${p}[1][${d}]]`}:{value:[]};return[{name:o,...g,on:f}]}}function Dn({model:e,channelDef:t,vgChannel:n,invalidValueRef:i,mainRefFn:r}){const s=fi(t)&&t.condition;let o=[];s&&(o=J(s).map(u=>{const l=r(u);if(ch(u)){const{param:f,empty:d}=u;return{test:af(e,{param:f,empty:d}),...l}}else return{test:qi(e,u.test),...l}})),i!==void 0&&o.push(i);const a=r(t);return a!==void 0&&o.push(a),o.length>1||o.length===1&&o[0].test?{[n]:o}:o.length===1?{[n]:o[0]}:{}}function Fo(e,t="text"){const n=e.encoding[t];return Dn({model:e,channelDef:n,vgChannel:t,mainRefFn:i=>No(i,e.config),invalidValueRef:void 0})}function No(e,t,n="datum"){if(e){if(Me(e))return q(e.value);if(O(e)){const{format:i,formatType:r}=Di(e);return ao({fieldOrDatumDef:e,format:i,formatType:r,expr:n,config:t})}}}function Bl(e,t={}){const{encoding:n,markDef:i,config:r,stack:s}=e,o=n.tooltip;if(_(o))return{tooltip:ec({tooltip:o},s,r,t)};{const a=t.reactiveGeom?"datum.datum":"datum";return Dn({model:e,channelDef:o,vgChannel:"tooltip",mainRefFn:u=>{const l=Hl(u,r,a);if(l)return l;if(u===null)return;let f=M("tooltip",i,r);if(f===!0&&(f={content:"encoding"}),T(f))return{value:f};if(L(f))return C(f)?f:f.content==="encoding"?ec(n,s,r,t):{signal:a}},invalidValueRef:void 0})}}function Wl(e,t,n,{reactiveGeom:i}={}){const r={...n,...n.tooltipFormat},s=new Set,o=i?"datum.datum":"datum",a=[];function c(l,f){const d=sn(f),p=ge(l)?l:{...l,type:e[d].type},g=p.title||fo(p,r),h=J(g).join(", ").replaceAll(/"/g,'\\"');let m;if(ee(f)){const y=f==="x"?"x2":"y2",S=De(e[y]);if(ce(p.bin)&&S){const k=E(p,{expr:o}),A=E(S,{expr:o}),{format:F,formatType:P}=Di(p);m=ui(k,A,F,P,r),s.add(y)}}if((ee(f)||f===Te||f===Be)&&t&&t.fieldChannel===f&&t.offset==="normalize"){const{format:y,formatType:S}=Di(p);m=ao({fieldOrDatumDef:p,format:y,formatType:S,expr:o,config:r,normalizeStack:!0}).signal}m??(m=Hl(p,r,o).signal),a.push({channel:f,key:h,value:m})}go(e,(l,f)=>{v(l)?c(l,f):fr(l)&&c(l.condition,f)});const u={};for(const{channel:l,key:f,value:d}of a)!s.has(l)&&!u[f]&&(u[f]=d);return u}function ec(e,t,n,{reactiveGeom:i}={}){const r=Wl(e,t,n,{reactiveGeom:i}),s=Vt(r).map(([o,a])=>`"${o}": ${a}`);return s.length>0?{signal:`{${s.join(", ")}}`}:void 0}function Hl(e,t,n="datum"){if(v(e)&&Qs(e.type)&&!$(e,"format")){const i=`datum["${e.field}"]`;return{signal:`isValid(${i}) ? isArray(${i}) ? join(${i}, '\\n') : ${i} : ""+${i}`}}return No(e,t,n)}function wy(e){const{markDef:t,config:n}=e,i=M("aria",t,n);return i===!1?{}:{...i?{aria:i}:{},...Ey(e),...ky(e)}}function Ey(e){const{mark:t,markDef:n,config:i}=e;if(i.aria===!1)return{};const r=M("ariaRoleDescription",n,i);return r!=null?{ariaRoleDescription:{value:r}}:Z(qd,t)?{}:{ariaRoleDescription:{value:t}}}function ky(e){const{encoding:t,markDef:n,config:i,stack:r}=e,s=t.description;if(s)return Dn({model:e,channelDef:s,vgChannel:"description",mainRefFn:c=>No(c,e.config),invalidValueRef:void 0});const o=M("description",n,i);if(o!=null)return{description:q(o)};if(i.aria===!1)return{};const a=Wl(t,r,i);if(!W(a))return{description:{signal:Vt(a).filter(([c])=>!c.startsWith("_")).map(([c,u])=>[c,u.replaceAll("\\n"," ")]).map(([c,u],l)=>`"${l>0?"; ":""}${c}: " + (${u})`).join(" + ")}}}function fe(e,t,n={}){const{markDef:i,encoding:r,config:s}=t,{vgChannel:o}=n;let{defaultRef:a,defaultValue:c}=n;const u=r[e];a===void 0&&(c??(c=M(e,i,s,{vgChannel:o,ignoreVgConfig:!fi(u)})),c!==void 0&&(a=q(c)));const l={markDef:i,config:s,scaleName:t.scaleName(e),scale:t.getScaleComponent(e)},f=Tu({...l,scaleChannel:e,channelDef:u});return Dn({model:t,channelDef:u,vgChannel:o??e,invalidValueRef:f,mainRefFn:p=>oo({...l,channel:e,channelDef:p,stack:null,defaultRef:a})})}function ql(e,t={filled:void 0}){const{markDef:n,encoding:i,config:r}=e,{type:s}=n,o=t.filled??M("filled",n,r),a=z(["bar","point","circle","square","geoshape"],s)?"transparent":void 0,c=M(o===!0?"color":void 0,n,r,{vgChannel:"fill"})??r.mark[o===!0&&"color"]??a,u=M(o===!1?"color":void 0,n,r,{vgChannel:"stroke"})??r.mark[o===!1&&"color"],l=o?"fill":"stroke",f={...c?{fill:q(c)}:{},...u?{stroke:q(u)}:{}};return n.color&&(o?n.fill:n.stroke)&&w(nu("property",{fill:"fill"in n,stroke:"stroke"in n})),{...f,...fe("color",e,{vgChannel:l,defaultValue:o?c:u}),...fe("fill",e,{defaultValue:i.fill?c:void 0}),...fe("stroke",e,{defaultValue:i.stroke?u:void 0})}}function _y(e){const{encoding:t,mark:n}=e,i=t.order;return!Ut(n)&&Me(i)?Dn({model:e,channelDef:i,vgChannel:"zindex",mainRefFn:r=>q(r.value),invalidValueRef:void 0}):{}}function Tn({channel:e,markDef:t,encoding:n={},model:i,bandPosition:r}){const s=`${e}Offset`,o=t[s],a=n[s];if((s==="xOffset"||s==="yOffset")&&a)return{offsetType:"encoding",offset:oo({channel:s,channelDef:a,markDef:t,config:i==null?void 0:i.config,scaleName:i.scaleName(s),scale:i.getScaleComponent(s),stack:null,defaultRef:q(o),bandPosition:r})};const c=t[s];return c?{offsetType:"visual",offset:c}:{}}function pe(e,t,{defaultPos:n,vgChannel:i}){const{encoding:r,markDef:s,config:o,stack:a}=t,c=r[e],u=r[rt(e)],l=t.scaleName(e),f=t.getScaleComponent(e),{offset:d,offsetType:p}=Tn({channel:e,markDef:s,encoding:r,model:t,bandPosition:.5}),g=To({model:t,defaultPos:n,channel:e,scaleName:l,scale:f}),h=!c&&ee(e)&&(r.latitude||r.longitude)?{field:t.getName(e)}:Cy({channel:e,channelDef:c,channel2Def:u,markDef:s,config:o,scaleName:l,scale:f,stack:a,offset:d,defaultRef:g,bandPosition:p==="encoding"?0:void 0});return h?{[i||e]:h}:void 0}function Cy(e){const{channel:t,channelDef:n,scaleName:i,stack:r,offset:s,markDef:o}=e;if(O(n)&&r&&t===r.fieldChannel){if(v(n)){let a=n.bandPosition;if(a===void 0&&o.type==="text"&&(t==="radius"||t==="theta")&&(a=.5),a!==void 0)return Ii({scaleName:i,fieldOrDatumDef:n,startSuffix:"start",bandPosition:a,offset:s})}return Wt(n,i,{suffix:"end"},{offset:s})}return so(e)}function To({model:e,defaultPos:t,channel:n,scaleName:i,scale:r}){const{markDef:s,config:o}=e;return()=>{const a=sn(n),c=Tt(n),u=M(n,s,o,{vgChannel:c});if(u!==void 0)return Vn(n,u);switch(t){case"zeroOrMin":return tc({scaleName:i,scale:r,mode:"zeroOrMin",mainChannel:a,config:o});case"zeroOrMax":return tc({scaleName:i,scale:r,mode:{zeroOrMax:{widthSignal:e.width.signal,heightSignal:e.height.signal}},mainChannel:a,config:o});case"mid":return{...e[Se(n)],mult:.5}}}}function tc({mainChannel:e,config:t,...n}){const i=Nu(n),{mode:r}=n;if(i)return i;switch(e){case"radius":{if(r==="zeroOrMin")return{value:0};const{widthSignal:s,heightSignal:o}=r.zeroOrMax;return{signal:`min(${s},${o})/2`}}case"theta":return r==="zeroOrMin"?{value:0}:{signal:"2*PI"};case"x":return r==="zeroOrMin"?{value:0}:{field:{group:"width"}};case"y":return r==="zeroOrMin"?{field:{group:"height"}}:{value:0}}}const Fy={left:"x",center:"xc",right:"x2"},Ny={top:"y",middle:"yc",bottom:"y2"};function Gl(e,t,n,i="middle"){if(e==="radius"||e==="theta")return Tt(e);const r=e==="x"?"align":"baseline",s=M(r,t,n);let o;return C(s)?(w(Cp(r)),o=void 0):o=s,e==="x"?Fy[o||(i==="top"?"left":"center")]:Ny[o||i]}function Wi(e,t,{defaultPos:n,defaultPos2:i,range:r}){return r?Vl(e,t,{defaultPos:n,defaultPos2:i}):pe(e,t,{defaultPos:n})}function Vl(e,t,{defaultPos:n,defaultPos2:i}){const{markDef:r,config:s}=t,o=rt(e),a=Se(e),c=Ty(t,i,o),u=c[a]?Gl(e,r,s):Tt(e);return{...pe(e,t,{defaultPos:n,vgChannel:u}),...c}}function Ty(e,t,n){const{encoding:i,mark:r,markDef:s,stack:o,config:a}=e,c=sn(n),u=Se(n),l=Tt(n),f=i[c],d=e.scaleName(c),p=e.getScaleComponent(c),{offset:g}=n in i||n in s?Tn({channel:n,markDef:s,encoding:i,model:e}):Tn({channel:c,markDef:s,encoding:i,model:e});if(!f&&(n==="x2"||n==="y2")&&(i.latitude||i.longitude)){const m=Se(n),y=e.markDef[m];return y!=null?{[m]:{value:y}}:{[l]:{field:e.getName(n)}}}const h=Oy({channel:n,channelDef:f,channel2Def:i[n],markDef:s,config:a,scaleName:d,scale:p,stack:o,offset:g,defaultRef:void 0});return h!==void 0?{[l]:h}:Ei(n,s)||Ei(n,{[n]:Jr(n,s,a.style),[u]:Jr(u,s,a.style)})||Ei(n,a[r])||Ei(n,a.mark)||{[l]:To({model:e,defaultPos:t,channel:n,scaleName:d,scale:p})()}}function Oy({channel:e,channelDef:t,channel2Def:n,markDef:i,config:r,scaleName:s,scale:o,stack:a,offset:c,defaultRef:u}){return O(t)&&a&&e.charAt(0)===a.fieldChannel.charAt(0)?Wt(t,s,{suffix:"start"},{offset:c}):so({channel:e,channelDef:n,scaleName:s,scale:o,stack:a,markDef:i,config:r,offset:c,defaultRef:u})}function Ei(e,t){const n=Se(e),i=Tt(e);if(t[i]!==void 0)return{[i]:Vn(e,t[i])};if(t[e]!==void 0)return{[i]:Vn(e,t[e])};if(t[n]){const r=t[n];if(Zt(r))w($p(n));else return{[n]:Vn(e,r)}}}function yt(e,t){const{config:n,encoding:i,markDef:r}=e,s=r.type,o=rt(t),a=Se(t),c=i[t],u=i[o],l=e.getScaleComponent(t),f=l?l.get("type"):void 0,d=r.orient,p=i[a]??i.size??M("size",r,n,{vgChannel:a}),g=jc(t),h=s==="bar"&&(t==="x"?d==="vertical":d==="horizontal")||s==="tick"&&(t==="y"?d==="vertical":d==="horizontal");return v(c)&&(H(c.bin)||ce(c.bin)||c.timeUnit&&!u)&&!(p&&!Zt(p))&&!i[g]&&!oe(f)?Ry({fieldDef:c,fieldDef2:u,channel:t,model:e}):(O(c)&&oe(f)||h)&&!u?Py(c,t,e):Vl(t,e,{defaultPos:"zeroOrMax",defaultPos2:"zeroOrMin"})}function Ay(e,t,n,i,r,s,o){if(Zt(r))if(n){const c=n.get("type");if(c==="band"){let u=`bandwidth('${t}')`;r.band!==1&&(u=`${r.band} * ${u}`);const l=Ze("minBandSize",{type:o},i);return{signal:l?`max(${Pe(l)}, ${u})`:u}}else r.band!==1&&(w(Op(c)),r=void 0)}else return{mult:r.band,field:{group:e}};else{if(C(r))return r;if(r)return{value:r}}if(n){const c=n.get("range");if(an(c)&&G(c.step))return{value:c.step-2}}if(!s){const{bandPaddingInner:c,barBandPaddingInner:u,rectBandPaddingInner:l,tickBandPaddingInner:f}=i.scale,d=te(c,o==="tick"?f:o==="bar"?u:l);if(C(d))return{signal:`(1 - (${d.signal})) * ${e}`};if(G(d))return{signal:`${1-d} * ${e}`}}return{value:os(i.view,e)-2}}function Py(e,t,n){var me,$e;const{markDef:i,encoding:r,config:s,stack:o}=n,a=i.orient,c=n.scaleName(t),u=n.getScaleComponent(t),l=Se(t),f=rt(t),d=jc(t),p=n.scaleName(d),g=n.getScaleComponent(Os(t)),h=i.type==="tick"||a==="horizontal"&&t==="y"||a==="vertical"&&t==="x";let m;(r.size||i.size)&&(h?m=fe("size",n,{vgChannel:l,defaultRef:q(i.size)}):w(zp(i.type)));const y=!!m,S=Lu({channel:t,fieldDef:e,markDef:i,config:s,scaleType:(me=u||g)==null?void 0:me.get("type"),useVlSizeChannel:h});m=m||{[l]:Ay(l,p||c,g||u,s,S,!!e,i.type)};const k=(($e=u||g)==null?void 0:$e.get("type"))==="band"&&Zt(S)&&!y?"top":"middle",A=Gl(t,i,s,k),F=A==="xc"||A==="yc",{offset:P,offsetType:B}=Tn({channel:t,markDef:i,encoding:r,model:n,bandPosition:F?.5:0}),X=so({channel:t,channelDef:e,markDef:i,config:s,scaleName:c,scale:u,stack:o,offset:P,defaultRef:To({model:n,defaultPos:"mid",channel:t,scaleName:c,scale:u}),bandPosition:F?B==="encoding"?0:.5:C(S)?{signal:`(1-${S})/2`}:Zt(S)?(1-S.band)/2:0});if(l)return{[A]:X,...m};{const ve=Tt(f),at=m[l],Bt=P?{...at,offset:P}:at;return{[A]:X,[ve]:_(X)?[X[0],{...X[1],offset:Bt}]:{...X,offset:Bt}}}}function nc(e,t,n,i,r,s,o){if(Rc(e))return 0;const a=e==="x"||e==="y2",c=a?-t/2:t/2;if(C(n)||C(r)||C(i)||s){const u=Pe(n),l=Pe(r),f=Pe(i),d=Pe(s),g=s?`(${o} < ${d} ? ${a?"":"-"}0.5 * (${d} - (${o})) : ${c})`:c,h=f?`${f} + `:"",m=u?`(${u} ? -1 : 1) * `:"",y=l?`(${l} + ${g})`:g;return{signal:h+m+y}}else return r=r||0,i+(n?-r-c:+r+c)}function Ry({fieldDef:e,fieldDef2:t,channel:n,model:i}){var $e;const{config:r,markDef:s,encoding:o}=i,a=i.getScaleComponent(n),c=i.scaleName(n),u=a?a.get("type"):void 0,l=a.get("reverse"),f=Lu({channel:n,fieldDef:e,markDef:s,config:r,scaleType:u}),d=($e=i.component.axes[n])==null?void 0:$e[0],p=(d==null?void 0:d.get("translate"))??.5,g=ee(n)?M("binSpacing",s,r)??0:0,h=rt(n),m=Tt(n),y=Tt(h),S=Ze("minBandSize",s,r),{offset:k}=Tn({channel:n,markDef:s,encoding:o,model:i,bandPosition:0}),{offset:A}=Tn({channel:h,markDef:s,encoding:o,model:i,bandPosition:0}),F=ih({fieldDef:e,scaleName:c}),P=nc(n,g,l,p,k,S,F),B=nc(h,g,l,p,A??k,S,F),X=C(f)?{signal:`(1-${f.signal})/2`}:Zt(f)?(1-f.band)/2:.5,me=Ot({fieldDef:e,fieldDef2:t,markDef:s,config:r});if(H(e.bin)||e.timeUnit){const ve=e.timeUnit&&me!==.5;return{[y]:ic({fieldDef:e,scaleName:c,bandPosition:X,offset:B,useRectOffsetField:ve}),[m]:ic({fieldDef:e,scaleName:c,bandPosition:C(X)?{signal:`1-${X.signal}`}:1-X,offset:P,useRectOffsetField:ve})}}else if(ce(e.bin)){const ve=Wt(e,c,{},{offset:B});if(v(t))return{[y]:ve,[m]:Wt(t,c,{},{offset:P})};if(on(e.bin)&&e.bin.step)return{[y]:ve,[m]:{signal:`scale("${c}", ${E(e,{expr:"datum"})} + ${e.bin.step})`,offset:P}}}w(su(h))}function ic({fieldDef:e,scaleName:t,bandPosition:n,offset:i,useRectOffsetField:r}){return Ii({scaleName:t,fieldOrDatumDef:e,bandPosition:n,offset:i,...r?{startSuffix:br,endSuffix:Sr}:{}})}const zy=new Set(["aria","width","height"]);function Oe(e,t){const{fill:n=void 0,stroke:i=void 0}=t.color==="include"?ql(e):{};return{...Iy(e.markDef,t),...rc("fill",n),...rc("stroke",i),...fe("opacity",e),...fe("fillOpacity",e),...fe("strokeOpacity",e),...fe("strokeWidth",e),...fe("strokeDash",e),..._y(e),...Bl(e),...Fo(e,"href"),...wy(e)}}function rc(e,t){return t?{[e]:t}:{}}function Iy(e,t){return Hd.reduce((n,i)=>(!zy.has(i)&&$(e,i)&&t[i]!=="ignore"&&(n[i]=q(e[i])),n),{})}function Oo(e){const{config:t,markDef:n}=e,i=new Set;if(e.forEachFieldDef((r,s)=>{var u;let o;if(!st(s)||!(o=e.getScaleType(s)))return;const a=er(r.aggregate),c=ro({scaleChannel:s,markDef:n,config:t,scaleType:o,isCountAggregate:a});if(eh(c)){const l=e.vgField(s,{expr:"datum",binSuffix:(u=e.stack)!=null&&u.impute?"mid":void 0});l&&i.add(l)}}),i.size>0)return{defined:{signal:[...i].map(s=>rr(s,!0)).join(" && ")}}}function sc(e,t){if(t!==void 0)return{[e]:q(t)}}const Gr="voronoi",Xl={defined:e=>e.type==="point"&&e.nearest,parse:(e,t)=>{if(t.events)for(const n of t.events)n.markname=e.getName(Gr)},marks:(e,t,n)=>{const{x:i,y:r}=t.project.hasChannel,s=e.mark;if(Ut(s))return w(Qd(s)),n;const o={name:e.getName(Gr),type:"path",interactive:!0,aria:!1,from:{data:e.getName("marks")},encode:{update:{fill:{value:"transparent"},strokeWidth:{value:.35},stroke:{value:"transparent"},isVoronoi:{value:!0},...Bl(e,{reactiveGeom:!0})}},transform:[{type:"voronoi",x:{expr:i||!r?"datum.datum.x || 0":"0"},y:{expr:r||!i?"datum.datum.y || 0":"0"},size:[e.getSizeSignalRef("width"),e.getSizeSignalRef("height")]}]};let a=0,c=!1;return n.forEach((u,l)=>{const f=u.name??"";f===e.component.mark[0].name?a=l:f.includes(Gr)&&(c=!0)}),c||n.splice(a+1,0,o),n}},Yl={defined:e=>e.type==="point"&&e.resolve==="global"&&e.bind&&e.bind!=="scales"&&!So(e.bind),parse:(e,t,n)=>rf(t,n),topLevelSignals:(e,t,n)=>{var c;const i=t.name,r=t.project,s=t.bind,o=(c=t.init)==null?void 0:c[0],a=Xl.defined(t)?"(item().isVoronoi ? datum.datum : datum)":"datum";return r.items.forEach((u,l)=>{const f=K(`${i}_${u.field}`);n.filter(p=>p.name===f).length||n.unshift({name:f,...o?{init:en(o[l])}:{value:null},on:t.events?[{events:t.events,update:`datum && item().mark.marktype !== 'group' ? ${a}[${R(u.field)}] : null`}]:[],bind:s[u.field]??s[u.channel]??s})}),n},signals:(e,t,n)=>{const i=t.name,r=t.project,s=n.find(u=>u.name===i+xt),o=i+hi,a=r.items.map(u=>K(`${i}_${u.field}`)),c=a.map(u=>`${u} !== null`).join(" && ");return a.length&&(s.update=`${c} ? {fields: ${o}, values: [${a.join(", ")}]} : null`),delete s.value,delete s.on,n}},Hi="_toggle",Kl={defined:e=>e.type==="point"&&!Ke(e)&&!!e.toggle,signals:(e,t,n)=>n.concat({name:t.name+Hi,value:!1,on:[{events:t.events,update:t.toggle}]}),modifyExpr:(e,t)=>{const n=t.name+xt,i=t.name+Hi;return`${i} ? null : ${n}, ${t.resolve==="global"?`${i} ? null : true, `:`${i} ? null : {unit: ${qt(e)}}, `}${i} ? ${n} : null`}},Ly={defined:e=>e.clear!==void 0&&e.clear!==!1&&!Ke(e),parse:(e,t)=>{t.clear&&(t.clear=T(t.clear)?In(t.clear,"view"):t.clear)},topLevelSignals:(e,t,n)=>{if(Yl.defined(t))for(const i of t.project.items){const r=n.findIndex(s=>s.name===K(`${t.name}_${i.field}`));r!==-1&&n[r].on.push({events:t.clear,update:"null"})}return n},signals:(e,t,n)=>{function i(r,s){r!==-1&&n[r].on&&n[r].on.push({events:t.clear,update:s})}if(t.type==="interval")for(const r of t.project.items){const s=n.findIndex(o=>o.name===r.signals.visual);if(i(s,"[0, 0]"),s===-1){const o=n.findIndex(a=>a.name===r.signals.data);i(o,"null")}}else{let r=n.findIndex(s=>s.name===t.name+xt);i(r,"null"),Kl.defined(t)&&(r=n.findIndex(s=>s.name===t.name+Hi),i(r,"false"))}return n}},Ql={defined:e=>{const t=e.resolve==="global"&&e.bind&&So(e.bind),n=e.project.items.length===1&&e.project.items[0].field!==je;return t&&!n&&w(tp),t&&n},parse:(e,t,n)=>{const i=N(n);if(i.select=T(i.select)?{type:i.select,toggle:t.toggle}:{...i.select,toggle:t.toggle},rf(t,i),L(n.select)&&(n.select.on||n.select.clear)){const o='event.item && indexof(event.item.mark.role, "legend") < 0';for(const a of t.events)a.filter=J(a.filter??[]),a.filter.includes(o)||a.filter.push(o)}const r=jr(t.bind)?t.bind.legend:"click",s=T(r)?In(r,"view"):J(r);t.bind={legend:{merge:s}}},topLevelSignals:(e,t,n)=>{const i=t.name,r=jr(t.bind)&&t.bind.legend,s=o=>a=>{const c=N(a);return c.markname=o,c};for(const o of t.project.items){if(!o.hasLegend)continue;const a=`${K(o.field)}_legend`,c=`${i}_${a}`;if(n.filter(l=>l.name===c).length===0){const l=r.merge.map(s(`${a}_symbols`)).concat(r.merge.map(s(`${a}_labels`))).concat(r.merge.map(s(`${a}_entries`)));n.unshift({name:c,...t.init?{}:{value:null},on:[{events:l,update:"isDefined(datum.value) ? datum.value : item().items[0].items[0].datum.value",force:!0},{events:r.merge,update:`!event.item || !datum ? null : ${c}`,force:!0}]})}}return n},signals:(e,t,n)=>{const i=t.name,r=t.project,s=n.find(d=>d.name===i+xt),o=i+hi,a=r.items.filter(d=>d.hasLegend).map(d=>K(`${i}_${K(d.field)}_legend`)),u=`${a.map(d=>`${d} !== null`).join(" && ")} ? {fields: ${o}, values: [${a.join(", ")}]} : null`;t.events&&a.length>0?s.on.push({events:a.map(d=>({signal:d})),update:u}):a.length>0&&(s.update=u,delete s.value,delete s.on);const l=n.find(d=>d.name===i+Hi),f=jr(t.bind)&&t.bind.legend;return l&&(t.events?l.on.push({...l.on[0],events:f}):l.on[0].events=f),n}};function My(e,t,n){var r;const i=(r=e.fieldDef(t))==null?void 0:r.field;for(const s of ie(e.component.selection??{})){const o=s.project.hasField[i]??s.project.hasChannel[t];if(o&&Ql.defined(s)){const a=n.get("selections")??[];a.push(s.name),n.set("selections",a,!1),o.hasLegend=!0}}}const Zl="_translate_anchor",Jl="_translate_delta",Dy={defined:e=>e.type==="interval"&&e.translate,signals:(e,t,n)=>{const i=t.name,r=gt.defined(t),s=i+Zl,{x:o,y:a}=t.project.hasChannel;let c=In(t.translate,"scope");return r||(c=c.map(u=>(u.between[0].markname=i+bn,u))),n.push({name:s,value:{},on:[{events:c.map(u=>u.between[0]),update:`{x: x(unit), y: y(unit)${o!==void 0?`, extent_x: ${r?fs(e,V):`slice(${o.signals.visual})`}`:""}${a!==void 0?`, extent_y: ${r?fs(e,ae):`slice(${a.signals.visual})`}`:""}}`}]},{name:i+Jl,value:{},on:[{events:c,update:`{x: ${s}.x - x(unit), y: ${s}.y - y(unit)}`}]}),o!==void 0&&oc(e,t,o,"width",n),a!==void 0&&oc(e,t,a,"height",n),n}};function oc(e,t,n,i,r){const s=t.name,o=s+Zl,a=s+Jl,c=n.channel,u=gt.defined(t),l=r.find(F=>F.name===n.signals[u?"data":"visual"]),f=e.getSizeSignalRef(i).signal,d=e.getScaleComponent(c),p=d==null?void 0:d.get("type"),g=d==null?void 0:d.get("reverse"),h=u?c===V?g?"":"-":g?"-":"":"",m=`${o}.extent_${c}`,y=`${h}${a}.${c} / ${u?`${f}`:`span(${m})`}`,S=!u||!d?"panLinear":p==="log"?"panLog":p==="symlog"?"panSymlog":p==="pow"?"panPow":"panLinear",k=u?p==="pow"?`, ${d.get("exponent")??1}`:p==="symlog"?`, ${d.get("constant")??1}`:"":"",A=`${S}(${m}, ${y}${k})`;l.on.push({events:{signal:a},update:u?A:`clampRange(${A}, 0, ${f})`})}const ef="_zoom_anchor",tf="_zoom_delta",jy={defined:e=>e.type==="interval"&&e.zoom,signals:(e,t,n)=>{const i=t.name,r=gt.defined(t),s=i+tf,{x:o,y:a}=t.project.hasChannel,c=R(e.scaleName(V)),u=R(e.scaleName(ae));let l=In(t.zoom,"scope");return r||(l=l.map(f=>(f.markname=i+bn,f))),n.push({name:i+ef,on:[{events:l,update:r?`{${[c?`x: invert(${c}, x(unit))`:"",u?`y: invert(${u}, y(unit))`:""].filter(f=>f).join(", ")}}`:"{x: x(unit), y: y(unit)}"}]},{name:s,on:[{events:l,force:!0,update:"pow(1.001, event.deltaY * pow(16, event.deltaMode))"}]}),o!==void 0&&ac(e,t,o,"width",n),a!==void 0&&ac(e,t,a,"height",n),n}};function ac(e,t,n,i,r){const s=t.name,o=n.channel,a=gt.defined(t),c=r.find(S=>S.name===n.signals[a?"data":"visual"]),u=e.getSizeSignalRef(i).signal,l=e.getScaleComponent(o),f=l==null?void 0:l.get("type"),d=a?fs(e,o):c.name,p=s+tf,g=`${s}${ef}.${o}`,h=!a||!l?"zoomLinear":f==="log"?"zoomLog":f==="symlog"?"zoomSymlog":f==="pow"?"zoomPow":"zoomLinear",m=a?f==="pow"?`, ${l.get("exponent")??1}`:f==="symlog"?`, ${l.get("constant")??1}`:"":"",y=`${h}(${d}, ${g}, ${p}${m})`;c.on.push({events:{signal:p},update:a?y:`clampRange(${y}, 0, ${u})`})}const tn="_store",xt="_tuple",Uy="_modify",nf="vlSelectionResolve",$r=[py,$y,ly,Kl,Yl,gt,Ql,Ly,Dy,jy,Xl];function By(e){let t=e.parent;for(;t&&!ke(t);)t=t.parent;return t}function qt(e,{escape:t}={escape:!0}){let n=t?R(e.name):e.name;const i=By(e);if(i){const{facet:r}=i;for(const s of Ce)r[s]&&(n+=` + '__facet_${s}_' + (facet[${R(i.vgField(s))}])`)}return n}function Ao(e){return ie(e.component.selection??{}).reduce((t,n)=>t||n.project.hasSelectionId,!1)}function rf(e,t){(T(t.select)||!t.select.on)&&delete e.events,(T(t.select)||!t.select.clear)&&delete e.clear,(T(t.select)||!t.select.toggle)&&delete e.toggle}function Ke(e){var t;return(t=e.events)==null?void 0:t.find(n=>"type"in n&&n.type==="timer")}function ps(e){const t=[];return e.type==="Identifier"?[e.name]:e.type==="Literal"?[e.value]:(e.type==="MemberExpression"&&(t.push(...ps(e.object)),t.push(...ps(e.property))),t)}function sf(e){return e.object.type==="MemberExpression"?sf(e.object):e.object.name==="datum"}function of(e){const t=id(e),n=new Set;return t.visit(i=>{i.type==="MemberExpression"&&sf(i)&&n.add(ps(i).slice(1).join("."))}),n}class jn extends j{constructor(n,i,r){super(n);x(this,"model");x(this,"filter");x(this,"expr");x(this,"_dependentFields");this.model=i,this.filter=r,this.expr=qi(this.model,this.filter,this),this._dependentFields=of(this.expr)}clone(){return new jn(null,this.model,N(this.filter))}dependentFields(){return this._dependentFields}producedFields(){return new Set}assemble(){return{type:"filter",expr:this.expr}}hash(){return`Filter ${this.expr}`}}function Wy(e,t){const n={},i=e.config.selection;if(!t||!t.length)return n;let r=0;for(const s of t){const o=K(s.name),a=s.select,c=T(a)?a:a.type,u=L(a)?N(a):{type:c},l=i[c];for(const p in l)p==="fields"||p==="encodings"||(p==="mark"&&(u.mark={...l.mark,...u.mark}),(u[p]===void 0||u[p]===!0)&&(u[p]=N(l[p]??u[p])));const f=n[o]={...u,name:o,type:c,init:s.value,bind:s.bind,events:T(u.on)?In(u.on,"scope"):J(N(u.on))};if(Ke(f)&&(r++,r>1)){delete n[o];continue}const d=N(s);for(const p of $r)p.defined(f)&&p.parse&&p.parse(e,f,d)}return r>1&&w(ap),n}function af(e,t,n,i="datum"){const r=T(t)?t:t.param,s=K(r),o=R(s+tn);let a;try{a=e.getSelectionComponent(s,r)}catch{return`!!${s}`}if(a.project.timeUnit){const d=n??e.component.data.raw,p=a.project.timeUnit.clone();d.parent?p.insertAsParentOf(d):d.parent=p}const c=a.project.hasSelectionId?"vlSelectionIdTest(":"vlSelectionTest(",u=a.resolve==="global"?")":`, ${R(a.resolve)})`,l=`${c}${o}, ${i}${u}`,f=`length(data(${o}))`;return t.empty===!1?`${f} && ${l}`:`!${f} || ${l}`}function cf(e,t,n){const i=K(t),r=n.encoding;let s=n.field,o;try{o=e.getSelectionComponent(i,t)}catch{return i}if(!r&&!s)s=o.project.items[0].field,o.project.items.length>1&&w(cp(s));else if(r&&!s){const a=o.project.items.filter(c=>c.channel===r);!a.length||a.length>1?(s=o.project.items[0].field,w(up(a,r,n,s))):s=a[0].field}return`${o.name}[${R(Ie(s))}]`}function Hy(e,t){for(const[n,i]of Vt(e.component.selection??{})){const r=e.getName(`lookup_${n}`);e.component.data.outputNodes[r]=i.materialized=new ye(new jn(t,e,{param:n}),r,Q.Lookup,e.component.data.outputNodeRefCounts)}}function qi(e,t,n){return Ti(t,i=>T(i)?i:xg(i)?af(e,i,n):yu(i))}function qy(e,t){if(e)return _(e)&&!Ct(e)?e.map(n=>fo(n,t)).join(", "):e}function Vr(e,t,n,i){var r,s;e.encode??(e.encode={}),(r=e.encode)[t]??(r[t]={}),(s=e.encode[t]).update??(s.update={}),e.encode[t].update[n]=i}function Gn(e,t,n,i={header:!1}){var f,d;const{disable:r,orient:s,scale:o,labelExpr:a,title:c,zindex:u,...l}=e.combine();if(!r){for(const p in l){const g=p,h=vh[g],m=l[g];if(h&&h!==t&&h!=="both")delete l[g];else if(gi(m)){const{condition:y,...S}=m,k=J(y),A=za[g];if(A){const{vgProp:F,part:P}=A,B=[...k.map(X=>{const{test:me,...$e}=X;return{test:qi(null,me),...$e}}),S];Vr(l,P,F,B),delete l[g]}else if(A===null){const F={signal:k.map(P=>{const{test:B,...X}=P;return`${qi(null,B)} ? ${ba(X)} : `}).join("")+ba(S)};l[g]=F}}else if(C(m)){const y=za[g];if(y){const{vgProp:S,part:k}=y;Vr(l,k,S,m),delete l[g]}}z(["labelAlign","labelBaseline"],g)&&l[g]===null&&delete l[g]}if(t==="grid"){if(!l.grid)return;if(l.encode){const{grid:p}=l.encode;l.encode={...p?{grid:p}:{}},W(l.encode)&&delete l.encode}return{scale:o,orient:s,...l,domain:!1,labels:!1,aria:!1,maxExtent:0,minExtent:0,ticks:!1,zindex:te(u,0)}}else{if(!i.header&&e.mainExtracted)return;if(a!==void 0){let g=a;(d=(f=l.encode)==null?void 0:f.labels)!=null&&d.update&&C(l.encode.labels.update.text)&&(g=vn(a,"datum.label",l.encode.labels.update.text.signal)),Vr(l,"labels","text",{signal:g})}if(l.labelAlign===null&&delete l.labelAlign,l.encode){for(const g of Vu)e.hasAxisPart(g)||delete l.encode[g];W(l.encode)&&delete l.encode}const p=qy(c,n);return{scale:o,orient:s,grid:!1,...p?{title:p}:{},...l,...n.aria===!1?{aria:!1}:{},zindex:te(u,0)}}}}function uf(e){const{axes:t}=e.component,n=[];for(const i of wt)if(t[i]){for(const r of t[i])if(!r.get("disable")&&!r.get("gridScale")){const s=i==="x"?"height":"width",o=e.getSizeSignalRef(s).signal;s!==o&&n.push({name:s,update:o})}}return n}function Gy(e,t){const{x:n=[],y:i=[]}=e;return[...n.map(r=>Gn(r,"grid",t)),...i.map(r=>Gn(r,"grid",t)),...n.map(r=>Gn(r,"main",t)),...i.map(r=>Gn(r,"main",t))].filter(r=>r)}function cc(e,t,n,i){return Object.assign.apply(null,[{},...e.map(r=>{if(r==="axisOrient"){const s=n==="x"?"bottom":"left",o=t[n==="x"?"axisBottom":"axisLeft"]||{},a=t[n==="x"?"axisTop":"axisRight"]||{},c=new Set([...b(o),...b(a)]),u={};for(const l of c.values())u[l]={signal:`${i.signal} === "${s}" ? ${Pe(o[l])} : ${Pe(a[l])}`};return u}return t[r]})])}function Vy(e,t,n,i){const r=t==="band"?["axisDiscrete","axisBand"]:t==="point"?["axisDiscrete","axisPoint"]:Su(t)?["axisQuantitative"]:t==="time"||t==="utc"?["axisTemporal"]:[],s=e==="x"?"axisX":"axisY",o=C(n)?"axisOrient":`axis${Vi(n)}`,a=[...r,...r.map(u=>s+u.substr(4))],c=["axis",o,s];return{vlOnlyAxisConfig:cc(a,i,e,n),vgAxisConfig:cc(c,i,e,n),axisConfigStyle:Xy([...c,...a],i)}}function Xy(e,t){var i;const n=[{}];for(const r of e){let s=(i=t[r])==null?void 0:i.style;if(s){s=J(s);for(const o of s)n.push(t.style[o])}}return Object.assign.apply(null,n)}function gs(e,t,n,i={}){var s;const r=Yc(e,n,t);if(r!==void 0)return{configFrom:"style",configValue:r};for(const o of["vlOnlyAxisConfig","vgAxisConfig","axisConfigStyle"])if(((s=i[o])==null?void 0:s[e])!==void 0)return{configFrom:o,configValue:i[o][e]};return{}}const uc={scale:({model:e,channel:t})=>e.scaleName(t),format:({format:e})=>e,formatType:({formatType:e})=>e,grid:({fieldOrDatumDef:e,axis:t,scaleType:n})=>t.grid??Yy(n,e),gridScale:({model:e,channel:t})=>Ky(e,t),labelAlign:({axis:e,labelAngle:t,orient:n,channel:i})=>e.labelAlign||ff(t,n,i),labelAngle:({labelAngle:e})=>e,labelBaseline:({axis:e,labelAngle:t,orient:n,channel:i})=>e.labelBaseline||lf(t,n,i),labelFlush:({axis:e,fieldOrDatumDef:t,channel:n})=>e.labelFlush??Zy(t.type,n),labelOverlap:({axis:e,fieldOrDatumDef:t,scaleType:n})=>e.labelOverlap??Jy(t.type,n,v(t)&&!!t.timeUnit,v(t)?t.sort:void 0),orient:({orient:e})=>e,tickCount:({channel:e,model:t,axis:n,fieldOrDatumDef:i,scaleType:r})=>{const s=e==="x"?"width":e==="y"?"height":void 0,o=s?t.getSizeSignalRef(s):void 0;return n.tickCount??tx({fieldOrDatumDef:i,scaleType:r,size:o,values:n.values})},tickMinStep:({axis:e,format:t,fieldOrDatumDef:n})=>e.tickMinStep??nx({format:t,fieldOrDatumDef:n}),title:({axis:e,model:t,channel:n})=>{if(e.title!==void 0)return e.title;const i=df(t,n);if(i!==void 0)return i;const r=t.typedFieldDef(n),s=n==="x"?"x2":"y2",o=t.fieldDef(s);return Qc(r?[Pa(r)]:[],v(o)?[Pa(o)]:[])},values:({axis:e,fieldOrDatumDef:t})=>ix(e,t),zindex:({axis:e,fieldOrDatumDef:t,mark:n})=>e.zindex??rx(n,t)};function Yy(e,t){return!oe(e)&&v(t)&&!H(t==null?void 0:t.bin)&&!ce(t==null?void 0:t.bin)}function Ky(e,t){const n=t==="x"?"y":"x";if(e.getScaleComponent(n))return e.scaleName(n)}function Qy(e,t,n,i,r){const s=t==null?void 0:t.labelAngle;if(s!==void 0)return C(s)?s:Pi(s);{const{configValue:o}=gs("labelAngle",i,t==null?void 0:t.style,r);return o!==void 0?Pi(o):n===V&&z([Js,Zs],e.type)&&!(v(e)&&e.timeUnit)?270:void 0}}function hs(e){return`(((${e.signal} % 360) + 360) % 360)`}function lf(e,t,n,i){if(e!==void 0)if(n==="x"){if(C(e)){const r=hs(e),s=C(t)?`(${t.signal} === "top")`:t==="top";return{signal:`(45 < ${r} && ${r} < 135) || (225 < ${r} && ${r} < 315) ? "middle" :(${r} <= 45 || 315 <= ${r}) === ${s} ? "bottom" : "top"`}}if(45<e&&e<135||225<e&&e<315)return"middle";if(C(t)){const r=e<=45||315<=e?"===":"!==";return{signal:`${t.signal} ${r} "top" ? "bottom" : "top"`}}return(e<=45||315<=e)==(t==="top")?"bottom":"top"}else{if(C(e)){const r=hs(e),s=C(t)?`(${t.signal} === "left")`:t==="left";return{signal:`${r} <= 45 || 315 <= ${r} || (135 <= ${r} && ${r} <= 225) ? ${i?'"middle"':"null"} : (45 <= ${r} && ${r} <= 135) === ${s} ? "top" : "bottom"`}}if(e<=45||315<=e||135<=e&&e<=225)return i?"middle":null;if(C(t)){const r=45<=e&&e<=135?"===":"!==";return{signal:`${t.signal} ${r} "left" ? "top" : "bottom"`}}return(45<=e&&e<=135)==(t==="left")?"top":"bottom"}}function ff(e,t,n){if(e===void 0)return;const i=n==="x",r=i?0:90,s=i?"bottom":"left";if(C(e)){const o=hs(e),a=C(t)?`(${t.signal} === "${s}")`:t===s;return{signal:`(${r?`(${o} + 90)`:o} % 180 === 0) ? ${i?null:'"center"'} :(${r} < ${o} && ${o} < ${180+r}) === ${a} ? "left" : "right"`}}if((e+r)%180===0)return i?null:"center";if(C(t)){const o=r<e&&e<180+r?"===":"!==";return{signal:`${`${t.signal} ${o} "${s}"`} ? "left" : "right"`}}return(r<e&&e<180+r)==(t===s)?"left":"right"}function Zy(e,t){if(t==="x"&&z(["quantitative","temporal"],e))return!0}function Jy(e,t,n,i){if(n&&!L(i)||e!=="nominal"&&e!=="ordinal")return t==="log"||t==="symlog"?"greedy":!0}function ex(e){return e==="x"?"bottom":"left"}function tx({fieldOrDatumDef:e,scaleType:t,size:n,values:i}){var r;if(!i&&!oe(t)&&t!=="log"){if(v(e)){if(H(e.bin))return{signal:`ceil(${n.signal}/10)`};if(e.timeUnit&&z(["month","hours","day","quarter"],(r=se(e.timeUnit))==null?void 0:r.unit))return}return{signal:`ceil(${n.signal}/40)`}}}function nx({format:e,fieldOrDatumDef:t}){if(e==="d")return 1;if(v(t)){const{timeUnit:n}=t;if(n){const i=gu(n);if(i)return{signal:i}}}}function df(e,t){const n=t==="x"?"x2":"y2",i=e.fieldDef(t),r=e.fieldDef(n),s=i?i.title:void 0,o=r?r.title:void 0;if(s&&o)return Zc(s,o);if(s)return s;if(o)return o;if(s!==void 0)return s;if(o!==void 0)return o}function ix(e,t){const n=e.values;if(_(n))return Gu(t,n);if(C(n))return n}function rx(e,t){return e==="rect"&&Mi(t)?1:0}class On extends j{constructor(n,i){super(n);x(this,"transform");x(this,"_dependentFields");this.transform=i,this._dependentFields=of(this.transform.calculate)}clone(){return new On(null,N(this.transform))}static parseAllForSortIndex(n,i){return i.forEachFieldDef((r,s)=>{if(ln(r)&&Iu(r.sort)){const{field:o,timeUnit:a}=r,c=r.sort,u=c.map((l,f)=>`${yu({field:o,timeUnit:a,equal:l})} ? ${f} : `).join("")+c.length;n=new On(n,{calculate:u,as:An(r,s,{forAs:!0})})}}),n}producedFields(){return new Set([this.transform.as])}dependentFields(){return this._dependentFields}assemble(){return{type:"formula",expr:this.transform.calculate,as:this.transform.as}}hash(){return`Calculate ${I(this.transform)}`}}function An(e,t,n){return E(e,{prefix:t,suffix:"sort_index",...n})}function vr(e,t){return z(["top","bottom"],t)?"column":z(["left","right"],t)||e==="row"?"row":"column"}function Pn(e,t,n,i){const r=i==="row"?n.headerRow:i==="column"?n.headerColumn:n.headerFacet;return te((t||{})[e],r[e],n.header[e])}function wr(e,t,n,i){const r={};for(const s of e){const o=Pn(s,t||{},n,i);o!==void 0&&(r[s]=o)}return r}const Po=["row","column"],Ro=["header","footer"];function sx(e,t){const n=e.component.layoutHeaders[t].title,i=e.config?e.config:void 0,r=e.component.layoutHeaders[t].facetFieldDef?e.component.layoutHeaders[t].facetFieldDef:void 0,{titleAnchor:s,titleAngle:o,titleOrient:a}=wr(["titleAnchor","titleAngle","titleOrient"],r.header,i,t),c=vr(t,a),u=Pi(o);return{name:`${t}-title`,type:"group",role:`${c}-title`,title:{text:n,...t==="row"?{orient:"left"}:{},style:"guide-title",...gf(u,c),...pf(c,u,s),...hf(i,r,t,Hh,fl)}}}function pf(e,t,n="middle"){switch(n){case"start":return{align:"left"};case"end":return{align:"right"}}const i=ff(t,e==="row"?"left":"top",e==="row"?"y":"x");return i?{align:i}:{}}function gf(e,t){const n=lf(e,t==="row"?"left":"top",t==="row"?"y":"x",!0);return n?{baseline:n}:{}}function ox(e,t){const n=e.component.layoutHeaders[t],i=[];for(const r of Ro)if(n[r])for(const s of n[r]){const o=cx(e,t,r,n,s);o!=null&&i.push(o)}return i}function ax(e,t){const{sort:n}=e;return pt(n)?{field:E(n,{expr:"datum"}),order:n.order??"ascending"}:_(n)?{field:An(e,t,{expr:"datum"}),order:"ascending"}:{field:E(e,{expr:"datum"}),order:n??"ascending"}}function ms(e,t,n){const{format:i,formatType:r,labelAngle:s,labelAnchor:o,labelOrient:a,labelExpr:c}=wr(["format","formatType","labelAngle","labelAnchor","labelOrient","labelExpr"],e.header,n,t),u=ao({fieldOrDatumDef:e,format:i,formatType:r,expr:"parent",config:n}).signal,l=vr(t,a);return{text:{signal:c?vn(vn(c,"datum.label",u),"datum.value",E(e,{expr:"parent"})):u},...t==="row"?{orient:"left"}:{},style:"guide-label",frame:"group",...gf(s,l),...pf(l,s,o),...hf(n,e,t,qh,dl)}}function cx(e,t,n,i,r){if(r){let s=null;const{facetFieldDef:o}=i,a=e.config?e.config:void 0;if(o&&r.labels){const{labelOrient:f}=wr(["labelOrient"],o.header,a,t);(t==="row"&&!z(["top","bottom"],f)||t==="column"&&!z(["left","right"],f))&&(s=ms(o,t,a))}const c=ke(e)&&!li(e.facet),u=r.axes,l=(u==null?void 0:u.length)>0;if(s||l){const f=t==="row"?"height":"width";return{name:e.getName(`${t}_${n}`),type:"group",role:`${t}-${n}`,...i.facetFieldDef?{from:{data:e.getName(`${t}_domain`)},sort:ax(o,t)}:{},...l&&c?{from:{data:e.getName(`facet_domain_${t}`)}}:{},...s?{title:s}:{},...r.sizeSignal?{encode:{update:{[f]:r.sizeSignal}}}:{},...l?{axes:u}:{}}}}return null}const ux={column:{start:0,end:1},row:{start:1,end:0}};function lx(e,t){return ux[t][e]}function fx(e,t){const n={};for(const i of Ce){const r=e[i];if(r!=null&&r.facetFieldDef){const{titleAnchor:s,titleOrient:o}=wr(["titleAnchor","titleOrient"],r.facetFieldDef.header,t,i),a=vr(i,o),c=lx(s,a);c!==void 0&&(n[a]=c)}}return W(n)?void 0:n}function hf(e,t,n,i,r){const s={};for(const o of i){if(!r[o])continue;const a=Pn(o,t==null?void 0:t.header,e,n);a!==void 0&&(s[r[o]]=a)}return s}function zo(e){return[...ki(e,"width"),...ki(e,"height"),...ki(e,"childWidth"),...ki(e,"childHeight")]}function ki(e,t){const n=t==="width"?"x":"y",i=e.component.layoutSize.get(t);if(i==null||i==="merged")return[];const r=e.getSizeSignalRef(t).signal;if(i==="step"){const s=e.getScaleComponent(n);if(s){const o=s.get("type"),a=s.get("range");if(oe(o)&&an(a)){const c=e.scaleName(n);return ke(e.parent)&&e.parent.component.resolve.scale[n]==="independent"?[lc(c,a)]:[lc(c,a),{name:r,update:mf(c,s,`domain('${c}').length`)}]}}throw new Error("layout size is step although width/height is not step.")}else if(i=="container"){const s=r.endsWith("width"),o=s?"containerSize()[0]":"containerSize()[1]",a=ss(e.config.view,s?"width":"height"),c=`isFinite(${o}) ? ${o} : ${a}`;return[{name:r,init:c,on:[{update:c,events:"window:resize"}]}]}else return[{name:r,value:i}]}function lc(e,t){const n=`${e}_step`;return C(t.step)?{name:n,update:t.step.signal}:{name:n,value:t.step}}function mf(e,t,n){const i=t.get("type"),r=t.get("padding"),s=te(t.get("paddingOuter"),r);let o=t.get("paddingInner");return o=i==="band"?o!==void 0?o:r:1,`bandspace(${n}, ${Pe(o)}, ${Pe(s)}) * ${e}_step`}function yf(e){return e==="childWidth"?"width":e==="childHeight"?"height":e}function xf(e,t){return b(e).reduce((n,i)=>({...n,...Dn({model:t,channelDef:e[i],vgChannel:i,mainRefFn:r=>q(r.value),invalidValueRef:void 0})}),{})}function bf(e,t){if(ke(t))return e==="theta"?"independent":"shared";if(Wn(t))return"shared";if(Bo(t))return ee(e)||e==="theta"||e==="radius"?"independent":"shared";throw new Error("invalid model type for resolve")}function Io(e,t){const n=e.scale[t],i=ee(t)?"axis":"legend";return n==="independent"?(e[i][t]==="shared"&&w(jp(t)),"independent"):e[i][t]||"shared"}const dx={...Xh,disable:1,labelExpr:1,selections:1,opacity:1,shape:1,stroke:1,fill:1,size:1,strokeWidth:1,strokeDash:1,encode:1},Sf=b(dx);class px extends kt{}const fc={symbols:gx,gradient:hx,labels:mx,entries:yx};function gx(e,{fieldOrDatumDef:t,model:n,channel:i,legendCmpt:r,legendType:s}){if(s!=="symbol")return;const{markDef:o,encoding:a,config:c,mark:u}=n,l=o.filled&&u!=="trail";let f={...Xd({},n,Hg),...ql(n,{filled:l})};const d=r.get("symbolOpacity")??c.legend.symbolOpacity,p=r.get("symbolFillColor")??c.legend.symbolFillColor,g=r.get("symbolStrokeColor")??c.legend.symbolStrokeColor,h=d===void 0?$f(a.opacity)??o.opacity:void 0;if(f.fill){if(i==="fill"||l&&i===xe)delete f.fill;else if($(f.fill,"field"))p?delete f.fill:(f.fill=q(c.legend.symbolBaseFillColor??"black"),f.fillOpacity=q(h??1));else if(_(f.fill)){const m=ys(a.fill??a.color)??o.fill??(l&&o.color);m&&(f.fill=q(m))}}if(f.stroke){if(i==="stroke"||!l&&i===xe)delete f.stroke;else if($(f.stroke,"field")||g)delete f.stroke;else if(_(f.stroke)){const m=te(ys(a.stroke||a.color),o.stroke,l?o.color:void 0);m&&(f.stroke={value:m})}}if(i!==vt){const m=v(t)&&wf(n,r,t);m?f.opacity=[{test:m,...q(h??1)},q(c.legend.unselectedOpacity)]:h&&(f.opacity=q(h))}return f={...f,...e},W(f)?void 0:f}function hx(e,{model:t,legendType:n,legendCmpt:i}){if(n!=="gradient")return;const{config:r,markDef:s,encoding:o}=t;let a={};const u=(i.get("gradientOpacity")??r.legend.gradientOpacity)===void 0?$f(o.opacity)||s.opacity:void 0;return u&&(a.opacity=q(u)),a={...a,...e},W(a)?void 0:a}function mx(e,{fieldOrDatumDef:t,model:n,channel:i,legendCmpt:r}){const s=n.legend(i)||{},o=n.config,a=v(t)?wf(n,r,t):void 0,c=a?[{test:a,value:1},{value:o.legend.unselectedOpacity}]:void 0,{format:u,formatType:l}=s;let f;Jt(l)?f=Re({fieldOrDatumDef:t,field:"datum.value",format:u,formatType:l,config:o}):u===void 0&&l===void 0&&o.customFormatTypes&&(t.type==="quantitative"&&o.numberFormatType?f=Re({fieldOrDatumDef:t,field:"datum.value",format:o.numberFormat,formatType:o.numberFormatType,config:o}):t.type==="temporal"&&o.timeFormatType&&v(t)&&t.timeUnit===void 0&&(f=Re({fieldOrDatumDef:t,field:"datum.value",format:o.timeFormat,formatType:o.timeFormatType,config:o})));const d={...c?{opacity:c}:{},...f?{text:f}:{},...e};return W(d)?void 0:d}function yx(e,{legendCmpt:t}){const n=t.get("selections");return n!=null&&n.length?{...e,fill:{value:"transparent"}}:e}function $f(e){return vf(e,(t,n)=>Math.max(t,n.value))}function ys(e){return vf(e,(t,n)=>te(t,n.value))}function vf(e,t){if(lh(e))return J(e.condition).reduce(t,e.value);if(Me(e))return e.value}function wf(e,t,n){const i=t.get("selections");if(!(i!=null&&i.length))return;const r=R(n.field);return i.map(s=>`(!length(data(${R(K(s)+tn)})) || (${s}[${r}] && indexof(${s}[${r}], datum.value) >= 0))`).join(" || ")}const dc={direction:({direction:e})=>e,format:({fieldOrDatumDef:e,legend:t,config:n})=>{const{format:i,formatType:r}=t;return Pu(e,e.type,i,r,n,!1)},formatType:({legend:e,fieldOrDatumDef:t,scaleType:n})=>{const{formatType:i}=e;return Ru(i,t,n)},gradientLength:e=>{const{legend:t,legendConfig:n}=e;return t.gradientLength??n.gradientLength??Ex(e)},labelOverlap:({legend:e,legendConfig:t,scaleType:n})=>e.labelOverlap??t.labelOverlap??kx(n),symbolType:({legend:e,markDef:t,channel:n,encoding:i})=>e.symbolType??bx(t.type,n,i.shape,t.shape),title:({fieldOrDatumDef:e,config:t})=>xn(e,t,{allowDisabling:!0}),type:({legendType:e,scaleType:t,channel:n})=>{if(yn(n)&&Xe(t)){if(e==="gradient")return}else if(e==="symbol")return;return e},values:({fieldOrDatumDef:e,legend:t})=>xx(t,e)};function xx(e,t){const n=e.values;if(_(n))return Gu(t,n);if(C(n))return n}function bx(e,t,n,i){if(t!=="shape"){const r=ys(n)??i;if(r)return r}switch(e){case"bar":case"rect":case"image":case"square":return"square";case"line":case"trail":case"rule":return"stroke";case"arc":case"point":case"circle":case"tick":case"geoshape":case"area":case"text":return"circle"}}function Sx(e){const{legend:t}=e;return te(t.type,$x(e))}function $x({channel:e,timeUnit:t,scaleType:n}){if(yn(e)){if(z(["quarter","month","day"],t))return"symbol";if(Xe(n))return"gradient"}return"symbol"}function vx({legendConfig:e,legendType:t,orient:n,legend:i}){return i.direction??e[t?"gradientDirection":"symbolDirection"]??wx(n,t)}function wx(e,t){switch(e){case"top":case"bottom":return"horizontal";case"left":case"right":case"none":case void 0:return;default:return t==="gradient"?"horizontal":void 0}}function Ex({legendConfig:e,model:t,direction:n,orient:i,scaleType:r}){const{gradientHorizontalMaxLength:s,gradientHorizontalMinLength:o,gradientVerticalMaxLength:a,gradientVerticalMinLength:c}=e;if(Xe(r))return n==="horizontal"?i==="top"||i==="bottom"?pc(t,"width",o,s):o:pc(t,"height",c,a)}function pc(e,t,n,i){return{signal:`clamp(${e.getSizeSignalRef(t).signal}, ${n}, ${i})`}}function kx(e){if(z(["quantile","threshold","log","symlog"],e))return"greedy"}function Ef(e){const t=Y(e)?_x(e):Tx(e);return e.component.legends=t,t}function _x(e){const{encoding:t}=e,n={};for(const i of[xe,...gl]){const r=ne(t[i]);!r||!e.getScaleComponent(i)||i===be&&v(r)&&r.type===Mn||(n[i]=Nx(e,i))}return n}function Cx(e,t){const n=e.scaleName(t);if(e.mark==="trail"){if(t==="color")return{stroke:n};if(t==="size")return{strokeWidth:n}}return t==="color"?e.markDef.filled?{fill:n}:{stroke:n}:{[t]:n}}function Fx(e,t,n,i){switch(t){case"disable":return n!==void 0;case"values":return!!(n!=null&&n.values);case"title":if(t==="title"&&e===(i==null?void 0:i.title))return!0}return e===(n||{})[t]}function Nx(e,t){var A;let n=e.legend(t);const{markDef:i,encoding:r,config:s}=e,o=s.legend,a=new px({},Cx(e,t));My(e,t,a);const c=n!==void 0?!n:o.disable;if(a.set("disable",c,n!==void 0),c)return a;n=n||{};const u=e.getScaleComponent(t).get("type"),l=ne(r[t]),f=v(l)?(A=se(l.timeUnit))==null?void 0:A.unit:void 0,d=n.orient||s.legend.orient||"right",p=Sx({legend:n,channel:t,timeUnit:f,scaleType:u}),g=vx({legend:n,legendType:p,orient:d,legendConfig:o}),h={legend:n,channel:t,model:e,markDef:i,encoding:r,fieldOrDatumDef:l,legendConfig:o,config:s,scaleType:u,orient:d,legendType:p,direction:g};for(const F of Sf){if(p==="gradient"&&F.startsWith("symbol")||p==="symbol"&&F.startsWith("gradient"))continue;const P=F in dc?dc[F](h):n[F];if(P!==void 0){const B=Fx(P,F,n,e.fieldDef(t));(B||s.legend[F]===void 0)&&a.set(F,P,B)}}const m=(n==null?void 0:n.encoding)??{},y=a.get("selections"),S={},k={fieldOrDatumDef:l,model:e,channel:t,legendCmpt:a,legendType:p};for(const F of["labels","legend","title","symbols","gradient","entries"]){const P=xf(m[F]??{},e),B=F in fc?fc[F](P,k):P;B!==void 0&&!W(B)&&(S[F]={...y!=null&&y.length&&v(l)?{name:`${K(l.field)}_legend_${F}`}:{},...y!=null&&y.length?{interactive:!0}:{},update:y!=null&&y.length?{...B,cursor:{value:"pointer"}}:B})}return W(S)||a.set("encode",S,!!(n!=null&&n.encoding)),a}function Tx(e){const{legends:t,resolve:n}=e.component;for(const i of e.children){Ef(i);for(const r of b(i.component.legends))n.legend[r]=Io(e.component.resolve,r),n.legend[r]==="shared"&&(t[r]=kf(t[r],i.component.legends[r]),t[r]||(n.legend[r]="independent",delete t[r]))}for(const i of b(t))for(const r of e.children)r.component.legends[i]&&n.legend[i]==="shared"&&delete r.component.legends[i];return t}function kf(e,t){var s,o,a,c;if(!e)return t.clone();const n=e.getWithExplicit("orient"),i=t.getWithExplicit("orient");if(n.explicit&&i.explicit&&n.value!==i.value)return;let r=!1;for(const u of Sf){const l=At(e.getWithExplicit(u),t.getWithExplicit(u),u,"legend",(f,d)=>{switch(u){case"symbolType":return Ox(f,d);case"title":return Jc(f,d);case"type":return r=!0,we("symbol")}return xr(f,d,u,"legend")});e.setWithExplicit(u,l)}return r&&((o=(s=e.implicit)==null?void 0:s.encode)!=null&&o.gradient&&Qr(e.implicit,["encode","gradient"]),(c=(a=e.explicit)==null?void 0:a.encode)!=null&&c.gradient&&Qr(e.explicit,["encode","gradient"])),e}function Ox(e,t){return t.value==="circle"?t:e}function Ax(e,t,n,i){var r,s;e.encode??(e.encode={}),(r=e.encode)[t]??(r[t]={}),(s=e.encode[t]).update??(s.update={}),e.encode[t].update[n]=i}function _f(e){const t=e.component.legends,n={};for(const r of b(t)){const s=e.getScaleComponent(r),o=D(s.get("domains"));if(n[o])for(const a of n[o])kf(a,t[r])||n[o].push(t[r]);else n[o]=[t[r].clone()]}return ie(n).flat().map(r=>Px(r,e.config)).filter(r=>r!==void 0)}function Px(e,t){var o,a,c;const{disable:n,labelExpr:i,selections:r,...s}=e.combine();if(!n){if(t.aria===!1&&s.aria==null&&(s.aria=!1),(o=s.encode)!=null&&o.symbols){const u=s.encode.symbols.update;u.fill&&u.fill.value!=="transparent"&&!u.stroke&&!s.stroke&&(u.stroke={value:"transparent"});for(const l of gl)s[l]&&delete u[l]}if(s.title||delete s.title,i!==void 0){let u=i;(c=(a=s.encode)==null?void 0:a.labels)!=null&&c.update&&C(s.encode.labels.update.text)&&(u=vn(i,"datum.label",s.encode.labels.update.text.signal)),Ax(s,"labels","text",{signal:u})}return s}}function Rx(e){return Wn(e)||Bo(e)?zx(e):Cf(e)}function zx(e){return e.children.reduce((t,n)=>t.concat(n.assembleProjections()),Cf(e))}function Cf(e){const t=e.component.projection;if(!t||t.merged)return[];const n=t.combine(),{name:i}=n;if(t.data){const r={signal:`[${t.size.map(o=>o.signal).join(", ")}]`},s=t.data.reduce((o,a)=>{const c=C(a)?a.signal:`data('${e.lookupDataSource(a)}')`;return z(o,c)||o.push(c),o},[]);if(s.length<=0)throw new Error("Projection's fit didn't find any data sources");return[{name:i,size:r,fit:{signal:s.length>1?`[${s.join(", ")}]`:s[0]},...n}]}else return[{name:i,translate:{signal:"[width / 2, height / 2]"},...n}]}const Ix=["type","clipAngle","clipExtent","center","rotate","precision","reflectX","reflectY","coefficient","distance","fraction","lobes","parallel","radius","ratio","spacing","tilt"];class Ff extends kt{constructor(n,i,r,s){super({...i},{name:n});x(this,"specifiedProjection");x(this,"size");x(this,"data");x(this,"merged",!1);this.specifiedProjection=i,this.size=r,this.data=s}get isFit(){return!!this.data}}function Nf(e){e.component.projection=Y(e)?Lx(e):jx(e)}function Lx(e){if(e.hasProjection){const t=ue(e.specifiedProjection),n=!(t&&(t.scale!=null||t.translate!=null)),i=n?[e.getSizeSignalRef("width"),e.getSizeSignalRef("height")]:void 0,r=n?Mx(e):void 0,s=new Ff(e.projectionName(!0),{...ue(e.config.projection),...t},i,r);return s.get("type")||s.set("type","equalEarth",!1),s}}function Mx(e){const t=[],{encoding:n}=e;for(const i of[[He,We],[Ne,qe]])(ne(n[i[0]])||ne(n[i[1]]))&&t.push({signal:e.getName(`geojson_${t.length}`)});return e.channelHasField(be)&&e.typedFieldDef(be).type===Mn&&t.push({signal:e.getName(`geojson_${t.length}`)}),t.length===0&&t.push(e.requestDataName(Q.Main)),t}function Dx(e,t){const n=Fc(Ix,r=>!!(!Z(e.explicit,r)&&!Z(t.explicit,r)||Z(e.explicit,r)&&Z(t.explicit,r)&&_e(e.get(r),t.get(r))));if(_e(e.size,t.size)){if(n)return e;if(_e(e.explicit,{}))return t;if(_e(t.explicit,{}))return e}return null}function jx(e){if(e.children.length===0)return;let t;for(const i of e.children)Nf(i);const n=Fc(e.children,i=>{const r=i.component.projection;if(r)if(t){const s=Dx(t,r);return s&&(t=s),!!s}else return t=r,!0;else return!0});if(t&&n){const i=e.projectionName(!0),r=new Ff(i,t.specifiedProjection,t.size,N(t.data));for(const s of e.children){const o=s.component.projection;o&&(o.isFit&&r.data.push(...s.component.projection.data),s.renameProjection(o.get("name"),i),o.merged=!0)}return r}}function Ux(e,t,n,i){if(pi(t,n)){const r=Y(e)?e.axis(n)??e.legend(n)??{}:{},s=E(t,{expr:"datum"}),o=E(t,{expr:"datum",binSuffix:"end"});return{formulaAs:E(t,{binSuffix:"range",forAs:!0}),formula:ui(s,o,r.format,r.formatType,i)}}return{}}function Tf(e,t){return`${qc(e)}_${t}`}function Bx(e,t){return{signal:e.getName(`${t}_bins`),extentSignal:e.getName(`${t}_extent`)}}function Lo(e,t,n){const i=dr(n,void 0)??{},r=Tf(i,t);return e.getName(`${r}_bins`)}function Wx(e){return"as"in e}function gc(e,t,n){let i,r;Wx(e)?i=T(e.as)?[e.as,`${e.as}_end`]:[e.as[0],e.as[1]]:i=[E(e,{forAs:!0}),E(e,{binSuffix:"end",forAs:!0})];const s={...dr(t,void 0)},o=Tf(s,e.field),{signal:a,extentSignal:c}=Bx(n,o);if(tr(s.extent)){const l=s.extent;r=cf(n,l.param,l),delete s.extent}const u={bin:s,field:e.field,as:[i],...a?{signal:a}:{},...c?{extentSignal:c}:{},...r?{span:r}:{}};return{key:o,binComponent:u}}class Qe extends j{constructor(n,i){super(n);x(this,"bins");this.bins=i}clone(){return new Qe(null,N(this.bins))}static makeFromEncoding(n,i){const r=i.reduceFieldDef((s,o,a)=>{if(ge(o)&&H(o.bin)){const{key:c,binComponent:u}=gc(o,o.bin,i);s[c]={...u,...s[c],...Ux(i,o,a,i.config)}}return s},{});return W(r)?null:new Qe(n,r)}static makeFromTransform(n,i,r){const{key:s,binComponent:o}=gc(i,i.bin,r);return new Qe(n,{[s]:o})}merge(n,i){for(const r of b(n.bins))r in this.bins?(i(n.bins[r].signal,this.bins[r].signal),this.bins[r].as=ut([...this.bins[r].as,...n.bins[r].as],I)):this.bins[r]=n.bins[r];for(const r of n.children)n.removeChild(r),r.parent=this;n.remove()}producedFields(){return new Set(ie(this.bins).map(n=>n.as).flat(2))}dependentFields(){return new Set(ie(this.bins).map(n=>n.field))}hash(){return`Bin ${I(this.bins)}`}assemble(){return ie(this.bins).flatMap(n=>{const i=[],[r,...s]=n.as,{extent:o,...a}=n.bin,c={type:"bin",field:Ie(n.field),as:r,signal:n.signal,...tr(o)?{extent:null}:{extent:o},...n.span?{span:{signal:`span(${n.span})`}}:{},...a};!o&&n.extentSignal&&(i.push({type:"extent",field:Ie(n.field),signal:n.extentSignal}),c.extent={signal:n.extentSignal}),i.push(c);for(const u of s)for(let l=0;l<2;l++)i.push({type:"formula",expr:E({field:r[l]},{expr:"datum"}),as:u[l]});return n.formula&&i.push({type:"formula",expr:n.formula,as:n.formulaAs}),i})}}function Hx(e,t,n,i){var s;const r=Y(i)?i.encoding[rt(t)]:void 0;if(ge(n)&&Y(i)&&Mu(n,r,i.markDef,i.config)){e.add(E(n,{})),e.add(E(n,{suffix:"end"}));const{mark:o,markDef:a,config:c}=i,u=Ot({fieldDef:n,markDef:a,config:c});Zn(o)&&u!==.5&&ee(t)&&(e.add(E(n,{suffix:br})),e.add(E(n,{suffix:Sr}))),n.bin&&pi(n,t)&&e.add(E(n,{binSuffix:"range"}))}else if(Ic(t)){const o=zc(t);e.add(i.getName(o))}else e.add(E(n));return ln(n)&&Og((s=n.scale)==null?void 0:s.range)&&e.add(n.scale.range.field),e}function qx(e,t){for(const n of b(t)){const i=t[n];for(const r of b(i))n in e?e[n][r]=new Set([...e[n][r]??[],...i[r]]):e[n]={[r]:i[r]}}}class ze extends j{constructor(n,i,r){super(n);x(this,"dimensions");x(this,"measures");this.dimensions=i,this.measures=r}clone(){return new ze(null,new Set(this.dimensions),N(this.measures))}get groupBy(){return this.dimensions}static makeFromEncoding(n,i){let r=!1;i.forEachFieldDef(a=>{a.aggregate&&(r=!0)});const s={},o=new Set;return!r||(i.forEachFieldDef((a,c)=>{const{aggregate:u,field:l}=a;if(u)if(u==="count")s["*"]??(s["*"]={}),s["*"].count=new Set([E(a,{forAs:!0})]);else{if(mt(u)||jt(u)){const f=mt(u)?"argmin":"argmax",d=u[f];s[d]??(s[d]={}),s[d][f]=new Set([E({op:f,field:d},{forAs:!0})])}else s[l]??(s[l]={}),s[l][u]=new Set([E(a,{forAs:!0})]);st(c)&&i.scaleDomain(c)==="unaggregated"&&(s[l]??(s[l]={}),s[l].min=new Set([E({field:l,aggregate:"min"},{forAs:!0})]),s[l].max=new Set([E({field:l,aggregate:"max"},{forAs:!0})]))}else Hx(o,c,a,i)}),o.size+b(s).length===0)?null:new ze(n,o,s)}static makeFromTransform(n,i){var o;const r=new Set,s={};for(const a of i.aggregate){const{op:c,field:u,as:l}=a;c&&(c==="count"?(s["*"]??(s["*"]={}),s["*"].count=new Set([l||E(a,{forAs:!0})])):(s[u]??(s[u]={}),(o=s[u])[c]??(o[c]=new Set),s[u][c].add(l||E(a,{forAs:!0}))))}for(const a of i.groupby??[])r.add(a);return r.size+b(s).length===0?null:new ze(n,r,s)}merge(n){return ld(this.dimensions,n.dimensions)?(qx(this.measures,n.measures),!0):(ng("different dimensions, cannot merge"),!1)}addDimensions(n){n.forEach(this.dimensions.add,this.dimensions)}dependentFields(){return new Set([...this.dimensions,...b(this.measures)])}producedFields(){const n=new Set;for(const i of b(this.measures))for(const r of b(this.measures[i])){const s=this.measures[i][r];s.size===0?n.add(`${r}_${i}`):s.forEach(n.add,n)}return n}hash(){return`Aggregate ${I({dimensions:this.dimensions,measures:this.measures})}`}assemble(){const n=[],i=[],r=[];for(const o of b(this.measures))for(const a of b(this.measures[o]))for(const c of this.measures[o][a])r.push(c),n.push(a),i.push(o==="*"?null:Ie(o));return{type:"aggregate",groupby:[...this.dimensions].map(Ie),ops:n,fields:i,as:r}}}class Un extends j{constructor(n,i,r,s){super(n);x(this,"model");x(this,"name");x(this,"data");x(this,"column");x(this,"row");x(this,"facet");x(this,"childModel");this.model=i,this.name=r,this.data=s;for(const o of Ce){const a=i.facet[o];if(a){const{bin:c,sort:u}=a;this[o]={name:i.getName(`${o}_domain`),fields:[E(a),...H(c)?[E(a,{binSuffix:"end"})]:[]],...pt(u)?{sortField:u}:_(u)?{sortIndexField:An(a,o)}:{}}}}this.childModel=i.child}hash(){let n="Facet";for(const i of Ce)this[i]&&(n+=` ${i.charAt(0)}:${I(this[i])}`);return n}get fields(){var i;const n=[];for(const r of Ce)(i=this[r])!=null&&i.fields&&n.push(...this[r].fields);return n}dependentFields(){const n=new Set(this.fields);for(const i of Ce)this[i]&&(this[i].sortField&&n.add(this[i].sortField.field),this[i].sortIndexField&&n.add(this[i].sortIndexField));return n}producedFields(){return new Set}getSource(){return this.name}getChildIndependentFieldsWithStep(){const n={};for(const i of wt){const r=this.childModel.component.scales[i];if(r&&!r.merged){const s=r.get("type"),o=r.get("range");if(oe(s)&&an(o)){const a=Er(this.childModel,i),c=Uo(a);c?n[i]=c:w(Ms(i))}}}return n}assembleRowColumnHeaderData(n,i,r){const s={row:"y",column:"x",facet:void 0}[n],o=[],a=[],c=[];s&&r&&r[s]&&(i?(o.push(`distinct_${r[s]}`),a.push("max")):(o.push(r[s]),a.push("distinct")),c.push(`distinct_${r[s]}`));const{sortField:u,sortIndexField:l}=this[n];if(u){const{op:f=ur,field:d}=u;o.push(d),a.push(f),c.push(E(u,{forAs:!0}))}else l&&(o.push(l),a.push("max"),c.push(l));return{name:this[n].name,source:i??this.data,transform:[{type:"aggregate",groupby:this[n].fields,...o.length?{fields:o,ops:a,as:c}:{}}]}}assembleFacetHeaderData(n){var u,l;const{columns:i}=this.model.layout,{layoutHeaders:r}=this.model.component,s=[],o={};for(const f of Po){for(const d of Ro){const p=((u=r[f])==null?void 0:u[d])??[];for(const g of p)if(((l=g.axes)==null?void 0:l.length)>0){o[f]=!0;break}}if(o[f]){const d=`length(data("${this.facet.name}"))`,p=f==="row"?i?{signal:`ceil(${d} / ${i})`}:1:i?{signal:`min(${d}, ${i})`}:{signal:d};s.push({name:`${this.facet.name}_${f}`,transform:[{type:"sequence",start:0,stop:p}]})}}const{row:a,column:c}=o;return(a||c)&&s.unshift(this.assembleRowColumnHeaderData("facet",null,n)),s}assemble(){const n=[];let i=null;const r=this.getChildIndependentFieldsWithStep(),{column:s,row:o,facet:a}=this;if(s&&o&&(r.x||r.y)){i=`cross_${this.column.name}_${this.row.name}`;const c=[].concat(r.x??[],r.y??[]),u=c.map(()=>"distinct");n.push({name:i,source:this.data,transform:[{type:"aggregate",groupby:this.fields,fields:c,ops:u}]})}for(const c of[dt,ft])this[c]&&n.push(this.assembleRowColumnHeaderData(c,i,r));if(a){const c=this.assembleFacetHeaderData(r);c&&n.push(...c)}return n}}function hc(e){return e.startsWith("'")&&e.endsWith("'")||e.startsWith('"')&&e.endsWith('"')?e.slice(1,-1):e}function Gx(e,t){const n=Oc(e);if(t==="number")return`toNumber(${n})`;if(t==="boolean")return`toBoolean(${n})`;if(t==="string")return`toString(${n})`;if(t==="date")return`toDate(${n})`;if(t==="flatten")return n;if(t.startsWith("date:")){const i=hc(t.slice(5,t.length));return`timeParse(${n},'${i}')`}else if(t.startsWith("utc:")){const i=hc(t.slice(4,t.length));return`utcParse(${n},'${i}')`}else return w(fp(t)),null}function Vx(e){const t={};return Ni(e.filter,n=>{if(mu(n)){let i=null;Hs(n)?i=Ee(n.equal):Gs(n)?i=Ee(n.lte):qs(n)?i=Ee(n.lt):Vs(n)?i=Ee(n.gt):Xs(n)?i=Ee(n.gte):Ys(n)?i=n.range[0]:Ks(n)&&(i=(n.oneOf??n.in)[0]),i&&(cn(i)?t[n.field]="date":G(i)?t[n.field]="number":T(i)&&(t[n.field]="string")),n.timeUnit&&(t[n.field]="date")}}),t}function Xx(e){const t={};function n(i){Fn(i)?t[i.field]="date":i.type==="quantitative"&&Md(i.aggregate)?t[i.field]="number":Qn(i.field)>1?i.field in t||(t[i.field]="flatten"):ln(i)&&pt(i.sort)&&Qn(i.sort.field)>1&&(i.sort.field in t||(t[i.sort.field]="flatten"))}if((Y(e)||ke(e))&&e.forEachFieldDef((i,r)=>{if(ge(i))n(i);else{const s=sn(r),o=e.fieldDef(s);n({...i,type:o.type})}}),Y(e)){const{mark:i,markDef:r,encoding:s}=e;if(Ut(i)&&!e.encoding.order){const o=r.orient==="horizontal"?"y":"x",a=s[o];v(a)&&a.type==="quantitative"&&!(a.field in t)&&(t[a.field]="number")}}return t}function Yx(e){const t={};if(Y(e)&&e.component.selection)for(const n of b(e.component.selection)){const i=e.component.selection[n];for(const r of i.project.items)!r.channel&&Qn(r.field)>1&&(t[r.field]="flatten")}return t}class de extends j{constructor(n,i){super(n);x(this,"_parse");this._parse=i}clone(){return new de(null,N(this._parse))}hash(){return`Parse ${I(this._parse)}`}static makeExplicit(n,i,r){var a;let s={};const o=i.data;return!Nt(o)&&((a=o==null?void 0:o.format)!=null&&a.parse)&&(s=o.format.parse),this.makeWithAncestors(n,s,{},r)}static makeWithAncestors(n,i,r,s){for(const c of b(r)){const u=s.getWithExplicit(c);u.value!==void 0&&(u.explicit||u.value===r[c]||u.value==="derived"||r[c]==="flatten"?delete r[c]:w(ka(c,r[c],u.value)))}for(const c of b(i)){const u=s.get(c);u!==void 0&&(u===i[c]?delete i[c]:w(ka(c,i[c],u)))}const o=new kt(i,r);s.copyAll(o);const a={};for(const c of b(o.combine())){const u=o.get(c);u!==null&&(a[c]=u)}return b(a).length===0||s.parseNothing?null:new de(n,a)}get parse(){return this._parse}merge(n){this._parse={...this._parse,...n.parse},n.remove()}assembleFormatParse(){const n={};for(const i of b(this._parse)){const r=this._parse[i];Qn(i)===1&&(n[i]=r)}return n}producedFields(){return new Set(b(this._parse))}dependentFields(){return new Set(b(this._parse))}assembleTransforms(n=!1){return b(this._parse).filter(i=>n?Qn(i)>1:!0).map(i=>{const r=Gx(i,this._parse[i]);return r?{type:"formula",expr:r,as:ii(i)}:null}).filter(i=>i!==null)}}class Pt extends j{clone(){return new Pt(null)}constructor(t){super(t)}dependentFields(){return new Set}producedFields(){return new Set([je])}hash(){return"Identifier"}assemble(){return{type:"identifier",as:je}}}class mi extends j{constructor(n,i){super(n);x(this,"params");this.params=i}clone(){return new mi(null,this.params)}dependentFields(){return new Set}producedFields(){}hash(){return`Graticule ${I(this.params)}`}assemble(){return{type:"graticule",...this.params===!0?{}:this.params}}}class yi extends j{constructor(n,i){super(n);x(this,"params");this.params=i}clone(){return new yi(null,this.params)}dependentFields(){return new Set}producedFields(){return new Set([this.params.as??"data"])}hash(){return`Hash ${I(this.params)}`}assemble(){return{type:"sequence",...this.params}}}class nn extends j{constructor(n){super(null);x(this,"_data");x(this,"_name");x(this,"_generator");n??(n={name:"source"});let i;if(Nt(n)||(i=n.format?{...Fe(n.format,["parse"])}:{}),Jn(n))this._data={values:n.values};else if(Nn(n)){if(this._data={url:n.url},!i.type){let r=/(?:\.([^.]+))?$/.exec(n.url)[1];z(["json","csv","tsv","dsv","topojson"],r)||(r="json"),i.type=r}}else Al(n)?this._data={values:[{type:"Sphere"}]}:(Tl(n)||Nt(n))&&(this._data={});this._generator=Nt(n),n.name&&(this._name=n.name),i&&!W(i)&&(this._data.format=i)}dependentFields(){return new Set}producedFields(){}get data(){return this._data}hasName(){return!!this._name}get isGenerator(){return this._generator}get dataName(){return this._name}set dataName(n){this._name=n}set parent(n){throw new Error("Source nodes have to be roots.")}remove(){throw new Error("Source nodes are roots and cannot be removed.")}hash(){throw new Error("Cannot hash sources")}assemble(){return{name:this._name,...this._data,transform:[]}}}function Mo(e){return e instanceof nn||e instanceof mi||e instanceof yi}var $n;class Do{constructor(){pa(this,$n);zr(this,$n,!1)}setModified(){zr(this,$n,!0)}get modifiedFlag(){return da(this,$n)}}$n=new WeakMap;class fn extends Do{getNodeDepths(t,n,i){i.set(t,n);for(const r of t.children)this.getNodeDepths(r,n+1,i);return i}optimize(t){const i=[...this.getNodeDepths(t,0,new Map).entries()].sort((r,s)=>s[1]-r[1]);for(const r of i)this.run(r[0]);return this.modifiedFlag}}class jo extends Do{optimize(t){this.run(t);for(const n of t.children)this.optimize(n);return this.modifiedFlag}}class Kx extends jo{mergeNodes(t,n){const i=n.shift();for(const r of n)t.removeChild(r),r.parent=i,r.remove()}run(t){const n=t.children.map(r=>r.hash()),i={};for(let r=0;r<n.length;r++)i[n[r]]===void 0?i[n[r]]=[t.children[r]]:i[n[r]].push(t.children[r]);for(const r of b(i))i[r].length>1&&(this.setModified(),this.mergeNodes(t,i[r]))}}class Qx extends jo{constructor(n){super();x(this,"requiresSelectionId");this.requiresSelectionId=n&&Ao(n)}run(n){n instanceof Pt&&(this.requiresSelectionId&&(Mo(n.parent)||n.parent instanceof ze||n.parent instanceof de)||(this.setModified(),n.remove()))}}class Zx extends Do{optimize(t){return this.run(t,new Set),this.modifiedFlag}run(t,n){let i=new Set;t instanceof Ye&&(i=t.producedFields(),Nc(i,n)&&(this.setModified(),t.removeFormulas(n),t.producedFields.length===0&&t.remove()));for(const r of t.children)this.run(r,new Set([...n,...i]))}}class Jx extends jo{constructor(){super()}run(t){t instanceof ye&&!t.isRequired()&&(this.setModified(),t.remove())}}class eb extends fn{run(t){if(!Mo(t)&&!(t.numChildren()>1)){for(const n of t.children)if(n instanceof de)if(t instanceof de)this.setModified(),t.merge(n);else{if(Tc(t.producedFields(),n.dependentFields()))continue;this.setModified(),n.swapWithParent()}}}}class tb extends fn{run(t){const n=[...t.children],i=t.children.filter(r=>r instanceof de);if(t.numChildren()>1&&i.length>=1){const r={},s=new Set;for(const o of i){const a=o.parse;for(const c of b(a))c in r?r[c]!==a[c]&&s.add(c):r[c]=a[c]}for(const o of s)delete r[o];if(!W(r)){this.setModified();const o=new de(t,r);for(const a of n){if(a instanceof de)for(const c of b(r))delete a.parse[c];t.removeChild(a),a.parent=o,a instanceof de&&b(a.parse).length===0&&a.remove()}}}}}class nb extends fn{run(t){t instanceof ye||t.numChildren()>0||t instanceof Un||t instanceof nn||(this.setModified(),t.remove())}}class ib extends fn{run(t){const n=t.children.filter(r=>r instanceof Ye),i=n.pop();for(const r of n)this.setModified(),i.merge(r)}}class rb extends fn{run(t){const n=t.children.filter(r=>r instanceof ze),i={};for(const r of n){const s=I(r.groupBy);s in i||(i[s]=[]),i[s].push(r)}for(const r of b(i)){const s=i[r];if(s.length>1){const o=s.pop();for(const a of s)o.merge(a)&&(t.removeChild(a),a.parent=o,a.remove(),this.setModified())}}}}class sb extends fn{constructor(n){super();x(this,"model");this.model=n}run(n){const i=!(Mo(n)||n instanceof jn||n instanceof de||n instanceof Pt),r=[],s=[];for(const o of n.children)o instanceof Qe&&(i&&!Tc(n.producedFields(),o.dependentFields())?r.push(o):s.push(o));if(r.length>0){const o=r.pop();for(const a of r)o.merge(a,this.model.renameSignal.bind(this.model));this.setModified(),n instanceof Qe?n.merge(o,this.model.renameSignal.bind(this.model)):o.swapWithParent()}if(s.length>1){const o=s.pop();for(const a of s)o.merge(a,this.model.renameSignal.bind(this.model));this.setModified()}}}class ob extends fn{run(t){const n=[...t.children];if(!Kn(n,o=>o instanceof ye)||t.numChildren()<=1)return;const r=[];let s;for(const o of n)if(o instanceof ye){let a=o;for(;a.numChildren()===1;){const[c]=a.children;if(c instanceof ye)a=c;else break}r.push(...a.children),s?(t.removeChild(o),o.parent=s.parent,s.parent.removeChild(s),s.parent=a,this.setModified()):s=a}else r.push(o);if(r.length){this.setModified();for(const o of r)o.parent.removeChild(o),o.parent=s}}}class dn extends j{constructor(n,i){super(n);x(this,"transform");this.transform=i}clone(){return new dn(null,N(this.transform))}addDimensions(n){this.transform.groupby=ut(this.transform.groupby.concat(n),i=>i)}dependentFields(){const n=new Set;return this.transform.groupby&&this.transform.groupby.forEach(n.add,n),this.transform.joinaggregate.map(i=>i.field).filter(i=>i!==void 0).forEach(n.add,n),n}producedFields(){return new Set(this.transform.joinaggregate.map(this.getDefaultName))}getDefaultName(n){return n.as??E(n)}hash(){return`JoinAggregateTransform ${I(this.transform)}`}assemble(){const n=[],i=[],r=[];for(const o of this.transform.joinaggregate)i.push(o.op),r.push(this.getDefaultName(o)),n.push(o.field===void 0?null:o.field);const s=this.transform.groupby;return{type:"joinaggregate",as:r,ops:i,fields:n,...s!==void 0?{groupby:s}:{}}}}class Rn extends j{constructor(n,i){super(n);x(this,"filter");this.filter=i}clone(){return new Rn(null,{...this.filter})}static make(n,i,r){const{config:s,markDef:o}=i,{marks:a,scales:c}=r;if(a==="include-invalid-values"&&c==="include-invalid-values")return null;const u=i.reduceFieldDef((l,f,d)=>{const p=st(d)&&i.getScaleComponent(d);if(p){const g=p.get("type"),{aggregate:h}=f,m=ro({scaleChannel:d,markDef:o,config:s,scaleType:g,isCountAggregate:er(h)});m!=="show"&&m!=="always-valid"&&(l[f.field]=f)}return l},{});return b(u).length?new Rn(n,u):null}dependentFields(){return new Set(b(this.filter))}producedFields(){return new Set}hash(){return`FilterInvalid ${I(this.filter)}`}assemble(){const n=b(this.filter).reduce((i,r)=>{const s=this.filter[r],o=E(s,{expr:"datum"});return s!==null&&(s.type==="temporal"?i.push(`(isDate(${o}) || (${xs(o)}))`):s.type==="quantitative"&&i.push(xs(o))),i},[]);return n.length>0?{type:"filter",expr:n.join(" && ")}:null}}function xs(e){return`isValid(${e}) && isFinite(+${e})`}function ab(e){return e.stack.stackBy.reduce((t,n)=>{const i=n.fieldDef,r=E(i);return r&&t.push(r),t},[])}function cb(e){return _(e)&&e.every(t=>T(t))&&e.length>1}class ht extends j{constructor(n,i){super(n);x(this,"_stack");this._stack=i}clone(){return new ht(null,N(this._stack))}static makeFromTransform(n,i){const{stack:r,groupby:s,as:o,offset:a="zero"}=i,c=[],u=[];if(i.sort!==void 0)for(const d of i.sort)c.push(d.field),u.push(te(d.order,"ascending"));const l={field:c,order:u};let f;return cb(o)?f=o:T(o)?f=[o,`${o}_end`]:f=[`${i.stack}_start`,`${i.stack}_end`],new ht(n,{dimensionFieldDefs:[],stackField:r,groupby:s,offset:a,sort:l,facetby:[],as:f})}static makeFromEncoding(n,i){const r=i.stack,{encoding:s}=i;if(!r)return null;const{groupbyChannels:o,fieldChannel:a,offset:c,impute:u}=r,l=o.map(g=>{const h=s[g];return De(h)}).filter(g=>!!g),f=ab(i),d=i.encoding.order;let p;if(_(d)||v(d))p=Kc(d);else{const g=Du(d)?d.sort:a==="y"?"descending":"ascending";p=f.reduce((h,m)=>(h.field.includes(m)||(h.field.push(m),h.order.push(g)),h),{field:[],order:[]})}return new ht(n,{dimensionFieldDefs:l,stackField:i.vgField(a),facetby:[],stackby:f,sort:p,offset:c,impute:u,as:[i.vgField(a,{suffix:"start",forAs:!0}),i.vgField(a,{suffix:"end",forAs:!0})]})}get stack(){return this._stack}addDimensions(n){this._stack.facetby.push(...n)}dependentFields(){const n=new Set;return n.add(this._stack.stackField),this.getGroupbyFields().forEach(n.add,n),this._stack.facetby.forEach(n.add,n),this._stack.sort.field.forEach(n.add,n),n}producedFields(){return new Set(this._stack.as)}hash(){return`Stack ${I(this._stack)}`}getGroupbyFields(){const{dimensionFieldDefs:n,impute:i,groupby:r}=this._stack;return n.length>0?n.map(s=>s.bin?i?[E(s,{binSuffix:"mid"})]:[E(s,{}),E(s,{binSuffix:"end"})]:[E(s)]).flat():r??[]}assemble(){const n=[],{facetby:i,dimensionFieldDefs:r,stackField:s,stackby:o,sort:a,offset:c,impute:u,as:l}=this._stack;if(u)for(const f of r){const{bandPosition:d=.5,bin:p}=f;if(p){const g=E(f,{expr:"datum"}),h=E(f,{expr:"datum",binSuffix:"end"});n.push({type:"formula",expr:`${xs(g)} ? ${d}*${g}+${1-d}*${h} : ${g}`,as:E(f,{binSuffix:"mid",forAs:!0})})}n.push({type:"impute",field:s,groupby:[...o,...i],key:E(f,{binSuffix:"mid"}),method:"value",value:0})}return n.push({type:"stack",groupby:[...this.getGroupbyFields(),...i],field:s,sort:a,as:l,offset:c}),n}}class Bn extends j{constructor(n,i){super(n);x(this,"transform");this.transform=i}clone(){return new Bn(null,N(this.transform))}addDimensions(n){this.transform.groupby=ut(this.transform.groupby.concat(n),i=>i)}dependentFields(){const n=new Set;return(this.transform.groupby??[]).forEach(n.add,n),(this.transform.sort??[]).forEach(i=>n.add(i.field)),this.transform.window.map(i=>i.field).filter(i=>i!==void 0).forEach(n.add,n),n}producedFields(){return new Set(this.transform.window.map(this.getDefaultName))}getDefaultName(n){return n.as??E(n)}hash(){return`WindowTransform ${I(this.transform)}`}assemble(){const n=[],i=[],r=[],s=[];for(const d of this.transform.window)i.push(d.op),r.push(this.getDefaultName(d)),s.push(d.param===void 0?null:d.param),n.push(d.field===void 0?null:d.field);const o=this.transform.frame,a=this.transform.groupby;if(o&&o[0]===null&&o[1]===null&&i.every(d=>Is(d)))return{type:"joinaggregate",as:r,ops:i,fields:n,...a!==void 0?{groupby:a}:{}};const c=[],u=[];if(this.transform.sort!==void 0)for(const d of this.transform.sort)c.push(d.field),u.push(d.order??"ascending");const l={field:c,order:u},f=this.transform.ignorePeers;return{type:"window",params:s,as:r,ops:i,fields:n,sort:l,...f!==void 0?{ignorePeers:f}:{},...a!==void 0?{groupby:a}:{},...o!==void 0?{frame:o}:{}}}}function ub(e){function t(n){if(!(n instanceof Un)){const i=n.clone();if(i instanceof ye){const r=Ss+i.getSource();i.setSource(r),e.model.component.data.outputNodes[r]=i}else(i instanceof ze||i instanceof ht||i instanceof Bn||i instanceof dn)&&i.addDimensions(e.fields);for(const r of n.children.flatMap(t))r.parent=i;return[i]}return n.children.flatMap(t)}return t}function bs(e){if(e instanceof Un)if(e.numChildren()===1&&!(e.children[0]instanceof ye)){const t=e.children[0];(t instanceof ze||t instanceof ht||t instanceof Bn||t instanceof dn)&&t.addDimensions(e.fields),t.swapWithParent(),bs(e)}else{const t=e.model.component.data.main;Of(t);const n=ub(e),i=e.children.map(n).flat();for(const r of i)r.parent=t}else e.children.map(bs)}function Of(e){if(e instanceof ye&&e.type===Q.Main&&e.numChildren()===1){const t=e.children[0];t instanceof Un||(t.swapWithParent(),Of(e))}}const Ss="scale_",_i=5;function $s(e){for(const t of e){for(const n of t.children)if(n.parent!==t)return!1;if(!$s(t.children))return!1}return!0}function Ae(e,t){let n=!1;for(const i of t)n=e.optimize(i)||n;return n}function mc(e,t,n){let i=e.sources,r=!1;return r=Ae(new Jx,i)||r,r=Ae(new Qx(t),i)||r,i=i.filter(s=>s.numChildren()>0),r=Ae(new nb,i)||r,i=i.filter(s=>s.numChildren()>0),n||(r=Ae(new eb,i)||r,r=Ae(new sb(t),i)||r,r=Ae(new Zx,i)||r,r=Ae(new tb,i)||r,r=Ae(new rb,i)||r,r=Ae(new ib,i)||r,r=Ae(new Kx,i)||r,r=Ae(new ob,i)||r),e.sources=i,r}function lb(e,t){$s(e.sources);let n=0,i=0;for(let r=0;r<_i&&mc(e,t,!0);r++)n++;e.sources.map(bs);for(let r=0;r<_i&&mc(e,t,!1);r++)i++;$s(e.sources),Math.max(n,i)===_i&&w(`Maximum optimization runs(${_i}) reached.`)}class re{constructor(t){x(this,"signal");Object.defineProperty(this,"signal",{enumerable:!0,get:t})}static fromName(t,n){return new re(()=>t(n))}}function Af(e){Y(e)?fb(e):db(e)}function fb(e){const t=e.component.scales;for(const n of b(t)){const i=gb(e,n);if(t[n].setWithExplicit("domains",i),mb(e,n),e.component.data.isFaceted){let s=e;for(;!ke(s)&&s.parent;)s=s.parent;if(s.component.resolve.scale[n]==="shared")for(const a of i.value)lt(a)&&(a.data=Ss+a.data.replace(Ss,""))}}}function db(e){for(const n of e.children)Af(n);const t=e.component.scales;for(const n of b(t)){let i,r=null;for(const s of e.children){const o=s.component.scales[n];if(o){i===void 0?i=o.getWithExplicit("domains"):i=At(i,o.getWithExplicit("domains"),"domains","scale",vs);const a=o.get("selectionExtent");r&&a&&r.param!==a.param&&w(rp),r=a}}t[n].setWithExplicit("domains",i),r&&t[n].set("selectionExtent",r,!0)}}function pb(e,t,n,i){if(e==="unaggregated"){const{valid:r,reason:s}=yc(t,n);if(!r){w(s);return}}else if(e===void 0&&i.useUnaggregatedDomain){const{valid:r}=yc(t,n);if(r)return"unaggregated"}return e}function gb(e,t){const n=e.getScaleComponent(t).get("type"),{encoding:i}=e,r=pb(e.scaleDomain(t),e.typedFieldDef(t),n,e.config.scale);return r!==e.scaleDomain(t)&&(e.specifiedScales[t]={...e.specifiedScales[t],domain:r}),t==="x"&&ne(i.x2)?ne(i.x)?At(_t(n,r,e,"x"),_t(n,r,e,"x2"),"domain","scale",vs):_t(n,r,e,"x2"):t==="y"&&ne(i.y2)?ne(i.y)?At(_t(n,r,e,"y"),_t(n,r,e,"y2"),"domain","scale",vs):_t(n,r,e,"y2"):_t(n,r,e,t)}function hb(e,t,n){return e.map(i=>({signal:`{data: ${pr(i,{timeUnit:n,type:t})}}`}))}function Xr(e,t,n){var r;const i=(r=se(n))==null?void 0:r.unit;return t==="temporal"||i?hb(e,t,i):[e]}function _t(e,t,n,i){const{encoding:r,markDef:s,mark:o,config:a,stack:c}=n,u=ne(r[i]),{type:l}=u,f=u.timeUnit,d=cy({invalid:Ze("invalid",s,a),isPath:Ut(o)});if(Tg(t)){const h=_t(e,void 0,n,i),m=Xr(t.unionWith,l,f);return Ve([...m,...h.value])}else{if(C(t))return Ve([t]);if(t&&t!=="unaggregated"&&!vu(t))return Ve(Xr(t,l,f))}if(c&&i===c.fieldChannel){if(c.offset==="normalize")return we([[0,1]]);const h=n.requestDataName(d);return we([{data:h,field:n.vgField(i,{suffix:"start"})},{data:h,field:n.vgField(i,{suffix:"end"})}])}const p=st(i)&&v(u)?yb(n,i,e):void 0;if(ot(u)){const h=Xr([u.datum],l,f);return we(h)}const g=u;if(t==="unaggregated"){const{field:h}=u;return we([{data:n.requestDataName(d),field:E({field:h,aggregate:"min"})},{data:n.requestDataName(d),field:E({field:h,aggregate:"max"})}])}else if(H(g.bin)){if(oe(e))return we(e==="bin-ordinal"?[]:[{data:Ai(p)?n.requestDataName(d):n.requestDataName(Q.Raw),field:n.vgField(i,pi(g,i)?{binSuffix:"range"}:{}),sort:p===!0||!L(p)?{field:n.vgField(i,{}),op:"min"}:p}]);{const{bin:h}=g;if(H(h)){const m=Lo(n,g.field,h);return we([new re(()=>{const y=n.getSignalName(m);return`[${y}.start, ${y}.stop]`})])}else return we([{data:n.requestDataName(d),field:n.vgField(i,{})}])}}else if(g.timeUnit&&z(["time","utc"],e)){const h=r[rt(i)];if(Mu(g,h,s,a)){const m=n.requestDataName(d),y=Ot({fieldDef:g,fieldDef2:h,markDef:s,config:a}),S=Zn(o)&&y!==.5&&ee(i);return we([{data:m,field:n.vgField(i,S?{suffix:br}:{})},{data:m,field:n.vgField(i,{suffix:S?Sr:"end"})}])}}return we(p?[{data:Ai(p)?n.requestDataName(d):n.requestDataName(Q.Raw),field:n.vgField(i),sort:p}]:[{data:n.requestDataName(d),field:n.vgField(i)}])}function Yr(e,t){const{op:n,field:i,order:r}=e;return{op:n??(t?"sum":ur),...i?{field:Ie(i)}:{},...r?{order:r}:{}}}function mb(e,t){var a;const n=e.component.scales[t],i=e.specifiedScales[t].domain,r=(a=e.fieldDef(t))==null?void 0:a.bin,s=vu(i)?i:void 0,o=on(r)&&tr(r.extent)?r.extent:void 0;(s||o)&&n.set("selectionExtent",s??o,!0)}function yb(e,t,n){if(!oe(n))return;const i=e.fieldDef(t),r=i.sort;if(Iu(r))return{op:"min",field:An(i,t),order:"ascending"};const{stack:s}=e,o=s?new Set([...s.groupbyFields,...s.stackBy.map(a=>a.fieldDef.field)]):void 0;if(pt(r)){const a=s&&!o.has(r.field);return Yr(r,a)}else if(ah(r)){const{encoding:a,order:c}=r,u=e.fieldDef(a),{aggregate:l,field:f}=u,d=s&&!o.has(f);if(mt(l)||jt(l))return Yr({field:E(u),order:c},d);if(Is(l)||!l)return Yr({op:l,field:f,order:c},d)}else{if(r==="descending")return{op:"min",field:e.vgField(t),order:"descending"};if(z(["ascending",void 0],r))return!0}}function yc(e,t){const{aggregate:n,type:i}=e;return n?T(n)&&!jd.has(n)?{valid:!1,reason:Pp(n)}:i==="quantitative"&&t==="log"?{valid:!1,reason:Rp(e)}:{valid:!0}:{valid:!1,reason:Ap(e)}}function vs(e,t,n,i){return e.explicit&&t.explicit&&w(Dp(n,i,e.value,t.value)),{explicit:e.explicit,value:[...e.value,...t.value]}}function xb(e){const t=ut(e.map(o=>{if(lt(o)){const{sort:a,...c}=o;return c}return o}),I),n=ut(e.map(o=>{if(lt(o)){const a=o.sort;return a!==void 0&&!Ai(a)&&("op"in a&&a.op==="count"&&delete a.field,a.order==="ascending"&&delete a.order),a}}).filter(o=>o!==void 0),I);if(t.length===0)return;if(t.length===1){const o=e[0];if(lt(o)&&n.length>0){let a=n[0];if(n.length>1){w(Ca);const c=n.filter(u=>L(u)&&"op"in u&&u.op!=="min");n.every(u=>L(u)&&"op"in u)&&c.length===1?a=c[0]:a=!0}else if(L(a)&&"field"in a){const c=a.field;o.field===c&&(a=a.order?{order:a.order}:!0)}return{...o,sort:a}}return o}const i=ut(n.map(o=>Ai(o)||!("op"in o)||T(o.op)&&Z(Id,o.op)?o:(w(Up(o)),!0)),I);let r;i.length===1?r=i[0]:i.length>1&&(w(Ca),r=!0);const s=ut(e.map(o=>lt(o)?o.data:null),o=>o);return s.length===1&&s[0]!==null?{data:s[0],fields:t.map(a=>a.field),...r?{sort:r}:{}}:{fields:t,...r?{sort:r}:{}}}function Uo(e){if(lt(e)&&T(e.field))return e.field;if(Ud(e)){let t;for(const n of e.fields)if(lt(n)&&T(n.field)){if(!t)t=n.field;else if(t!==n.field)return w(Bp),t}return w(Wp),t}else if(Bd(e)){w(Hp);const t=e.fields[0];return T(t)?t:void 0}}function Er(e,t){const i=e.component.scales[t].get("domains").map(r=>(lt(r)&&(r.data=e.lookupDataSource(r.data)),r));return xb(i)}function Pf(e){return Wn(e)||Bo(e)?e.children.reduce((t,n)=>t.concat(Pf(n)),xc(e)):xc(e)}function xc(e){return b(e.component.scales).reduce((t,n)=>{const i=e.component.scales[n];if(i.merged)return t;const r=i.combine(),{name:s,type:o,selectionExtent:a,domains:c,range:u,reverse:l,...f}=r,d=bb(r.range,s,n,e),p=Er(e,n),g=a?by(e,a,i,p):null;return t.push({name:s,type:o,...p?{domain:p}:{},...g?{domainRaw:g}:{},range:d,...l!==void 0?{reverse:l}:{},...f}),t},[])}function bb(e,t,n,i){if(ee(n)){if(an(e))return{step:{signal:`${t}_step`}}}else if(L(e)&&lt(e))return{...e,data:i.lookupDataSource(e.data)};return e}class Rf extends kt{constructor(n,i){super({},{name:n});x(this,"merged",!1);this.setWithExplicit("type",i)}domainHasZero(){const n=this.get("type");if(z([le.LOG,le.TIME,le.UTC],n))return"definitely-not";const i=this.get("zero");if(i===!0||i===void 0&&z([le.LINEAR,le.SQRT,le.POW],n))return"definitely";const r=this.get("domains");if(r.length>0){let s=!1,o=!1,a=!1;for(const c of r){if(_(c)){const u=c[0],l=c[c.length-1];if(G(u)&&G(l))if(u<=0&&l>=0){s=!0;continue}else{o=!0;continue}}a=!0}if(s)return"definitely";if(o&&!a)return"definitely-not"}return"maybe"}}const Sb=["range","scheme"];function $b(e){const t=e.component.scales;for(const n of zs){const i=t[n];if(!i)continue;const r=vb(n,e);i.setWithExplicit("range",r)}}function bc(e,t){const n=e.fieldDef(t);if(n!=null&&n.bin){const{bin:i,field:r}=n,s=Se(t),o=e.getName(s);if(L(i)&&i.binned&&i.step!==void 0)return new re(()=>{const a=e.scaleName(t),c=`(domain("${a}")[1] - domain("${a}")[0]) / ${i.step}`;return`${e.getSignalName(o)} / (${c})`});if(H(i)){const a=Lo(e,r,i);return new re(()=>{const c=e.getSignalName(a),u=`(${c}.stop - ${c}.start) / ${c}.step`;return`${e.getSignalName(o)} / (${u})`})}}}function vb(e,t){const n=t.specifiedScales[e],{size:i}=t,s=t.getScaleComponent(e).get("type");for(const f of Sb)if(n[f]!==void 0){const d=ns(s,f),p=wu(e,f);if(!d)w(iu(s,f,e));else if(p)w(p);else switch(f){case"range":{const g=n.range;if(_(g)){if(ee(e))return Ve(g.map(h=>{if(h==="width"||h==="height"){const m=t.getName(h),y=t.getSignalName.bind(t);return re.fromName(y,m)}return h}))}else if(L(g))return Ve({data:t.requestDataName(Q.Main),field:g.field,sort:{op:"min",field:t.vgField(e)}});return Ve(g)}case"scheme":return Ve(wb(n[f]))}}const o=e===V||e==="xOffset"?"width":"height",a=i[o];if(et(a)){if(ee(e))if(oe(s)){const f=If(a,t,e);if(f)return Ve({step:f})}else w(ru(o));else if(oi(e)){const f=e===Rt?"x":"y";if(t.getScaleComponent(f).get("type")==="band"){const g=Lf(a,s);if(g)return Ve(g)}}}const{rangeMin:c,rangeMax:u}=n,l=Eb(e,t);return(c!==void 0||u!==void 0)&&ns(s,"rangeMin")&&_(l)&&l.length===2?Ve([c??l[0],u??l[1]]):we(l)}function wb(e){return Ng(e)?{scheme:e.name,...Fe(e,["name"])}:{scheme:e}}function zf(e,t,n,{center:i}={}){const r=Se(e),s=t.getName(r),o=t.getSignalName.bind(t);return e===ae&&Le(n)?i?[re.fromName(a=>`${o(a)}/2`,s),re.fromName(a=>`-${o(a)}/2`,s)]:[re.fromName(o,s),0]:i?[re.fromName(a=>`-${o(a)}/2`,s),re.fromName(a=>`${o(a)}/2`,s)]:[0,re.fromName(o,s)]}function Eb(e,t){const{size:n,config:i,mark:r,encoding:s}=t,{type:o}=ne(s[e]),c=t.getScaleComponent(e).get("type"),{domain:u,domainMid:l}=t.specifiedScales[e];switch(e){case V:case ae:{if(z(["point","band"],c)){const f=Mf(e,n,i.view);if(et(f))return{step:If(f,t,e)}}return zf(e,t,c)}case Rt:case Ln:return kb(e,t,c);case $t:{const f=Fb(r,i),d=Nb(r,n,t,i);return kn(c)?Cb(f,d,_b(c,i,u,e)):[f,d]}case Te:return[0,Math.PI*2];case rn:return[0,360];case Be:return[0,new re(()=>{const f=t.getSignalName(ke(t.parent)?"child_width":"width"),d=t.getSignalName(ke(t.parent)?"child_height":"height");return`min(${f},${d})/2`})];case zt:return{step:1e3/i.scale.framesPerSecond};case Mt:return[i.scale.minStrokeWidth,i.scale.maxStrokeWidth];case Dt:return[[1,0],[4,2],[2,1],[1,1],[1,2,4,2]];case be:return"symbol";case xe:case nt:case it:return c==="ordinal"?o==="nominal"?"category":"ordinal":l!==void 0?"diverging":r==="rect"||r==="geoshape"?"heatmap":"ramp";case vt:case It:case Lt:return[i.scale.minOpacity,i.scale.maxOpacity]}}function If(e,t,n){const{encoding:i}=t,r=t.getScaleComponent(n),s=Os(n),o=i[s];if(ml({step:e,offsetIsDiscrete:O(o)&&Qs(o.type)})==="offset"&&Ku(i,s)){const c=t.getScaleComponent(s);let l=`domain('${t.scaleName(s)}').length`;if(c.get("type")==="band"){const d=c.get("paddingInner")??c.get("padding")??0,p=c.get("paddingOuter")??c.get("padding")??0;l=`bandspace(${l}, ${d}, ${p})`}const f=r.get("paddingInner")??r.get("padding");return{signal:`${e.step} * ${l} / (1-${Vd(f)})`}}else return e.step}function Lf(e,t){if(ml({step:e,offsetIsDiscrete:oe(t)})==="offset")return{step:e.step}}function kb(e,t,n){const i=e===Rt?"x":"y",r=t.getScaleComponent(i);if(!r)return zf(i,t,n,{center:!0});const s=r.get("type"),o=t.scaleName(i),{markDef:a,config:c}=t;if(s==="band"){const u=Mf(i,t.size,t.config.view);if(et(u)){const l=Lf(u,n);if(l)return l}return[0,{signal:`bandwidth('${o}')`}]}else{const u=t.encoding[i];if(v(u)&&u.timeUnit){const l=gu(u.timeUnit,g=>`scale('${o}', ${g})`),f=t.config.scale.bandWithNestedOffsetPaddingInner,d=Ot({fieldDef:u,markDef:a,config:c})-.5,p=d!==0?` + ${d}`:"";if(f){const g=C(f)?`${f.signal}/2${p}`:`${f/2+d}`,h=C(f)?`(1 - ${f.signal}/2)${p}`:`${1-f/2+d}`;return[{signal:`${g} * (${l})`},{signal:`${h} * (${l})`}]}return[0,{signal:l}]}return ad(`Cannot use ${e} scale if ${i} scale is not discrete.`)}}function Mf(e,t,n){const i=e===V?"width":"height",r=t[i];return r!==void 0?r:Bi(n,i)}function _b(e,t,n,i){switch(e){case"quantile":return t.scale.quantileCount;case"quantize":return t.scale.quantizeCount;case"threshold":return n!==void 0&&_(n)?n.length+1:(w(Jp(i)),3)}}function Cb(e,t,n){const i=()=>{const r=Pe(t),s=Pe(e),o=`(${r} - ${s}) / (${n} - 1)`;return`sequence(${s}, ${r} + ${o}, ${o})`};return C(t)?new re(i):{signal:i()}}function Fb(e,t){switch(e){case"bar":case"tick":return t.scale.minBandSize;case"line":case"trail":case"rule":return t.scale.minStrokeWidth;case"text":return t.scale.minFontSize;case"point":case"square":case"circle":return t.scale.minSize}throw new Error(nr("size",e))}const Sc=.95;function Nb(e,t,n,i){const r={x:bc(n,"x"),y:bc(n,"y")};switch(e){case"bar":case"tick":{if(i.scale.maxBandSize!==void 0)return i.scale.maxBandSize;const s=$c(t,r,i.view);return G(s)?s-1:new re(()=>`${s.signal} - 1`)}case"line":case"trail":case"rule":return i.scale.maxStrokeWidth;case"text":return i.scale.maxFontSize;case"point":case"square":case"circle":{if(i.scale.maxSize)return i.scale.maxSize;const s=$c(t,r,i.view);return G(s)?Math.pow(Sc*s,2):new re(()=>`pow(${Sc} * ${s.signal}, 2)`)}}throw new Error(nr("size",e))}function $c(e,t,n){const i=et(e.width)?e.width.step:os(n,"width"),r=et(e.height)?e.height.step:os(n,"height");return t.x||t.y?new re(()=>`min(${[t.x?t.x.signal:i,t.y?t.y.signal:r].join(", ")})`):Math.min(i,r)}function Df(e,t){Y(e)?Tb(e,t):Uf(e,t)}function Tb(e,t){const n=e.component.scales,{config:i,encoding:r,markDef:s,specifiedScales:o}=e;for(const a of b(n)){const c=o[a],u=n[a],l=e.getScaleComponent(a),f=ne(r[a]),d=c[t],p=l.get("type"),g=l.get("padding"),h=l.get("paddingInner"),m=ns(p,t),y=wu(a,t);if(d!==void 0&&(m?y&&w(y):w(iu(p,t,a))),m&&y===void 0)if(d!==void 0){const S=f.timeUnit,k=f.type;switch(t){case"domainMax":case"domainMin":cn(c[t])||k==="temporal"||S?u.set(t,{signal:pr(c[t],{type:k,timeUnit:S})},!0):u.set(t,c[t],!0);break;default:u.copyKeyFromObject(t,c)}}else{const S=$(vc,t)?vc[t]({model:e,channel:a,fieldOrDatumDef:f,scaleType:p,scalePadding:g,scalePaddingInner:h,domain:c.domain,domainMin:c.domainMin,domainMax:c.domainMax,markDef:s,config:i,hasNestedOffsetScale:Qu(r,a),hasSecondaryRangeChannel:!!r[rt(a)]}):i.scale[t];S!==void 0&&u.set(t,S,!1)}}}const vc={bins:({model:e,fieldOrDatumDef:t})=>v(t)?Ob(e,t):void 0,interpolate:({channel:e,fieldOrDatumDef:t})=>Ab(e,t.type),nice:({scaleType:e,channel:t,domain:n,domainMin:i,domainMax:r,fieldOrDatumDef:s})=>Pb(e,t,n,i,r,s),padding:({channel:e,scaleType:t,fieldOrDatumDef:n,markDef:i,config:r})=>Rb(e,t,r.scale,n,i,r.bar),paddingInner:({scalePadding:e,channel:t,markDef:n,scaleType:i,config:r,hasNestedOffsetScale:s})=>zb(e,t,n.type,i,r.scale,s),paddingOuter:({scalePadding:e,channel:t,scaleType:n,scalePaddingInner:i,config:r,hasNestedOffsetScale:s})=>Ib(e,t,n,i,r.scale,s),reverse:({fieldOrDatumDef:e,scaleType:t,channel:n,config:i})=>{const r=v(e)?e.sort:void 0;return Lb(t,r,n,i.scale)},zero:({channel:e,fieldOrDatumDef:t,domain:n,markDef:i,scaleType:r,config:s,hasSecondaryRangeChannel:o})=>Mb(e,t,n,i,r,s.scale,o)};function jf(e){Y(e)?$b(e):Uf(e,"range")}function Uf(e,t){const n=e.component.scales;for(const i of e.children)t==="range"?jf(i):Df(i,t);for(const i of b(n)){let r;for(const s of e.children){const o=s.component.scales[i];if(o){const a=o.getWithExplicit(t);r=At(r,a,t,"scale",Nl((c,u)=>{switch(t){case"range":return c.step&&u.step?c.step-u.step:0}return 0}))}}n[i].setWithExplicit(t,r)}}function Ob(e,t){const n=t.bin;if(H(n)){const i=Lo(e,t.field,n);return new re(()=>e.getSignalName(i))}else if(ce(n)&&on(n)&&n.step!==void 0)return{step:n.step}}function Ab(e,t){if(z([xe,nt,it],e)&&t!=="nominal")return"hcl"}function Pb(e,t,n,i,r,s){var o;if(!((o=De(s))!=null&&o.bin||_(n)||r!=null||i!=null||z([le.TIME,le.UTC],e)))return ee(t)?!0:void 0}function Rb(e,t,n,i,r,s){if(ee(e)){if(Xe(t)){if(n.continuousPadding!==void 0)return n.continuousPadding;const{type:o,orient:a}=r;if(o==="bar"&&!(v(i)&&(i.bin||i.timeUnit))&&(a==="vertical"&&e==="x"||a==="horizontal"&&e==="y"))return s.continuousBandSize}if(t===le.POINT)return n.pointPadding}}function zb(e,t,n,i,r,s=!1){if(e===void 0){if(ee(t)){const{bandPaddingInner:o,barBandPaddingInner:a,rectBandPaddingInner:c,tickBandPaddingInner:u,bandWithNestedOffsetPaddingInner:l}=r;return s?l:te(o,n==="bar"?a:n==="tick"?u:c)}else if(oi(t)&&i===le.BAND)return r.offsetBandPaddingInner}}function Ib(e,t,n,i,r,s=!1){if(e===void 0){if(ee(t)){const{bandPaddingOuter:o,bandWithNestedOffsetPaddingOuter:a}=r;if(s)return a;if(n===le.BAND)return te(o,C(i)?{signal:`${i.signal}/2`}:i/2)}else if(oi(t)){if(n===le.POINT)return .5;if(n===le.BAND)return r.offsetBandPaddingOuter}}}function Lb(e,t,n,i){if(n==="x"&&i.xReverse!==void 0)return Le(e)&&t==="descending"?C(i.xReverse)?{signal:`!${i.xReverse.signal}`}:!i.xReverse:i.xReverse;if(Le(e)&&t==="descending")return!0}function Mb(e,t,n,i,r,s,o){if(!!n&&n!=="unaggregated"&&Le(r)){if(_(n)){const c=n[0],u=n[n.length-1];if(G(c)&&c<=0&&G(u)&&u>=0)return!0}return!1}if(e==="size"&&t.type==="quantitative"&&!kn(r))return!0;if(!(v(t)&&t.bin)&&z([...wt,...Cd],e)){const{orient:c,type:u}=i;return z(["bar","area","line","trail"],u)&&(c==="horizontal"&&e==="y"||c==="vertical"&&e==="x")?!1:z(["bar","area"],u)&&!o?!0:s==null?void 0:s.zero}return!1}function Db(e,t,n,i,r=!1){const s=jb(t,n,i,r),{type:o}=e;return st(t)?o!==void 0?Ig(t,o)?v(n)&&!zg(o,n.type)?(w(Lp(o,s)),s):o:(w(Ip(t,o,s)),s):s:null}function jb(e,t,n,i){var r;switch(t.type){case"nominal":case"ordinal":{if(yn(e)||Lr(e)==="discrete")return e==="shape"&&t.type==="ordinal"&&w(Mr(e,"ordinal")),"ordinal";if(Ir(e))return"band";if(ee(e)||oi(e)){if(z(["rect","bar","image","rule","tick"],n.type)||i)return"band"}else if(n.type==="arc"&&e in Rs)return"band";const s=n[Se(e)];return Zt(s)||Cn(t)&&((r=t.axis)!=null&&r.tickBand)?"band":"point"}case"temporal":return yn(e)?"time":Lr(e)==="discrete"?(w(Mr(e,"temporal")),"ordinal"):v(t)&&t.timeUnit&&se(t.timeUnit).utc?"utc":Ir(e)?"band":"time";case"quantitative":return yn(e)?v(t)&&H(t.bin)?"bin-ordinal":"linear":Lr(e)==="discrete"?(w(Mr(e,"quantitative")),"ordinal"):Ir(e)?"band":"linear";case"geojson":return}throw new Error(tu(t.type))}function Ub(e,{ignoreRange:t}={}){Bf(e),Af(e);for(const n of Rg)Df(e,n);t||jf(e)}function Bf(e){Y(e)?e.component.scales=Bb(e):e.component.scales=Hb(e)}function Bb(e){const{encoding:t,mark:n,markDef:i}=e,r={};for(const s of zs){const o=ne(t[s]);if(o&&n===_u&&s===be&&o.type===Mn)continue;let a=o&&o.scale;if(o&&a!==null&&a!==!1){a??(a={});const c=Qu(t,s),u=Db(a,s,o,i,c);r[s]=new Rf(e.scaleName(`${s}`,!0),{value:u,explicit:a.type===u})}}return r}const Wb=Nl((e,t)=>Na(e)-Na(t));function Hb(e){var r;const t=e.component.scales={},n={},i=e.component.resolve;for(const s of e.children){Bf(s);for(const o of b(s.component.scales))if((r=i.scale)[o]??(r[o]=bf(o,e)),i.scale[o]==="shared"){const a=n[o],c=s.component.scales[o].getWithExplicit("type");a?Eg(a.value,c.value)?n[o]=At(a,c,"type","scale",Wb):(i.scale[o]="independent",delete n[o]):n[o]=c}}for(const s of b(n)){const o=e.scaleName(s,!0),a=n[s];t[s]=new Rf(o,a);for(const c of e.children){const u=c.component.scales[s];u&&(c.renameScale(u.get("name"),o),u.merged=!0)}}return t}class Kr{constructor(){x(this,"nameMap");this.nameMap={}}rename(t,n){this.nameMap[t]=n}has(t){return this.nameMap[t]!==void 0}get(t){for(;this.nameMap[t]&&t!==this.nameMap[t];)t=this.nameMap[t];return t}}function Y(e){return(e==null?void 0:e.type)==="unit"}function ke(e){return(e==null?void 0:e.type)==="facet"}function Bo(e){return(e==null?void 0:e.type)==="concat"}function Wn(e){return(e==null?void 0:e.type)==="layer"}class Wo{constructor(t,n,i,r,s,o,a){x(this,"type");x(this,"parent");x(this,"config");x(this,"name");x(this,"size");x(this,"title");x(this,"description");x(this,"data");x(this,"transforms");x(this,"layout");x(this,"scaleNameMap");x(this,"projectionNameMap");x(this,"signalNameMap");x(this,"component");x(this,"view");this.type=n,this.parent=i,this.config=s,this.parent=i,this.config=s,this.view=ue(a),this.name=t.name??r,this.title=Ct(t.title)?{text:t.title}:t.title?ue(t.title):void 0,this.scaleNameMap=i?i.scaleNameMap:new Kr,this.projectionNameMap=i?i.projectionNameMap:new Kr,this.signalNameMap=i?i.signalNameMap:new Kr,this.data=t.data,this.description=t.description,this.transforms=Ym(t.transform??[]),this.layout=n==="layer"||n==="unit"?{}:Jh(t,n,s),this.component={data:{sources:i?i.component.data.sources:[],outputNodes:i?i.component.data.outputNodes:{},outputNodeRefCounts:i?i.component.data.outputNodeRefCounts:{},isFaceted:lr(t)||(i==null?void 0:i.component.data.isFaceted)&&t.data===void 0},layoutSize:new kt,layoutHeaders:{row:{},column:{},facet:{}},mark:null,resolve:{scale:{},axis:{},legend:{},...o?N(o):{}},selection:null,scales:null,projection:null,axes:{},legends:{}}}get width(){return this.getSizeSignalRef("width")}get height(){return this.getSizeSignalRef("height")}parse(){this.parseScale(),this.parseLayoutSize(),this.renameTopLevelLayoutSizeSignal(),this.parseSelections(),this.parseProjection(),this.parseData(),this.parseAxesAndHeaders(),this.parseLegends(),this.parseMarkGroup()}parseScale(){Ub(this)}parseProjection(){Nf(this)}renameTopLevelLayoutSizeSignal(){this.getName("width")!=="width"&&this.renameSignal(this.getName("width"),"width"),this.getName("height")!=="height"&&this.renameSignal(this.getName("height"),"height")}parseLegends(){Ef(this)}assembleEncodeFromView(t){const{style:n,...i}=t,r={};for(const s of b(i)){const o=i[s];o!==void 0&&(r[s]=q(o))}return r}assembleGroupEncodeEntry(t){let n={};return this.view&&(n=this.assembleEncodeFromView(this.view)),!t&&(this.description&&(n.description=q(this.description)),this.type==="unit"||this.type==="layer")?{width:this.getSizeSignalRef("width"),height:this.getSizeSignalRef("height"),...n}:W(n)?void 0:n}assembleLayout(){if(!this.layout)return;const{spacing:t,...n}=this.layout,{component:i,config:r}=this,s=fx(i.layoutHeaders,r);return{padding:t,...this.assembleDefaultLayout(),...n,...s?{titleBand:s}:{}}}assembleDefaultLayout(){return{}}assembleHeaderMarks(){const{layoutHeaders:t}=this.component;let n=[];for(const i of Ce)t[i].title&&n.push(sx(this,i));for(const i of Po)n=n.concat(ox(this,i));return n}assembleAxes(){return Gy(this.component.axes,this.config)}assembleLegends(){return _f(this)}assembleProjections(){return Rx(this)}assembleTitle(){const{encoding:t,...n}=this.title??{},i={...Gc(this.config.title).nonMarkTitleProperties,...n,...t?{encode:{update:t}}:{}};if(i.text)return z(["unit","layer"],this.type)?z(["middle",void 0],i.anchor)&&(i.frame??(i.frame="group")):i.anchor??(i.anchor="start"),W(i)?void 0:i}assembleGroup(t=[]){const n={};t=t.concat(this.assembleSignals()),t.length>0&&(n.signals=t);const i=this.assembleLayout();i&&(n.layout=i),n.marks=[].concat(this.assembleHeaderMarks(),this.assembleMarks());const r=!this.parent||ke(this.parent)?Pf(this):[];r.length>0&&(n.scales=r);const s=this.assembleAxes();s.length>0&&(n.axes=s);const o=this.assembleLegends();return o.length>0&&(n.legends=o),n}getName(t){return K((this.name?`${this.name}_`:"")+t)}getDataName(t){return this.getName(Q[t].toLowerCase())}requestDataName(t){const n=this.getDataName(t),i=this.component.data.outputNodeRefCounts;return i[n]=(i[n]||0)+1,n}getSizeSignalRef(t){if(ke(this.parent)){const n=yf(t),i=Ji(n),r=this.component.scales[i];if(r&&!r.merged){const s=r.get("type"),o=r.get("range");if(oe(s)&&an(o)){const a=r.get("name"),c=Er(this,i),u=Uo(c);if(u){const l=E({aggregate:"distinct",field:u},{expr:"datum"});return{signal:mf(a,r,l)}}else return w(Ms(i)),null}}}return{signal:this.signalNameMap.get(this.getName(t))}}lookupDataSource(t){const n=this.component.data.outputNodes[t];return n?n.getSource():t}getSignalName(t){return this.signalNameMap.get(t)}renameSignal(t,n){this.signalNameMap.rename(t,n)}renameScale(t,n){this.scaleNameMap.rename(t,n)}renameProjection(t,n){this.projectionNameMap.rename(t,n)}scaleName(t,n){if(n)return this.getName(t);if(Mc(t)&&st(t)&&this.component.scales[t]||this.scaleNameMap.has(this.getName(t)))return this.scaleNameMap.get(this.getName(t))}projectionName(t){if(t)return this.getName("projection");if(this.component.projection&&!this.component.projection.merged||this.projectionNameMap.has(this.getName("projection")))return this.projectionNameMap.get(this.getName("projection"))}getScaleComponent(t){if(!this.component.scales)throw new Error("getScaleComponent cannot be called before parseScale(). Make sure you have called parseScale or use parseUnitModelWithScale().");const n=this.component.scales[t];return n&&!n.merged?n:this.parent?this.parent.getScaleComponent(t):void 0}getScaleType(t){const n=this.getScaleComponent(t);return n?n.get("type"):void 0}getSelectionComponent(t,n){let i=this.component.selection[t];if(!i&&this.parent&&(i=this.parent.getSelectionComponent(t,n)),!i)throw new Error(Zd(n));return i}hasAxisOrientSignalRef(){var t,n;return((t=this.component.axes.x)==null?void 0:t.some(i=>i.hasOrientSignalRef()))||((n=this.component.axes.y)==null?void 0:n.some(i=>i.hasOrientSignalRef()))}}class Wf extends Wo{vgField(t,n={}){const i=this.fieldDef(t);if(i)return E(i,n)}reduceFieldDef(t,n){return Fh(this.getMapping(),(i,r,s)=>{const o=De(r);return o?t(i,o,s):i},n)}forEachFieldDef(t,n){go(this.getMapping(),(i,r)=>{const s=De(i);s&&t(s,r)},n)}}class kr extends j{constructor(n,i){super(n);x(this,"transform");this.transform=i,this.transform=N(i);const r=this.transform.as??[void 0,void 0];this.transform.as=[r[0]??"value",r[1]??"density"];const s=this.transform.resolve??"shared";this.transform.resolve=s}clone(){return new kr(null,N(this.transform))}dependentFields(){return new Set([this.transform.density,...this.transform.groupby??[]])}producedFields(){return new Set(this.transform.as)}hash(){return`DensityTransform ${I(this.transform)}`}assemble(){const{density:n,...i}=this.transform,r={type:"kde",field:n,...i};return r.resolve=this.transform.resolve,r}}class _r extends j{constructor(n,i){super(n);x(this,"transform");this.transform=i,this.transform=N(i)}clone(){return new _r(null,N(this.transform))}dependentFields(){return new Set([this.transform.extent])}producedFields(){return new Set([])}hash(){return`ExtentTransform ${I(this.transform)}`}assemble(){const{extent:n,param:i}=this.transform;return{type:"extent",field:n,signal:i}}}class Cr extends j{constructor(n,i){super(n);x(this,"transform");this.transform=i,this.transform=N(i);const{flatten:r,as:s=[]}=this.transform;this.transform.as=r.map((o,a)=>s[a]??o)}clone(){return new Cr(this.parent,N(this.transform))}dependentFields(){return new Set(this.transform.flatten)}producedFields(){return new Set(this.transform.as)}hash(){return`FlattenTransform ${I(this.transform)}`}assemble(){const{flatten:n,as:i}=this.transform;return{type:"flatten",fields:n,as:i}}}class Fr extends j{constructor(n,i){super(n);x(this,"transform");this.transform=i,this.transform=N(i);const r=this.transform.as??[void 0,void 0];this.transform.as=[r[0]??"key",r[1]??"value"]}clone(){return new Fr(null,N(this.transform))}dependentFields(){return new Set(this.transform.fold)}producedFields(){return new Set(this.transform.as)}hash(){return`FoldTransform ${I(this.transform)}`}assemble(){const{fold:n,as:i}=this.transform;return{type:"fold",fields:n,as:i}}}class Sn extends j{constructor(n,i,r,s){super(n);x(this,"fields");x(this,"geojson");x(this,"signal");this.fields=i,this.geojson=r,this.signal=s}clone(){return new Sn(null,N(this.fields),this.geojson,this.signal)}static parseAll(n,i){if(i.component.projection&&!i.component.projection.isFit)return n;let r=0;for(const s of[[He,We],[Ne,qe]]){const o=s.map(a=>{const c=ne(i.encoding[a]);return v(c)?c.field:ot(c)?{expr:`${c.datum}`}:Me(c)?{expr:`${c.value}`}:void 0});(o[0]||o[1])&&(n=new Sn(n,o,null,i.getName(`geojson_${r++}`)))}if(i.channelHasField(be)){const s=i.typedFieldDef(be);s.type===Mn&&(n=new Sn(n,null,s.field,i.getName(`geojson_${r++}`)))}return n}dependentFields(){const n=(this.fields??[]).filter(T);return new Set([...this.geojson?[this.geojson]:[],...n])}producedFields(){return new Set}hash(){return`GeoJSON ${this.geojson} ${this.signal} ${I(this.fields)}`}assemble(){return[...this.geojson?[{type:"filter",expr:`isValid(datum["${this.geojson}"])`}]:[],{type:"geojson",...this.fields?{fields:this.fields}:{},...this.geojson?{geojson:this.geojson}:{},signal:this.signal}]}}class ei extends j{constructor(n,i,r,s){super(n);x(this,"projection");x(this,"fields");x(this,"as");this.projection=i,this.fields=r,this.as=s}clone(){return new ei(null,this.projection,N(this.fields),N(this.as))}static parseAll(n,i){if(!i.projectionName())return n;for(const r of[[He,We],[Ne,qe]]){const s=r.map(a=>{const c=ne(i.encoding[a]);return v(c)?c.field:ot(c)?{expr:`${c.datum}`}:Me(c)?{expr:`${c.value}`}:void 0}),o=r[0]===Ne?"2":"";(s[0]||s[1])&&(n=new ei(n,i.projectionName(),s,[i.getName(`x${o}`),i.getName(`y${o}`)]))}return n}dependentFields(){return new Set(this.fields.filter(T))}producedFields(){return new Set(this.as)}hash(){return`Geopoint ${this.projection} ${I(this.fields)} ${I(this.as)}`}assemble(){return{type:"geopoint",projection:this.projection,fields:this.fields,as:this.as}}}class Gt extends j{constructor(n,i){super(n);x(this,"transform");this.transform=i}clone(){return new Gt(null,N(this.transform))}dependentFields(){return new Set([this.transform.impute,this.transform.key,...this.transform.groupby??[]])}producedFields(){return new Set([this.transform.impute])}processSequence(n){const{start:i=0,stop:r,step:s}=n;return{signal:`sequence(${[i,r,...s?[s]:[]].join(",")})`}}static makeFromTransform(n,i){return new Gt(n,i)}static makeFromEncoding(n,i){const r=i.encoding,s=r.x,o=r.y;if(v(s)&&v(o)){const a=s.impute?s:o.impute?o:void 0;if(a===void 0)return;const c=s.impute?o:o.impute?s:void 0,{method:u,value:l,frame:f,keyvals:d}=a.impute,p=el(i.mark,r);return new Gt(n,{impute:a.field,key:c.field,...u?{method:u}:{},...l!==void 0?{value:l}:{},...f?{frame:f}:{},...d!==void 0?{keyvals:d}:{},...p.length?{groupby:p}:{}})}return null}hash(){return`Impute ${I(this.transform)}`}assemble(){const{impute:n,key:i,keyvals:r,method:s,groupby:o,value:a,frame:c=[null,null]}=this.transform,u={type:"impute",field:n,key:i,...r?{keyvals:Tm(r)?this.processSequence(r):r}:{},method:"value",...o?{groupby:o}:{},value:!s||s==="value"?a:null};if(s&&s!=="value"){const l={type:"window",as:[`imputed_${n}_value`],ops:[s],fields:[n],frame:c,ignorePeers:!1,...o?{groupby:o}:{}},f={type:"formula",expr:`datum.${n} === null ? datum.imputed_${n}_value : datum.${n}`,as:n};return[u,l,f]}else return[u]}}class Nr extends j{constructor(n,i){super(n);x(this,"transform");this.transform=i,this.transform=N(i);const r=this.transform.as??[void 0,void 0];this.transform.as=[r[0]??i.on,r[1]??i.loess]}clone(){return new Nr(null,N(this.transform))}dependentFields(){return new Set([this.transform.loess,this.transform.on,...this.transform.groupby??[]])}producedFields(){return new Set(this.transform.as)}hash(){return`LoessTransform ${I(this.transform)}`}assemble(){const{loess:n,on:i,...r}=this.transform;return{type:"loess",x:i,y:n,...r}}}class ti extends j{constructor(n,i,r){super(n);x(this,"transform");x(this,"secondary");this.transform=i,this.secondary=r}clone(){return new ti(null,N(this.transform),this.secondary)}static make(n,i,r,s){const o=i.component.data.sources,{from:a}=r;let c=null;if(Om(a)){let u=Gf(a.data,o);u||(u=new nn(a.data),o.push(u));const l=i.getName(`lookup_${s}`);c=new ye(u,l,Q.Lookup,i.component.data.outputNodeRefCounts),i.component.data.outputNodes[l]=c}else if(Am(a)){const u=a.param;r={as:u,...r};let l;try{l=i.getSelectionComponent(K(u),u)}catch{throw new Error(np(u))}if(c=l.materialized,!c)throw new Error(ip(u))}return new ti(n,r,c.getSource())}dependentFields(){return new Set([this.transform.lookup])}producedFields(){return new Set(this.transform.as?J(this.transform.as):this.transform.from.fields)}hash(){return`Lookup ${I({transform:this.transform,secondary:this.secondary})}`}assemble(){let n;if(this.transform.from.fields)n={values:this.transform.from.fields,...this.transform.as?{as:J(this.transform.as)}:{}};else{let i=this.transform.as;T(i)||(w(gp),i="_lookup"),n={as:[i]}}return{type:"lookup",from:this.secondary,key:this.transform.from.key,fields:[this.transform.lookup],...n,...this.transform.default?{default:this.transform.default}:{}}}}class Tr extends j{constructor(n,i){super(n);x(this,"transform");this.transform=i,this.transform=N(i);const r=this.transform.as??[void 0,void 0];this.transform.as=[r[0]??"prob",r[1]??"value"]}clone(){return new Tr(null,N(this.transform))}dependentFields(){return new Set([this.transform.quantile,...this.transform.groupby??[]])}producedFields(){return new Set(this.transform.as)}hash(){return`QuantileTransform ${I(this.transform)}`}assemble(){const{quantile:n,...i}=this.transform;return{type:"quantile",field:n,...i}}}class Or extends j{constructor(n,i){super(n);x(this,"transform");this.transform=i,this.transform=N(i);const r=this.transform.as??[void 0,void 0];this.transform.as=[r[0]??i.on,r[1]??i.regression]}clone(){return new Or(null,N(this.transform))}dependentFields(){return new Set([this.transform.regression,this.transform.on,...this.transform.groupby??[]])}producedFields(){return new Set(this.transform.as)}hash(){return`RegressionTransform ${I(this.transform)}`}assemble(){const{regression:n,on:i,...r}=this.transform;return{type:"regression",x:i,y:n,...r}}}class Ar extends j{constructor(n,i){super(n);x(this,"transform");this.transform=i}clone(){return new Ar(null,N(this.transform))}addDimensions(n){this.transform.groupby=ut((this.transform.groupby??[]).concat(n),i=>i)}producedFields(){}dependentFields(){return new Set([this.transform.pivot,this.transform.value,...this.transform.groupby??[]])}hash(){return`PivotTransform ${I(this.transform)}`}assemble(){const{pivot:n,value:i,groupby:r,limit:s,op:o}=this.transform;return{type:"pivot",field:n,value:i,...s!==void 0?{limit:s}:{},...o!==void 0?{op:o}:{},...r!==void 0?{groupby:r}:{}}}}class Pr extends j{constructor(n,i){super(n);x(this,"transform");this.transform=i}clone(){return new Pr(null,N(this.transform))}dependentFields(){return new Set}producedFields(){return new Set}hash(){return`SampleTransform ${I(this.transform)}`}assemble(){return{type:"sample",size:this.transform.sample}}}function Hf(e){let t=0;function n(i,r){if(i instanceof nn&&!i.isGenerator&&!Nn(i.data)&&(e.push(r),r={name:null,source:r.name,transform:[]}),i instanceof de&&(i.parent instanceof nn&&!r.source?(r.format={...r.format,parse:i.assembleFormatParse()},r.transform.push(...i.assembleTransforms(!0))):r.transform.push(...i.assembleTransforms())),i instanceof Un){r.name||(r.name=`data_${t++}`),!r.source||r.transform.length>0?(e.push(r),i.data=r.name):i.data=r.source,e.push(...i.assemble());return}switch((i instanceof mi||i instanceof yi||i instanceof Rn||i instanceof jn||i instanceof On||i instanceof ei||i instanceof ze||i instanceof ti||i instanceof Bn||i instanceof dn||i instanceof Fr||i instanceof Cr||i instanceof kr||i instanceof Nr||i instanceof Tr||i instanceof Or||i instanceof Pt||i instanceof Pr||i instanceof Ar||i instanceof _r)&&r.transform.push(i.assemble()),(i instanceof Qe||i instanceof Ye||i instanceof Gt||i instanceof ht||i instanceof Sn)&&r.transform.push(...i.assemble()),i instanceof ye&&(r.source&&r.transform.length===0?i.setSource(r.source):i.parent instanceof ye?i.setSource(r.name):(r.name||(r.name=`data_${t++}`),i.setSource(r.name),i.numChildren()===1&&(e.push(r),r={name:null,source:r.name,transform:[]}))),i.numChildren()){case 0:i instanceof ye&&(!r.source||r.transform.length>0)&&e.push(r);break;case 1:n(i.children[0],r);break;default:{r.name||(r.name=`data_${t++}`);let s=r.name;!r.source||r.transform.length>0?e.push(r):s=r.source;for(const o of i.children)n(o,{name:null,source:s,transform:[]});break}}}return n}function qb(e){const t=[],n=Hf(t);for(const i of e.children)n(i,{source:e.name,name:null,transform:[]});return t}function Gb(e,t){const n=[],i=Hf(n);let r=0;for(const o of e.sources){o.hasName()||(o.dataName=`source_${r++}`);const a=o.assemble();i(o,a)}for(const o of n)o.transform.length===0&&delete o.transform;let s=0;for(const[o,a]of n.entries())(a.transform??[]).length===0&&!a.source&&n.splice(s++,0,n.splice(o,1)[0]);for(const o of n)for(const a of o.transform??[])a.type==="lookup"&&(a.from=e.outputNodes[a.from].getSource());for(const o of n)o.name in t&&(o.values=t[o.name]);return n}function Vb(e){return e==="top"||e==="left"||C(e)?"header":"footer"}function Xb(e){for(const t of Ce)Yb(e,t);wc(e,"x"),wc(e,"y")}function Yb(e,t){var o;const{facet:n,config:i,child:r,component:s}=e;if(e.channelHasField(t)){const a=n[t],c=Pn("title",null,i,t);let u=xn(a,i,{allowDisabling:!0,includeDefault:c===void 0||!!c});r.component.layoutHeaders[t].title&&(u=_(u)?u.join(", "):u,u+=` / ${r.component.layoutHeaders[t].title}`,r.component.layoutHeaders[t].title=null);const l=Pn("labelOrient",a.header,i,t),f=a.header!==null?te((o=a.header)==null?void 0:o.labels,i.header.labels,!0):!1,d=z(["bottom","right"],l)?"footer":"header";s.layoutHeaders[t]={title:a.header!==null?u:null,facetFieldDef:a,[d]:t==="facet"?[]:[qf(e,t,f)]}}}function qf(e,t,n){const i=t==="row"?"height":"width";return{labels:n,sizeSignal:e.child.component.layoutSize.get(i)?e.child.getSizeSignalRef(i):void 0,axes:[]}}function wc(e,t){const{child:n}=e;if(n.component.axes[t]){const{layoutHeaders:i,resolve:r}=e.component;if(r.axis[t]=Io(r,t),r.axis[t]==="shared"){const s=t==="x"?"column":"row",o=i[s];for(const a of n.component.axes[t]){const c=Vb(a.get("orient"));o[c]??(o[c]=[qf(e,s,!1)]);const u=Gn(a,"main",e.config,{header:!0});u&&o[c][0].axes.push(u),a.mainExtracted=!0}}}}function Kb(e){Ho(e),Gi(e,"width"),Gi(e,"height")}function Qb(e){Ho(e);const t=e.layout.columns===1?"width":"childWidth",n=e.layout.columns===void 0?"height":"childHeight";Gi(e,t),Gi(e,n)}function Ho(e){for(const t of e.children)t.parseLayoutSize()}function Gi(e,t){const n=yf(t),i=Ji(n),r=e.component.resolve,s=e.component.layoutSize;let o;for(const a of e.children){const c=a.component.layoutSize.getWithExplicit(n),u=r.scale[i]??bf(i,e);if(u==="independent"&&c.value==="step"){o=void 0;break}if(o){if(u==="independent"&&o.value!==c.value){o=void 0;break}o=At(o,c,n,"")}else o=c}if(o){for(const a of e.children)e.renameSignal(a.getName(n),e.getName(t)),a.component.layoutSize.set(n,"merged",!1);s.setWithExplicit(t,o)}else s.setWithExplicit(t,{explicit:!1,value:void 0})}function Zb(e){const{size:t,component:n}=e;for(const i of wt){const r=Se(i);if(t[r]!=null&&t[r]!=null){const s=t[r];n.layoutSize.set(r,et(s)?"step":s,!0)}else{const s=Jb(e,r);n.layoutSize.set(r,s,!1)}}}function Jb(e,t){const n=t==="width"?"x":"y",i=e.config,r=e.getScaleComponent(n);if(r){const s=r.get("type"),o=r.get("range");if(oe(s)){const a=Bi(i.view,t);return an(o)||et(a)?"step":a}else return ss(i.view,t)}else{if(e.hasProjection||e.mark==="arc")return ss(i.view,t);{const s=Bi(i.view,t);return et(s)?s.step:s}}}function ws(e,t,n){return E(t,{suffix:`by_${E(e)}`,...n})}class Xn extends Wf{constructor(n,i,r,s){super(n,"facet",i,r,s,n.resolve);x(this,"facet");x(this,"child");x(this,"children");this.child=Yo(n.spec,this,this.getName("child"),void 0,s),this.children=[this.child],this.facet=this.initFacet(n.facet)}initFacet(n){if(!li(n))return{facet:this.initFacetFieldDef(n,"facet")};const i=b(n),r={};for(const s of i){if(![ft,dt].includes(s)){w(nr(s,"facet"));break}const o=n[s];if(o.field===void 0){w(es(o,s));break}r[s]=this.initFacetFieldDef(o,s)}return r}initFacetFieldDef(n,i){const r=po(n,i);return r.header?r.header=ue(r.header):r.header===null&&(r.header=null),r}channelHasField(n){return $(this.facet,n)}fieldDef(n){return this.facet[n]}parseData(){this.component.data=Rr(this),this.child.parseData()}parseLayoutSize(){Ho(this)}parseSelections(){this.child.parseSelections(),this.component.selection=this.child.component.selection,ie(this.component.selection).some(n=>Ke(n))&&js(Ds)}parseMarkGroup(){this.child.parseMarkGroup()}parseAxesAndHeaders(){this.child.parseAxesAndHeaders(),Xb(this)}assembleSelectionTopLevelSignals(n){return this.child.assembleSelectionTopLevelSignals(n)}assembleSignals(){return this.child.assembleSignals(),[]}assembleSelectionData(n){return this.child.assembleSelectionData(n)}getHeaderLayoutMixins(){const n={};for(const i of Ce)for(const r of Ro){const s=this.component.layoutHeaders[i],o=s[r],{facetFieldDef:a}=s;if(a){const c=Pn("titleOrient",a.header,this.config,i);if(["right","bottom"].includes(c)){const u=vr(i,c);n.titleAnchor??(n.titleAnchor={}),n.titleAnchor[u]="end"}}if(o!=null&&o[0]){const c=i==="row"?"height":"width",u=r==="header"?"headerBand":"footerBand";i!=="facet"&&!this.child.component.layoutSize.get(c)&&(n[u]??(n[u]={}),n[u][i]=.5),s.title&&(n.offset??(n.offset={}),n.offset[i==="row"?"rowTitle":"columnTitle"]=10)}}return n}assembleDefaultLayout(){const{column:n,row:i}=this.facet,r=n?this.columnDistinctSignal():i?1:void 0;let s="all";return(!i&&this.component.resolve.scale.x==="independent"||!n&&this.component.resolve.scale.y==="independent")&&(s="none"),{...this.getHeaderLayoutMixins(),...r?{columns:r}:{},bounds:"full",align:s}}assembleLayoutSignals(){return this.child.assembleLayoutSignals()}columnDistinctSignal(){if(!(this.parent&&this.parent instanceof Xn))return{signal:`length(data('${this.getName("column_domain")}'))`}}assembleGroupStyle(){}assembleGroup(n){return this.parent&&this.parent instanceof Xn?{...this.channelHasField("column")?{encode:{update:{columns:{field:E(this.facet.column,{prefix:"distinct"})}}}}:{},...super.assembleGroup(n)}:super.assembleGroup(n)}getCardinalityAggregateForChild(){const n=[],i=[],r=[];if(this.child instanceof Xn){if(this.child.channelHasField("column")){const s=E(this.child.facet.column);n.push(s),i.push("distinct"),r.push(`distinct_${s}`)}}else for(const s of wt){const o=this.child.component.scales[s];if(o&&!o.merged){const a=o.get("type"),c=o.get("range");if(oe(a)&&an(c)){const u=Er(this.child,s),l=Uo(u);l?(n.push(l),i.push("distinct"),r.push(`distinct_${l}`)):w(Ms(s))}}}return{fields:n,ops:i,as:r}}assembleFacet(){const{name:n,data:i}=this.component.data.facetRoot,{row:r,column:s}=this.facet,{fields:o,ops:a,as:c}=this.getCardinalityAggregateForChild(),u=[];for(const f of Ce){const d=this.facet[f];if(d){u.push(E(d));const{bin:p,sort:g}=d;if(H(p)&&u.push(E(d,{binSuffix:"end"})),pt(g)){const{field:h,op:m=ur}=g,y=ws(d,g);r&&s?(o.push(y),a.push("max"),c.push(y)):(o.push(h),a.push(m),c.push(y))}else if(_(g)){const h=An(d,f);o.push(h),a.push("max"),c.push(h)}}}const l=!!r&&!!s;return{name:n,data:i,groupby:u,...l||o.length>0?{aggregate:{...l?{cross:l}:{},...o.length?{fields:o,ops:a,as:c}:{}}}:{}}}facetSortFields(n){const{facet:i}=this,r=i[n];return r?pt(r.sort)?[ws(r,r.sort,{expr:"datum"})]:_(r.sort)?[An(r,n,{expr:"datum"})]:[E(r,{expr:"datum"})]:[]}facetSortOrder(n){const{facet:i}=this,r=i[n];if(r){const{sort:s}=r;return[(pt(s)?s.order:!_(s)&&s)||"ascending"]}return[]}assembleLabelTitle(){var s;const{facet:n,config:i}=this;if(n.facet)return ms(n.facet,"facet",i);const r={row:["top","bottom"],column:["left","right"]};for(const o of Po)if(n[o]){const a=Pn("labelOrient",(s=n[o])==null?void 0:s.header,i,o);if(r[o].includes(a))return ms(n[o],o,i)}}assembleMarks(){const{child:n}=this,i=this.component.data.facetRoot,r=qb(i),s=n.assembleGroupEncodeEntry(!1),o=this.assembleLabelTitle()||n.assembleTitle(),a=n.assembleGroupStyle();return[{name:this.getName("cell"),type:"group",...o?{title:o}:{},...a?{style:a}:{},from:{facet:this.assembleFacet()},sort:{field:Ce.map(u=>this.facetSortFields(u)).flat(),order:Ce.map(u=>this.facetSortOrder(u)).flat()},...r.length>0?{data:r}:{},...s?{encode:{update:s}}:{},...n.assembleGroup(hy(this,[]))}]}getMapping(){return this.facet}}function eS(e,t){const{row:n,column:i}=t;if(n&&i){let r=null;for(const s of[n,i])if(pt(s.sort)){const{field:o,op:a=ur}=s.sort;e=r=new dn(e,{joinaggregate:[{op:a,field:o,as:ws(s,s.sort,{forAs:!0})}],groupby:[E(s)]})}return r}return null}function Gf(e,t){var n,i,r,s;for(const o of t){const a=o.data;if(e.name&&o.hasName()&&e.name!==o.dataName)continue;const c=(n=e.format)==null?void 0:n.mesh,u=(i=a.format)==null?void 0:i.feature;if(c&&u)continue;const l=(r=e.format)==null?void 0:r.feature;if((l||u)&&l!==u)continue;const f=(s=a.format)==null?void 0:s.mesh;if(!((c||f)&&c!==f)){if(Jn(e)&&Jn(a)){if(_e(e.values,a.values))return o}else if(Nn(e)&&Nn(a)){if(e.url===a.url)return o}else if(Tl(e)&&e.name===o.dataName)return o}}return null}function tS(e,t){if(e.data||!e.parent){if(e.data===null){const i=new nn({values:[]});return t.push(i),i}const n=Gf(e.data,t);if(n)return Nt(e.data)||(n.data.format=cd({},e.data.format,n.data.format)),!n.hasName()&&e.data.name&&(n.dataName=e.data.name),n;{const i=new nn(e.data);return t.push(i),i}}else return e.parent.component.data.facetRoot?e.parent.component.data.facetRoot:e.parent.component.data.main}function nS(e,t,n){let i=0;for(const r of t.transforms){let s,o;if(Bm(r))o=e=new On(e,r),s="derived";else if(ko(r)){const a=Vx(r);o=e=de.makeWithAncestors(e,{},a,n)??e,e=new jn(e,t,r.filter)}else if(_l(r))o=e=Qe.makeFromTransform(e,r,t),s="number";else if(Hm(r))s="date",n.getWithExplicit(r.field).value===void 0&&(e=new de(e,{[r.field]:s}),n.set(r.field,s,!1)),o=e=Ye.makeFromTransform(e,r);else if(qm(r))o=e=ze.makeFromTransform(e,r),s="number",Ao(t)&&(e=new Pt(e));else if(kl(r))o=e=ti.make(e,t,r,i++),s="derived";else if(Dm(r))o=e=new Bn(e,r),s="number";else if(jm(r))o=e=new dn(e,r),s="number";else if(Gm(r))o=e=ht.makeFromTransform(e,r),s="derived";else if(Vm(r))o=e=new Fr(e,r),s="derived";else if(Xm(r))o=e=new _r(e,r),s="derived";else if(Um(r))o=e=new Cr(e,r),s="derived";else if(Pm(r))o=e=new Ar(e,r),s="derived";else if(Mm(r))e=new Pr(e,r);else if(Wm(r))o=e=Gt.makeFromTransform(e,r),s="derived";else if(Rm(r))o=e=new kr(e,r),s="derived";else if(zm(r))o=e=new Tr(e,r),s="derived";else if(Im(r))o=e=new Or(e,r),s="derived";else if(Lm(r))o=e=new Nr(e,r),s="derived";else{w(pp(r));continue}if(o&&s!==void 0)for(const a of o.producedFields()??[])n.set(a,s,!1)}return e}function Rr(e){var m;let t=tS(e,e.component.data.sources);const{outputNodes:n,outputNodeRefCounts:i}=e.component.data,r=e.data,o=!(r&&(Nt(r)||Nn(r)||Jn(r)))&&e.parent?e.parent.component.data.ancestorParse.clone():new ay;Nt(r)?(Ol(r)?t=new yi(t,r.sequence):_o(r)&&(t=new mi(t,r.graticule)),o.parseNothing=!0):((m=r==null?void 0:r.format)==null?void 0:m.parse)===null&&(o.parseNothing=!0),t=de.makeExplicit(t,e,o)??t,t=new Pt(t);const a=e.parent&&Wn(e.parent);(Y(e)||ke(e))&&a&&(t=Qe.makeFromEncoding(t,e)??t),e.transforms.length>0&&(t=nS(t,e,o));const c=Yx(e),u=Xx(e);t=de.makeWithAncestors(t,{},{...c,...u},o)??t,Y(e)&&(t=Sn.parseAll(t,e),t=ei.parseAll(t,e)),(Y(e)||ke(e))&&(a||(t=Qe.makeFromEncoding(t,e)??t),t=Ye.makeFromEncoding(t,e)??t,t=On.parseAllForSortIndex(t,e));const l=t=Ci(Q.Raw,e,t);if(Y(e)){const y=ze.makeFromEncoding(t,e);y&&(t=y,Ao(e)&&(t=new Pt(t))),t=Gt.makeFromEncoding(t,e)??t,t=ht.makeFromEncoding(t,e)??t}let f,d;if(Y(e)){const{markDef:y,mark:S,config:k}=e,A=M("invalid",y,k),{marks:F,scales:P}=d=Pl({invalid:A,isPath:Ut(S)});F!==P&&P==="include-invalid-values"&&(f=t=Ci(Q.PreFilterInvalid,e,t)),F==="exclude-invalid-values"&&(t=Rn.make(t,e,d)??t)}const p=t=Ci(Q.Main,e,t);let g;if(Y(e)&&d){const{marks:y,scales:S}=d;y==="include-invalid-values"&&S==="exclude-invalid-values"&&(t=Rn.make(t,e,d)??t,g=t=Ci(Q.PostFilterInvalid,e,t))}Y(e)&&Hy(e,p);let h=null;if(ke(e)){const y=e.getName("facet");t=eS(t,e.facet)??t,h=new Un(t,e,y,p.getSource()),n[y]=h}return{...e.component.data,outputNodes:n,outputNodeRefCounts:i,raw:l,main:p,facetRoot:h,ancestorParse:o,preFilterInvalid:f,postFilterInvalid:g}}function Ci(e,t,n){const{outputNodes:i,outputNodeRefCounts:r}=t.component.data,s=t.getDataName(e),o=new ye(n,s,e,r);return i[s]=o,o}class iS extends Wo{constructor(n,i,r,s){var o,a,c,u;super(n,"concat",i,r,s,n.resolve);x(this,"children");(((a=(o=n.resolve)==null?void 0:o.axis)==null?void 0:a.x)==="shared"||((u=(c=n.resolve)==null?void 0:c.axis)==null?void 0:u.y)==="shared")&&w(lp),this.children=this.getChildren(n).map((l,f)=>Yo(l,this,this.getName(`concat_${f}`),void 0,s))}parseData(){this.component.data=Rr(this);for(const n of this.children)n.parseData()}parseSelections(){this.component.selection={};for(const n of this.children){n.parseSelections();for(const i of b(n.component.selection))this.component.selection[i]=n.component.selection[i]}ie(this.component.selection).some(n=>Ke(n))&&js(Ds)}parseMarkGroup(){for(const n of this.children)n.parseMarkGroup()}parseAxesAndHeaders(){for(const n of this.children)n.parseAxesAndHeaders()}getChildren(n){return mr(n)?n.vconcat:wo(n)?n.hconcat:n.concat}parseLayoutSize(){Qb(this)}parseAxisGroup(){return null}assembleSelectionTopLevelSignals(n){return this.children.reduce((i,r)=>r.assembleSelectionTopLevelSignals(i),n)}assembleSignals(){return this.children.forEach(n=>n.assembleSignals()),[]}assembleLayoutSignals(){const n=zo(this);for(const i of this.children)n.push(...i.assembleLayoutSignals());return n}assembleSelectionData(n){return this.children.reduce((i,r)=>r.assembleSelectionData(i),n)}assembleMarks(){return this.children.map(n=>{const i=n.assembleTitle(),r=n.assembleGroupStyle(),s=n.assembleGroupEncodeEntry(!1);return{type:"group",name:n.getName("group"),...i?{title:i}:{},...r?{style:r}:{},...s?{encode:{update:s}}:{},...n.assembleGroup()}})}assembleGroupStyle(){}assembleDefaultLayout(){const n=this.layout.columns;return{...n!=null?{columns:n}:{},bounds:"full",align:"each"}}}function rS(e){return e===!1||e===null}const sS={disable:1,gridScale:1,scale:1,...Xu,labelExpr:1,encode:1},Vf=b(sS);class qo extends kt{constructor(n={},i={},r=!1){super();x(this,"explicit");x(this,"implicit");x(this,"mainExtracted");this.explicit=n,this.implicit=i,this.mainExtracted=r}clone(){return new qo(N(this.explicit),N(this.implicit),this.mainExtracted)}hasAxisPart(n){return n==="axis"?!0:n==="grid"||n==="title"?!!this.get(n):!rS(this.get(n))}hasOrientSignalRef(){return C(this.explicit.orient)}}function oS(e,t,n){const{encoding:i,config:r}=e,s=ne(i[t])??ne(i[rt(t)]),o=e.axis(t)||{},{format:a,formatType:c}=o;if(Jt(c))return{text:Re({fieldOrDatumDef:s,field:"datum.value",format:a,formatType:c,config:r}),...n};if(a===void 0&&c===void 0&&r.customFormatTypes){if(_n(s)==="quantitative"){if(Cn(s)&&s.stack==="normalize"&&r.normalizedNumberFormatType)return{text:Re({fieldOrDatumDef:s,field:"datum.value",format:r.normalizedNumberFormat,formatType:r.normalizedNumberFormatType,config:r}),...n};if(r.numberFormatType)return{text:Re({fieldOrDatumDef:s,field:"datum.value",format:r.numberFormat,formatType:r.numberFormatType,config:r}),...n}}if(_n(s)==="temporal"&&r.timeFormatType&&v(s)&&!s.timeUnit)return{text:Re({fieldOrDatumDef:s,field:"datum.value",format:r.timeFormat,formatType:r.timeFormatType,config:r}),...n}}return n}function aS(e){return wt.reduce((t,n)=>(e.component.scales[n]&&(t[n]=[gS(n,e)]),t),{})}const cS={bottom:"top",top:"bottom",left:"right",right:"left"};function uS(e){const{axes:t,resolve:n}=e.component,i={top:0,bottom:0,right:0,left:0};for(const r of e.children){r.parseAxesAndHeaders();for(const s of b(r.component.axes))n.axis[s]=Io(e.component.resolve,s),n.axis[s]==="shared"&&(t[s]=lS(t[s],r.component.axes[s]),t[s]||(n.axis[s]="independent",delete t[s]))}for(const r of wt){for(const s of e.children)if(s.component.axes[r]){if(n.axis[r]==="independent"){t[r]=(t[r]??[]).concat(s.component.axes[r]);for(const o of s.component.axes[r]){const{value:a,explicit:c}=o.getWithExplicit("orient");if(!C(a)){if(i[a]>0&&!c){const u=cS[a];i[a]>i[u]&&o.set("orient",u,!1)}i[a]++}}}delete s.component.axes[r]}if(n.axis[r]==="independent"&&t[r]&&t[r].length>1)for(const[s,o]of(t[r]||[]).entries())s>0&&o.get("grid")&&!o.explicit.grid&&(o.implicit.grid=!1)}}function lS(e,t){if(e){if(e.length!==t.length)return;const n=e.length;for(let i=0;i<n;i++){const r=e[i],s=t[i];if(!!r!=!!s)return;if(r&&s){const o=r.getWithExplicit("orient"),a=s.getWithExplicit("orient");if(o.explicit&&a.explicit&&o.value!==a.value)return;e[i]=fS(r,s)}}}else return t.map(n=>n.clone());return e}function fS(e,t){for(const n of Vf){const i=At(e.getWithExplicit(n),t.getWithExplicit(n),n,"axis",(r,s)=>{switch(n){case"title":return Jc(r,s);case"gridScale":return{explicit:r.explicit,value:te(r.value,s.value)}}return xr(r,s,n,"axis")});e.setWithExplicit(n,i)}return e}function dS(e,t,n,i,r){if(t==="disable")return n!==void 0;switch(n=n||{},t){case"titleAngle":case"labelAngle":return e===(C(n.labelAngle)?n.labelAngle:Pi(n.labelAngle));case"values":return!!n.values;case"encode":return!!n.encoding||!!n.labelAngle;case"title":if(e===df(i,r))return!0}return e===n[t]}const pS=new Set(["grid","translate","format","formatType","orient","labelExpr","tickCount","position","tickMinStep"]);function gS(e,t){var y,S;let n=t.axis(e);const i=new qo,r=ne(t.encoding[e]),{mark:s,config:o}=t,a=(n==null?void 0:n.orient)||((y=o[e==="x"?"axisX":"axisY"])==null?void 0:y.orient)||((S=o.axis)==null?void 0:S.orient)||ex(e),c=t.getScaleComponent(e).get("type"),u=Vy(e,c,a,t.config),l=n!==void 0?!n:gs("disable",o.style,n==null?void 0:n.style,u).configValue;if(i.set("disable",l,n!==void 0),l)return i;n=n||{};const f=Qy(r,n,e,o.style,u),d=Ru(n.formatType,r,c),p=Pu(r,r.type,n.format,n.formatType,o,!0),g={fieldOrDatumDef:r,axis:n,channel:e,model:t,scaleType:c,orient:a,labelAngle:f,format:p,formatType:d,mark:s,config:o};for(const k of Vf){const A=k in uc?uc[k](g):Ia(k)?n[k]:void 0,F=A!==void 0,P=dS(A,k,n,t,e);if(F&&P)i.set(k,A,P);else{const{configValue:B=void 0,configFrom:X=void 0}=Ia(k)&&k!=="values"?gs(k,o.style,n.style,u):{},me=B!==void 0;F&&!me?i.set(k,A,P):(X!=="vgAxisConfig"||pS.has(k)&&me||gi(B)||C(B))&&i.set(k,B,!1)}}const h=n.encoding??{},m=Vu.reduce((k,A)=>{if(!i.hasAxisPart(A))return k;const F=xf(h[A]??{},t),P=A==="labels"?oS(t,e,F):F;return P!==void 0&&!W(P)&&(k[A]={update:P}),k},{});return W(m)||i.set("encode",m,!!n.encoding||n.labelAngle!==void 0),i}function hS({encoding:e,size:t}){for(const n of wt){const i=Se(n);et(t[i])&&Ft(e[n])&&(delete t[i],w(ru(i)))}return t}const mS={vgMark:"arc",encodeEntry:e=>({...Oe(e,{align:"ignore",baseline:"ignore",color:"include",size:"ignore",orient:"ignore",theta:"ignore"}),...pe("x",e,{defaultPos:"mid"}),...pe("y",e,{defaultPos:"mid"}),...yt(e,"radius"),...yt(e,"theta")})},yS={vgMark:"area",encodeEntry:e=>({...Oe(e,{align:"ignore",baseline:"ignore",color:"include",orient:"include",size:"ignore",theta:"ignore"}),...Wi("x",e,{defaultPos:"zeroOrMin",defaultPos2:"zeroOrMin",range:e.markDef.orient==="horizontal"}),...Wi("y",e,{defaultPos:"zeroOrMin",defaultPos2:"zeroOrMin",range:e.markDef.orient==="vertical"}),...Oo(e)})},xS={vgMark:"rect",encodeEntry:e=>({...Oe(e,{align:"ignore",baseline:"ignore",color:"include",orient:"ignore",size:"ignore",theta:"ignore"}),...yt(e,"x"),...yt(e,"y")})},bS={vgMark:"shape",encodeEntry:e=>({...Oe(e,{align:"ignore",baseline:"ignore",color:"include",size:"ignore",orient:"ignore",theta:"ignore"})}),postEncodingTransform:e=>{const{encoding:t}=e,n=t.shape;return[{type:"geoshape",projection:e.projectionName(),...n&&v(n)&&n.type===Mn?{field:E(n,{expr:"datum"})}:{}}]}},SS={vgMark:"image",encodeEntry:e=>({...Oe(e,{align:"ignore",baseline:"ignore",color:"ignore",orient:"ignore",size:"ignore",theta:"ignore"}),...yt(e,"x"),...yt(e,"y"),...Fo(e,"url")})},$S={vgMark:"line",encodeEntry:e=>({...Oe(e,{align:"ignore",baseline:"ignore",color:"include",size:"ignore",orient:"ignore",theta:"ignore"}),...pe("x",e,{defaultPos:"mid"}),...pe("y",e,{defaultPos:"mid"}),...fe("size",e,{vgChannel:"strokeWidth"}),...Oo(e)})},vS={vgMark:"trail",encodeEntry:e=>({...Oe(e,{align:"ignore",baseline:"ignore",color:"include",size:"include",orient:"ignore",theta:"ignore"}),...pe("x",e,{defaultPos:"mid"}),...pe("y",e,{defaultPos:"mid"}),...fe("size",e),...Oo(e)})};function Go(e,t){const{config:n}=e;return{...Oe(e,{align:"ignore",baseline:"ignore",color:"include",size:"include",orient:"ignore",theta:"ignore"}),...pe("x",e,{defaultPos:"mid"}),...pe("y",e,{defaultPos:"mid"}),...fe("size",e),...fe("angle",e),...wS(e,n,t)}}function wS(e,t,n){return n?{shape:{value:n}}:fe("shape",e)}const ES={vgMark:"symbol",encodeEntry:e=>Go(e)},kS={vgMark:"symbol",encodeEntry:e=>Go(e,"circle")},_S={vgMark:"symbol",encodeEntry:e=>Go(e,"square")},CS={vgMark:"rect",encodeEntry:e=>({...Oe(e,{align:"ignore",baseline:"ignore",color:"include",orient:"ignore",size:"ignore",theta:"ignore"}),...yt(e,"x"),...yt(e,"y")})},FS={vgMark:"rule",encodeEntry:e=>{const{markDef:t}=e,n=t.orient;return!e.encoding.x&&!e.encoding.y&&!e.encoding.latitude&&!e.encoding.longitude?{}:{...Oe(e,{align:"ignore",baseline:"ignore",color:"include",orient:"ignore",size:"ignore",theta:"ignore"}),...Wi("x",e,{defaultPos:n==="horizontal"?"zeroOrMax":"mid",defaultPos2:"zeroOrMin",range:n!=="vertical"}),...Wi("y",e,{defaultPos:n==="vertical"?"zeroOrMax":"mid",defaultPos2:"zeroOrMin",range:n!=="horizontal"}),...fe("size",e,{vgChannel:"strokeWidth"})}}},NS={vgMark:"text",encodeEntry:e=>{const{config:t,encoding:n}=e;return{...Oe(e,{align:"include",baseline:"include",color:"include",size:"ignore",orient:"ignore",theta:"include"}),...pe("x",e,{defaultPos:"mid"}),...pe("y",e,{defaultPos:"mid"}),...Fo(e),...fe("size",e,{vgChannel:"fontSize"}),...fe("angle",e),...sc("align",TS(e.markDef,n,t)),...sc("baseline",OS(e.markDef,n,t)),...pe("radius",e,{defaultPos:null}),...pe("theta",e,{defaultPos:null})}}};function TS(e,t,n){if(M("align",e,n)===void 0)return"center"}function OS(e,t,n){if(M("baseline",e,n)===void 0)return"middle"}const AS={vgMark:"rect",encodeEntry:e=>{const{config:t,markDef:n}=e,i=n.orient,r=i==="horizontal"?"x":"y",s=i==="horizontal"?"y":"x",o=i==="horizontal"?"height":"width";return{...Oe(e,{align:"ignore",baseline:"ignore",color:"include",orient:"ignore",size:"ignore",theta:"ignore"}),...yt(e,r),...pe(s,e,{defaultPos:"mid",vgChannel:s==="y"?"yc":"xc"}),[o]:q(M("thickness",n,t))}}},Fi={arc:mS,area:yS,bar:xS,circle:kS,geoshape:bS,image:SS,line:$S,point:ES,rect:CS,rule:FS,square:_S,text:NS,tick:AS,trail:vS};function PS(e){if(z([ar,sr,jg],e.mark)){const t=el(e.mark,e.encoding);if(t.length>0)return RS(e,t)}else if(e.mark===or){const t=Zr.some(n=>M(n,e.markDef,e.config));if(e.stack&&!e.fieldDef("size")&&t)return zS(e)}return Vo(e)}const Ec="faceted_path_";function RS(e,t){return[{name:e.getName("pathgroup"),type:"group",from:{facet:{name:Ec+e.requestDataName(Q.Main),data:e.requestDataName(Q.Main),groupby:t}},encode:{update:{width:{field:{group:"width"}},height:{field:{group:"height"}}}},marks:Vo(e,{fromPrefix:Ec})}]}const kc="stack_group_";function zS(e){var u;const[t]=Vo(e,{fromPrefix:kc}),n=e.scaleName(e.stack.fieldChannel),i=(l={})=>e.vgField(e.stack.fieldChannel,l),r=(l,f)=>{const d=[i({prefix:"min",suffix:"start",expr:f}),i({prefix:"max",suffix:"start",expr:f}),i({prefix:"min",suffix:"end",expr:f}),i({prefix:"max",suffix:"end",expr:f})];return`${l}(${d.map(p=>`scale('${n}',${p})`).join(",")})`};let s,o;e.stack.fieldChannel==="x"?(s={...Yn(t.encode.update,["y","yc","y2","height",...Zr]),x:{signal:r("min","datum")},x2:{signal:r("max","datum")},clip:{value:!0}},o={x:{field:{group:"x"},mult:-1},height:{field:{group:"height"}}},t.encode.update={...Fe(t.encode.update,["y","yc","y2"]),height:{field:{group:"height"}}}):(s={...Yn(t.encode.update,["x","xc","x2","width"]),y:{signal:r("min","datum")},y2:{signal:r("max","datum")},clip:{value:!0}},o={y:{field:{group:"y"},mult:-1},width:{field:{group:"width"}}},t.encode.update={...Fe(t.encode.update,["x","xc","x2"]),width:{field:{group:"width"}}});for(const l of Zr){const f=Ze(l,e.markDef,e.config);t.encode.update[l]?(s[l]=t.encode.update[l],delete t.encode.update[l]):f&&(s[l]=q(f)),f&&(t.encode.update[l]={value:0})}const a=[];if(((u=e.stack.groupbyChannels)==null?void 0:u.length)>0)for(const l of e.stack.groupbyChannels){const f=e.fieldDef(l),d=E(f);d&&a.push(d),(f!=null&&f.bin||f!=null&&f.timeUnit)&&a.push(E(f,{binSuffix:"end"}))}return s=["stroke","strokeWidth","strokeJoin","strokeCap","strokeDash","strokeDashOffset","strokeMiterLimit","strokeOpacity"].reduce((l,f)=>{if(t.encode.update[f])return{...l,[f]:t.encode.update[f]};{const d=Ze(f,e.markDef,e.config);return d!==void 0?{...l,[f]:q(d)}:l}},s),s.stroke&&(s.strokeForeground={value:!0},s.strokeOffset={value:0}),[{type:"group",from:{facet:{data:e.requestDataName(Q.Main),name:kc+e.requestDataName(Q.Main),groupby:a,aggregate:{fields:[i({suffix:"start"}),i({suffix:"start"}),i({suffix:"end"}),i({suffix:"end"})],ops:["min","max","min","max"]}}},encode:{update:s},marks:[{type:"group",encode:{update:o},marks:[t]}]}]}function IS(e){const{encoding:t,stack:n,mark:i,markDef:r,config:s}=e,o=t.order;if(!(!_(o)&&Me(o)&&ga(o.value)||!o&&ga(M("order",r,s)))){if((_(o)||v(o))&&!n)return Kc(o,{expr:"datum"});if(Ut(i)){const a=r.orient==="horizontal"?"y":"x",c=t[a];if(v(c))return{field:a}}}}function Vo(e,t={fromPrefix:""}){var p;const{mark:n,markDef:i,encoding:r,config:s}=e,o=te(i.clip,LS(e),MS(e)),a=Xc(i),c=r.key,u=IS(e),l=DS(e);l&&Object.values(e.component.selection).some(g=>g.type==="point"&&!g.bind&&g.on!=="pointerover")&&((p=e.markDef).cursor??(p.cursor="pointer"));const f=M("aria",i,s),d=Fi[n].postEncodingTransform?Fi[n].postEncodingTransform(e):null;return[{name:e.getName("marks"),type:Fi[n].vgMark,...o?{clip:o}:{},...a?{style:a}:{},...c?{key:c.field}:{},...u?{sort:u}:{},...l||{},...f===!1?{aria:f}:{},from:{data:t.fromPrefix+e.requestDataName(Q.Main)},encode:{update:Fi[n].encodeEntry(e)},...d?{transform:d}:{}}]}function LS(e){const t=e.getScaleComponent("x"),n=e.getScaleComponent("y");return t!=null&&t.get("selectionExtent")||n!=null&&n.get("selectionExtent")?!0:void 0}function MS(e){const t=e.component.projection;return t&&!t.isFit?!0:void 0}function DS(e){if(!e.component.selection)return null;const t=b(e.component.selection).length;let n=t,i=e.parent;for(;i&&n===0;)n=b(i.component.selection).length,i=i.parent;return n?{interactive:t>0||e.mark==="geoshape"||!!e.encoding.tooltip||!!e.markDef.tooltip}:null}class Xf extends Wf{constructor(n,i,r,s={},o){super(n,"unit",i,r,o,void 0,Ma(n)?n.view:void 0);x(this,"markDef");x(this,"encoding");x(this,"specifiedScales",{});x(this,"stack");x(this,"specifiedAxes",{});x(this,"specifiedLegends",{});x(this,"specifiedProjection",{});x(this,"selection",[]);x(this,"children",[]);x(this,"correctDataNames",n=>{var i,r,s;return(i=n.from)!=null&&i.data&&(n.from.data=this.lookupDataSource(n.from.data),"time"in this.encoding&&(n.from.data=n.from.data+zl)),(s=(r=n.from)==null?void 0:r.facet)!=null&&s.data&&(n.from.facet.data=this.lookupDataSource(n.from.facet.data)),n});const a=Je(n.mark)?{...n.mark}:{type:n.mark},c=a.type;a.filled===void 0&&(a.filled=vm(a,o,{graticule:n.data&&_o(n.data)}));const u=this.encoding=_h(n.encoding||{},c,a.filled,o);this.markDef=$l(a,u,o),this.size=hS({encoding:u,size:Ma(n)?{...s,...n.width!==void 0?{width:n.width}:{},...n.height!==void 0?{height:n.height}:{}}:s}),this.stack=Sl(this.markDef,u),this.specifiedScales=this.initScales(c,u),this.specifiedAxes=this.initAxes(u),this.specifiedLegends=this.initLegends(u),this.specifiedProjection=n.projection,this.selection=(n.params??[]).filter(l=>$o(l)),this.alignStackOrderWithColorDomain()}get hasProjection(){const{encoding:n}=this,i=this.mark===_u,r=n&&xd.some(s=>O(n[s]));return i||r}scaleDomain(n){const i=this.specifiedScales[n];return i?i.domain:void 0}axis(n){return this.specifiedAxes[n]}legend(n){return this.specifiedLegends[n]}initScales(n,i){return zs.reduce((r,s)=>{const o=ne(i[s]);return o&&(r[s]=this.initScale(o.scale??{})),r},{})}initScale(n){const{domain:i,range:r}=n,s=ue(n);return _(i)&&(s.domain=i.map(Ee)),_(r)&&(s.range=r.map(Ee)),s}initAxes(n){return wt.reduce((i,r)=>{const s=n[r];if(O(s)||r===V&&O(n.x2)||r===ae&&O(n.y2)){const o=O(s)?s.axis:void 0;i[r]=o&&this.initAxis({...o})}return i},{})}initAxis(n){const i=b(n),r={};for(const s of i){const o=n[s];r[s]=gi(o)?Vc(o):Ee(o)}return r}initLegends(n){return Nd.reduce((i,r)=>{const s=ne(n[r]);if(s&&Od(r)){const o=s.legend;i[r]=o&&ue(o)}return i},{})}alignStackOrderWithColorDomain(){var m;const{color:n,fill:i,order:r,xOffset:s,yOffset:o}=this.encoding,a=i||n,c=v(a)?a:void 0,u=c==null?void 0:c.field,l=c==null?void 0:c.scale,f=c==null?void 0:c.type,d=l==null?void 0:l.domain,p=s||o,g=v(p)?p:void 0,h=`_${u}_sort_index`;if(!r&&Array.isArray(d)&&typeof u=="string"&&f==="nominal")if(g&&!g.sort)g.sort=d;else{if(!this.stack)return;const y=`indexof(${R(d)}, datum['${u}'])`,S=((m=this.markDef)==null?void 0:m.orient)==="horizontal"?"ascending":"descending";this.transforms.push({calculate:y,as:h}),this.encoding.order={field:h,type:"quantitative",sort:S}}}parseData(){this.component.data=Rr(this)}parseLayoutSize(){Zb(this)}parseSelections(){this.component.selection=Wy(this,this.selection)}parseMarkGroup(){this.component.mark=PS(this)}parseAxesAndHeaders(){this.component.axes=aS(this)}assembleSelectionTopLevelSignals(n){return my(this,n)}assembleSignals(){return[...uf(this),...gy(this,[])]}assembleSelectionData(n){return yy(this,n)}assembleLayout(){return null}assembleLayoutSignals(){return zo(this)}assembleMarks(){let n=this.component.mark??[];return(!this.parent||!Wn(this.parent))&&(n=Dl(this,n)),n.map(this.correctDataNames)}assembleGroupStyle(){const{style:n}=this.view||{};return n!==void 0?n:this.encoding.x||this.encoding.y?"cell":"view"}getMapping(){return this.encoding}get mark(){return this.markDef.type}channelHasField(n){return Ht(this.encoding,n)}fieldDef(n){const i=this.encoding[n];return De(i)}typedFieldDef(n){const i=this.fieldDef(n);return ge(i)?i:null}}class Xo extends Wo{constructor(n,i,r,s,o){super(n,"layer",i,r,o,n.resolve,n.view);x(this,"children");const a={...s,...n.width?{width:n.width}:{},...n.height?{height:n.height}:{}};this.children=n.layer.map((c,u)=>{if(yr(c))return new Xo(c,this,this.getName(`layer_${u}`),a,o);if(Et(c))return new Xf(c,this,this.getName(`layer_${u}`),a,o);throw new Error(Ls(c))})}parseData(){this.component.data=Rr(this);for(const n of this.children)n.parseData()}parseLayoutSize(){Kb(this)}parseSelections(){this.component.selection={};for(const n of this.children){n.parseSelections();for(const i of b(n.component.selection))this.component.selection[i]=n.component.selection[i]}ie(this.component.selection).some(n=>Ke(n))&&js(Ds)}parseMarkGroup(){for(const n of this.children)n.parseMarkGroup()}parseAxesAndHeaders(){uS(this)}assembleSelectionTopLevelSignals(n){return this.children.reduce((i,r)=>r.assembleSelectionTopLevelSignals(i),n)}assembleSignals(){return this.children.reduce((n,i)=>n.concat(i.assembleSignals()),uf(this))}assembleLayoutSignals(){return this.children.reduce((n,i)=>n.concat(i.assembleLayoutSignals()),zo(this))}assembleSelectionData(n){return this.children.reduce((i,r)=>r.assembleSelectionData(i),n)}assembleGroupStyle(){const n=new Set;for(const r of this.children)for(const s of J(r.assembleGroupStyle()))n.add(s);const i=Array.from(n);return i.length>1?i:i.length===1?i[0]:void 0}assembleTitle(){let n=super.assembleTitle();if(n)return n;for(const i of this.children)if(n=i.assembleTitle(),n)return n}assembleLayout(){return null}assembleMarks(){return xy(this,this.children.flatMap(n=>n.assembleMarks()))}assembleLegends(){return this.children.reduce((n,i)=>n.concat(i.assembleLegends()),_f(this))}}function Yo(e,t,n,i,r){if(lr(e))return new Xn(e,t,n,r);if(yr(e))return new Xo(e,t,n,i,r);if(Et(e))return new Xf(e,t,n,i,r);if(Kh(e))return new iS(e,t,n,r);throw new Error(Ls(e))}function F$(e,t={}){t.logger&&eg(t.logger),t.fieldTitle&&Hu(t.fieldTitle);try{const n=bl(Cc(t.config,e.config)),i=Zm(e,n),r=Yo(i,null,"",void 0,n);return r.parse(),lb(r.component.data,r),{spec:US(r,jS(e,i.autosize,n,r),e.datasets,e.usermeta),normalized:i}}finally{t.logger&&tg(),t.fieldTitle&&yh()}}function jS(e,t,n,i){const r=i.component.layoutSize.get("width"),s=i.component.layoutSize.get("height");if(t===void 0?(t={type:"pad"},i.hasAxisOrientSignalRef()&&(t.resize=!0)):T(t)&&(t={type:t}),r&&s&&ry(t.type)){if(r==="step"&&s==="step")w(va()),t.type="pad";else if(r==="step"||s==="step"){const o=r==="step"?"width":"height";w(va(Ji(o)));const a=o==="width"?"height":"width";t.type=sy(a)}}return{...b(t).length===1&&t.type?t.type==="pad"?{}:{autosize:t.type}:{autosize:t},...Ka(n,!1),...Ka(e,!0)}}function US(e,t,n={},i){const r=e.config?lm(e.config):void 0,s=Gb(e.component.data,n),o=e.assembleSelectionData(s),a=e.assembleProjections(),c=e.assembleTitle(),u=e.assembleGroupStyle(),l=e.assembleGroupEncodeEntry(!0);let f=e.assembleLayoutSignals();f=f.filter(g=>(g.name==="width"||g.name==="height")&&g.value!==void 0?(t[g.name]=+g.value,!1):!0);const{params:d,...p}=t;return{$schema:"https://vega.github.io/schema/vega/v6.json",...e.description?{description:e.description}:{},...p,...c?{title:c}:{},...u?{style:u}:{},...l?{encode:{update:l}}:{},data:o,...a.length>0?{projections:a}:{},...e.assembleGroup([...f,...e.assembleSelectionTopLevelSignals([]),...hl(d)]),...r?{config:r}:{},...i?{usermeta:i}:{}}}const N$=od.version;export{Qn as accessPathDepth,Oc as accessPathWithDatum,U as accessWithDatumToUnescapedPath,F$ as compile,z as contains,_e as deepEqual,Qr as deleteNestedProperty,N as duplicate,Vt as entries,Fc as every,Tc as fieldIntersection,fd as flatAccessWithDatum,te as getFirstDefined,Nc as hasIntersection,$ as hasProperty,I as hash,hd as internalField,Ai as isBoolean,W as isEmpty,qS as isEqual,md as isInternalField,ga as isNullOrFalse,Cs as isNumeric,b as keys,Ti as logicalExpr,cd as mergeDeep,ad as never,Zm as normalize,Pi as normalizeAngle,Fe as omit,Yn as pick,ha as prefixGenerator,ii as removePathFromField,vn as replaceAll,Ie as replacePathInField,GS as resetIdCounter,ld as setEqual,Kn as some,D as stringify,Vi as titleCase,dd as unescapeSingleQuoteAndPathDot,ut as unique,gd as uniqueId,ie as vals,K as varName,N$ as version};
//# sourceMappingURL=cna0eDZd.js.map
